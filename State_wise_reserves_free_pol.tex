\documentclass[12pt]{article}
\usepackage[pdfstartview=FitH,hidelinks]{hyperref}
\usepackage[british]{babel}
\usepackage{a4,graphicx}
\usepackage[a4paper, hmargin={2.05cm, 2.05cm}]{geometry} 
\usepackage{amsmath,amssymb,amsthm,mathtools}
\usepackage{anyfontsize}
\usepackage{bbm}
%\usepackage{xypic}
\usepackage[latin1,utf8]{inputenc}
\usepackage{marvosym}
\usepackage{etoolbox}
\usepackage{relsize}
\usepackage{needspace}
\usepackage{nameref}
\usepackage{dsfont}
%\usepackage{thmtools}
%\usepackage{ntheorem}
%\newtheorem{lho}{Sætning}
\usepackage{filecontents}
\usepackage{tikz}
\usetikzlibrary{arrows.meta,positioning,calc}
\usetikzlibrary{matrix}
\usepackage{empheq}

\newcommand*\widefbox[1]{\fbox{\hspace{2em}#1\hspace{2em}}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\B}{\mathcal{B}}
\newcommand{\F}{\mathcal{F}}
\newcommand{\E}{\text{E}}
\newcommand{\cov}{\text{cov}}
\newcommand{\indic}[1]{\mathds{1}_{ \{ #1 \} }}
\newcommand{\unv}[1]{\mathds{1}_{  #1  }}
\newcommand\ddfrac[2]{\frac{\displaystyle #1}{\displaystyle #2}}
\newcommand{\noin}{\noindent}
\newcommand{\Var}{\text{Var}}
\renewcommand{\P}{\text{P}}
\renewcommand{\baselinestretch}{1.25} 

\newcommand\independent{\protect\mathpalette{\protect\independenT}{\perp}}
\def\independenT#1#2{\mathrel{\rlap{$#1#2$}\mkern2mu{#1#2}}}
\font\tt=rm-lmtl10

\newtheoremstyle{my_thm}% name
  {12pt}%         Space above, empty = `usual value'
  {12pt}%         Space below
  {\itshape}% Body font
  {}%         Indent amount (empty = no indent, \parindent = para indent)
  {\bfseries}% Thm head font
  {.}%        Punctuation after thm head
  {\newline}% Space after thm head: \newline = linebreak
  {}%         Thm head spec
\theoremstyle{my_thm}
\newtheorem{thm}{Theorem}[section]
\newtheorem{lem}[thm]{Lemma}



\usepackage{caption}
\usepackage{listings,lstautogobble}
\usepackage{color}
\usepackage{float}
\usepackage{cprotect}
\usepackage[round, comma]{natbib}
\usepackage{csquotes}

\renewcommand{\mkbegdispquote}[2]{\itshape}

%\iffalse
\begin{filecontents*}{BIBS.bib}

@article{Djehiche,
issn = {01676687},
abstract = {We suggest a unified approach to claims reserving for life insurance policies with reserve-dependent payments driven by multi-state Markov chains. The associated prospective reserve is formulated as a recursive utility function using the framework of backward stochastic differential equations (BSDE). We show that the prospective reserve satisfies a nonlinear Thiele equation for Markovian BSDEs when the driver is a deterministic function of the reserve and the underlying Markov chain. Aggregation of prospective reserves for large and homogeneous insurance portfolios is considered through mean-field approximations. We show that the corresponding prospective reserve satisfies a BSDE of mean-field type and derive the associated nonlinear Thiele equation. [web URL: http://www.sciencedirect.com/science/article/pii/S0167668715300548]},
journal = {Insurance, Mathematics and Economics},
volume = {69},
publisher = {Elsevier Sequoia S.A.},
year = {2016},
title = {Nonlinear reserving in life insurance: Aggregation and mean-field approximation},
language = {eng},
address = {Amsterdam},
author = {Djehiche, Boualem and Löfdahl, Björn},
keywords = {Studies ; Life Insurance ; Insurance Claims ; Insurance Policies ; Differential Equations ; Stochastic Models ; Life and Health Insurance ; Experiment/Theoretical Treatment},
url = {http://search.proquest.com/docview/1806433652/},
}

@article{Norberg,
journal = {Scand. Actuar. J. 1},
year = {1991},
title = {Reserves in Life and Pension Insurance},
author = {Norberg, Ragnar},
pages={3-24}}

@book{Pardoux,
series = {Stochastic Modelling and Applied Probability},
volume = {69},
publisher = {Springer International Publishing},
isbn = {9783319057132},
year = {2014},
title = {Stochastic Differential Equations, Backward SDEs, Partial Differential Equations},
edition = {2014},
language = {eng},
address = {Cham},
author = {Pardoux, Etienne and Rascanu, Aurel},
keywords = {Mathematics ; Probability Theory and Stochastic Processes ; Partial Differential Equations ; Mathematics},
}

@article{THM_BUC,
issn = {22279091},
abstract = {The problem of the valuation of life insurance payments with policyholder behavior is studied. First, a simple survival model is considered, and it is shown how cash flows without policyholder behavior can be modified to include surrender and free policy behavior by calculation of simple integrals. In the second part, a more general disability model with recovery is studied. Here, cash flows are determined by solving a modified Kolmogorov forward differential equation. We conclude the paper with numerical examples illustrating the methods proposed and the impact of policyholder behavior.},
journal = {Risks},
pages = {290--317},
volume = {3},
publisher = {MDPI AG},
number = {3},
year = {2015},
title = {Life Insurance Cash Flows with Policyholder Behavior},
language = {eng},
address = {Basel},
author = {Buchardt, Kristian and Møller, Thomas},
keywords = {Denmark ; Studies ; Life Insurance ; Cash Flow ; Consumer Behavior ; Differential Equations ; Experimental/Theoretical ; Life & Health Insurance ; Market Research ; Western Europe},
url = {http://search.proquest.com/docview/1721901184/},
}



@book{Liv2,
series = {International Series on Actuarial Science},
publisher = {Cambridge University Press},
isbn = {0521868777},
year = {2007},
title = {Market-valuation methods in life and pension insurance},
language = {eng},
address = {Cambridge},
author = {Møller, Thomas and Steffensen, Mogens},
keywords = {Insurance - Mathematics; Insurance, Life - Policies - Mathematics; Insurance, Pension trust guaranty - Mathematics; Life insurance policies - Mathematics; Pension trust guaranty insurance - Mathematics; Pension trusts - Mathematics; Økonomi, forsikring},
}

@article{Steffensen0,
issn = {01676687},
abstract = {The multi-state life insurance contract is reconsidered in a framework of securitization where insurance claims may be priced by the principle of no arbitrage. This way a generalized version of Thiele's differential equation is obtained for insurance contracts linked to indices, possibly marketed securities. The equation is exemplified by a traditional policy, a simple unit-linked policy and a half-dependent unit-linked policy.},
journal = {Insurance, Mathematics and Economics},
pages = {201--214},
volume = {27},
publisher = {Elsevier Sequoia S.A.},
number = {2},
year = {2000},
title = {A no arbitrage approach to Thiele's differential equation},
language = {eng},
address = {Amsterdam},
author = {Steffensen, Mogens},
keywords = {Arbitrage ; Securitization ; Market Prices ; Insurance Policies ; Stochastic Models ; Economic Theory ; Studies ; Economic Theory ; Insurance Industry ; Experimental/Theoretical},
url = {http://search.proquest.com/docview/208166412/},
}

@book{Steffensen1,
publisher = {Laboratory of Actuarial Mathematics, University of Copenhagen},
isbn = {8778344492},
year = {2001},
title = {On valuation and control in life and pension insurance},
language = {eng},
address = {Copenhagen},
author = {Steffensen, Mogens},
}



@article{NorbergB,
issn = {0949-2984},
abstract = {The issue of bonus in life insurance is considered in a model framework where the traditional set-up is extended by letting the experience basis (mortality, interest, etc.) be stochastic. A novel definition of the technical surplus on an insurance contract is proposed, and basic principles for its repayment as bonus are discussed. Making the experience basis an endogenous part of the model opens possibilities of model-based prognostication of future bonuses. Numerical illustrations are provided.},
journal = {Finance and Stochastics},
pages = {373--390},
volume = {3},
publisher = {Springer-Verlag},
number = {4},
year = {1999},
title = {A theory of bonus in life insurance},
language = {eng},
address = {Berlin Heidelberg},
author = {Norberg, Ragnar},
keywords = {Key words: Safety margins, prospective reserves, retrospective reserves, stochastic interest, stochastic mortality, counting processes ; JEL Classification:G22, G23 ; Mathematics Subject Classification (1991):60J27, 62P05},
}


@article{Christiansen,
issn = {0167-6687},
journal = {Insurance Mathematics and Economics},
pages = {132--137},
volume = {57},
publisher = {ELSEVIER SCIENCE BV},
number = {1},
year = {2014},
title = {Reserve-dependent benefits and costs in life and health insurance contracts},
language = {English},
author = {Christiansen, MC and Denuit, MM and Dhaene, J},
keywords = {Insurance ; Contracts ; Cost-Benefit Analysis ; Economic Analysis ; Economics;},
}




\end{filecontents*}

%\fi



\begin{document}

\section{Introduction}
With-profit insurance contracts are to this day one of the most popular life insurance contracts. They arose as a natural way to distribute the systematic surplus that emerges due to the prudent assumptions on which the contract is made. In recent years, sensible questions accompanied by a lot of attention have been aimed at the surplus, to name a few; is it distributed fairly? how should it be invested? How is it affected by the financial market? To answer these questions we need to understand the dynamics of the surplus in a model of practical relevance. The study of surplus and the interplay it has with other elements of an insurance contract, is not new. \citet{NorbergB} introduces the notion of individual surplus as well as the mean portfolio surplus. In \citet{Steffensen0} and \citet{Steffensen1}, partial differential equations are used to describe the prospective second order reserve for various forms of bonus, when the surplus is invested in a Black-Scholes market. In this paper we pay little regard to the prospective reserve, and instead focus on the surplus and the retrospective second order reserve, also called the savings account. 
\\[12pt]
The expected future value of the savings account is of particular interest, as it embodies the accumulation of dividends as well as the use of these dividends to increase benefits or decrease premiums. Due to the retrospective nature of the savings account and surplus, we may also take other retrospective considerations into account. In the existing literature, very little attention is paid to a very significant retrospective element of the with-profit insurance contract: the human element.
\\[12pt]
Insurance companies are governed by humans, and the decisions they make have an influence on the portfolio of policies - in particular concerning surplus and dividends. In a with-profit insurance contract many quantities are fixed at initialisation of the policy, but the rate at which dividends are paid out is not. The insurance company has a certain degree of freedom when it comes to the distribution of surplus, and the actions that have an influence on the insurance contracts are the so-called Management Actions.
%As stated by CEIPOS\footnote{https://eiopa.europa.eu/CEIOPS-Archive/Documents/Advices/CEIOPS-L2-Final-Advice-TP-Assumptions-future-management-actions.pdf} \begin{displayquote} The actuarial and statistical methods used to calculate the best estimate should take account of the effect on these future cash-flows of potential future actions by the management of (re)insurance undertakings based upon current and credible information. \end{displayquote}
From a mathematical point of view, they pose a problem as they depend on the entire history of the portfolio of policies in a possibly non-linear fashion, making it difficult to calculate prospective reserves. If we want to take a glance into the crystal ball of liabilities, taking Future Management Actions (FMA's) into account, we need to embrace it's retrospective nature. In this paper, we do not incorporate FMA's to their full extent, but rather lay the retrospective groundwork on which models including FMA's can be built.
\\[12pt]
We derive a retrospective differential equation for the expected savings account and surplus, in a general model with affine dynamics. We devote special attention to a realistic model with affine dynamics, where dividends are used to increase future benefits. 




\subsection{Set-up}
We consider the classic multi-state life insurance set-up, comprised of a state process $Z$ denoting the state of the policy in a finite state space $\mathcal{J}=\{0,1,...,J\}$. We denote the filtration generated by $Z$  . The counting process $N^{k}$ defined by $N^{k}(t)=\# \{ s; Z(s-)= i, Z(s)=k, s \in (0,t] \}$ describes the number of transitions into state $k$.  The state process $Z$ is assumed to be a continuous time Markov chain, with transition probabilities denoted by
$$
p_{ij}(s,t)= \P(Z(t)=j|Z(s)=i)
$$
for $s\leq t$. The corresponding transition intensities are denoted by
$$
\mu_{ij}(t)=\lim_{h \searrow 0} p_{ij}(t,t+h)/h
$$
for $i \neq j$. The predictable process $ \indic{Z(t-)\neq k }\mu_{Z(t-)k}(t)$ is the intensity process for $N^{k}(t)$, i.e
$$
M^{k}(t):=N^k(t)-\int_0^t \indic{Z(s-)\neq k } \mu_{Z(s-)k}(s) ds,
$$
forms a martingale. The state process $Z$ encapsulates the biometric risks involved with the insurance contract. Apart from the biometric risk, there is a financial risk connected to with-profit insurance contracts through the return on investment of the surplus. We make assumptions regarding the financial risk, by specifying the expected return on investment, $r$. Together, the transition intensities and expected return on investment form the second order basis, which describes the best guess on future development of the insurance portfolio. We take this second order basis as exogenously given. Note that a Monte-Carlo method can be used as a proxy for evaluation under the second order basis; perform evaluation under $n$ simulated second order basis and take the mean. The Monte-Carlo approach for evaluation allows for great model flexibility, which is particularly appealing regarding the expected return on investment. 

While the second order basis forms the best guess on future developments of the relevant technical elements, it would be far too risky for an insurance company to use these assumptions when signing contracts. What if a cure for cancer is invented in 10 years, or if the stock market crashes? To allow for events that make it difficult to meet the obligations to the insured, a much less risky set of assumptions are used when guarantees are given. These prudent assumptions form the first order (technical) basis. Using the standard notation, a $"*"$ symbolises first-order basis elements. It is precisely due to the difference between the first order basis and the realised (third order) basis that a surplus emerges. We have no way of knowing what the future is going to bring, so we cannot know how the surplus is going to evolve. We can however make an estimate by using the second order basis as a stand-in for the third order basis.
\\
\textbf{Missing}
\begin{itemize}
\item Payment stream, B.
dynamics
$$
dB_i(t)=b_i^{Z(t)}(t) dt +\sum_{k \neq Z(t-)} b_i^{Z(t-)k}(t)dN^k(t).
$$
The deterministic payment functions $b_i^j(t)$ and $b_i^{jk}(t)$ specify payments during sojourns in state $j$ and on transition from state $j$ to state $k$, respectively. Even though single payments during sojourns in states pose no mathematical difficulty, we assume that payments during sojourns in states are continuous for notational simplicity.
\item Filtration for Z, $\mathcal{F}_t$
\item without loss of generality assume $Z(0)=0$
\item Consider single policy
\item Dynamics of reserve?
\item "+" denoting benefits and "-" denoting premiums.
\item The second order basis is assumed to form a predictable compensator for the actual dynamics.
\item The dynamics of the technical reserves are found using Itô's lemma for FV-functions to be
\begin{align}
dV_i^{Z(t)*}(t)=&r^*(t)V_i^{Z(t)*}(t)dt - b_i^{Z(t)}(t) -\sum_{k\neq Z(t-)}b_i^{Z(t-)k}(t) dN^k(t)\nonumber
\\
-&\sum_{k\neq Z(t-)} \rho_i^{Z(t-)k}(t) dt
+
\sum_{k\neq Z(t-)} R_i^{Z(t-)k}(t)(dN^k(t)-\mu_{Z(t-)k}(t) dt), \label{eq:AAP}
\end{align}
where $\rho_i^{jk}$ is the so-called risk premium for a transition from state $j$ to state $k$, and $R_i^{jk}$ is the so-called sum-at-risk for a transition from $j$ to $k$. The sum-at-risk $R_i^{jk}$ describes the required injection of capital on a transition from $j$ to $k$ in order to meet the future liabilities of the contract in state $k$, evaluated under the first-order basis. The sum-at-risk is given by
$$
R_i^{jk}(t)=b_i^{jk}(t)+V_i^{k*}(t)-V_i^{j*}(t).
$$
As the name suggests, the risk premium is the premium paid by the policyholder to cover the risk carried by the insurer that can not be diversified, such as medical advancements. Naturally the risk premium is the sum-at-risk multiplied by the difference in intensity for a transition from $j$ to $k$ between the first-order basis and the second-order basis, i.e
$$
\rho_i^{jk}(t)=R_i^{jk}(t)(\mu^*_{jk}(t)-\mu_{jk}(t)).
$$
\end{itemize}
\section*{Retrospective Reserve Without Bonus}
One of the main contributions of \citet{Norberg} is a definition of the retrospective reserve, as a conditional expected value of a past payments, in much the same manner as the prospective reserve is a conditional expected value of future payments. Formally \citet{Norberg} defines the retrospective first order reserve, as
\begin{align*}
V^*_\mathbb{E}(t)=&\E^* \left[ \int_0^t e^{\int_s^t r^*} dB(s) \big| \mathcal{E}_t \right] 
%\\
%=&
%\E^* \left[ \int_0^t e^{\int_s^t r*}  \left( \sum_{i \in \mathcal{J}} \indic{Z(s)=i} %b^i(s)ds+ \sum_{k \neq Z(s-)} b^{ik}(t) dN^k(s) \right) \big| \mathcal{E}_t \right]
\end{align*} 
for some family of sigmaalgrebras $\mathbb{E}=\{\mathcal{E}_t \}_{0\leq t}$, where $\mathcal{E}_t$ represents the information available at time $t$. It is for an actuary very natural to assume that $\mathcal{E}_t=\sigma\{ Z(s), 0 \leq s\leq t \}$, implying that all information about the past is accounted for. As noted by \citet{Norberg} the family of sigmaalgebras may be increasing, i.e $\mathcal{E}_s \subseteq \mathcal{E}_t$ for $s<t$, but it is not required. So with this very general definition of the retrospective reserve, we may discard information, for instance by defining $\mathcal{E}_t=\sigma \{Z(0), Z(t) \}$. But why should we ever choose to discard information that is available to us? Because it is intractable to use $\mathcal{E}_t=\mathcal{F}_t$ when we want to calculate the expected value of $V^*_\mathbb{E}(t)$ and $\{ Z(s) \}_{s\leq t}$ has not yet been realised. Computationally it is simply too demanding to take the expectation over $\mathcal{F}_t$ - all possible paths and all possible transition times have to be considered. Instead we therefore let $\mathcal{E}_t=\sigma \{Z(0), Z(t) \}$, implying that we only use the state at initialization and time $t$ to evaluate the retrospective reserve. Using this formulation of $\mathcal{E}_t$, the retrospective reserve can be interpreted as the average reserve of a group of policies that all start in $Z(0)$ and end in $Z(t)$. In order to actually calculate this retrospective reserve, we note by the markov property that
\begin{equation}
P(Z(s)=j| Z(0)=0, Z(t)=i )=\frac{p_{0j}(0,s)p_{ji}(0,t)}{p_{0i}(s,t)},
\label{eq:AAM}
\end{equation}
and that the predictable compensator for $N^{jk}(s)| (Z(0)=0, Z(t)=i )$ has intensity given by
\begin{equation}
\indic{Z(s-)=j}\mu_{jk|0i}(s|0,t)=\indic{Z(s-)=j}\mu_{jk}(s)\frac{p_{ki}(s,t)}{p_{ji}(s,t)}. \label{eq:AAN}
\end{equation}
Define
$$
V_i^*(t)= \E^* \left[ \int_0^t e^{\int_s^t r*} dB(s) \big|Z(0)=0, Z(t)=i \right],
$$
which by \eqref{eq:AAM} and \eqref{eq:AAN} is equal to
\begin{align}
V_i^*(t)=& \int_0^t e^{\int_s^t r*} \sum_{j \in \mathcal{J}} \frac{p_{0j}(0,s)p_{ji}(s,t)}{p_{0i}(0,t)} \left(  b^{j}(s) + \sum_{k \neq j}  \mu_{jk}(s) b^{jk}(s)\frac{p_{ki}(s,t)}{p_{ji}(s,t)} \right) ds
%\\ =& \frac{1}{p_{0i}(0,t)}\int_0^t e^{\int_s^t r*} \sum_{j \in \mathcal{J}} p_{0j}(0,s)p_{ji}(s,t) \left(  b^{j}(s) + \sum_{k \neq j}  \mu_{jk}(s)b^{jk}(s)\frac{p_{ki}(s,t)}{p_{ji}(s,t)} \right) ds
 \nonumber \\
=&
 \frac{1}{p_{0i}(0,t)}\int_0^t e^{\int_s^t r*} \sum_{j \in \mathcal{J}} p_{0j}(0,s) \left(p_{ji}(s,t)   b^{j}(s) + \sum_{k \neq j}  \mu_{jk}(s) b^{jk}(s) p_{ki}(s,t) \right) ds \label{eq:AAO}
\end{align}
as also derived by \citet{Norberg}. In itself \eqref{eq:AAO} provides an interpretation of the retrospective reserve; it is the accumulated payments on transition and sojourn payments at all times prior to $t$, weighted by the corresponding probability of transition between states and sojourns in states, given the initial and terminal state of the policy. For sufficiently nice intensities and payment functions, analytical solutions for $V_i^*(t)$ can be derived. In general, we cannot provide a closed form expression for $V_i^*(t)$, and instead we have to rely on numerical methods, for instance by a numerical solution to the differential equation solved by $V_i^*(t)$. As it is a nuisance to directly derive a differential equation for $V_i^*$, due to the division by the probability of entering state $i$ at time $t$, we define
\begin{align*}
\tilde{V}_i^*(t)= \E^* \left[ \indic{Z(t)=i} \int_0^t e^{\int_s^t r^*} dB(s) \big|Z(0)=0\right] = V_i^*(t)p_{0i}(0,t).
\end{align*}
Using the Kolmogorov differential equations, $p_{0i}(0,t)$ can be calculated for all $i$ and $t$, and thus $V_i^*(t)$ can easily be calculated once $\tilde{V}_i^*(t)$ is available. Differentiating $\tilde{V}_i^*(t)$ with respect to $t$ gives
\begin{align*}
\frac{d}{dt} \tilde{V}_i^*(t)=& \frac{d}{dt} 
\int_0^t e^{\int_s^t r^*} \sum_{j \in \mathcal{J}} p_{0j}(0,s) \left(p_{ji}(s,t)   b^{j}(s) + \sum_{k \neq j}  \mu_{jk}(s) b^{jk}(s) p_{ki}(s,t) \right) ds
\\
=&
\sum_{j \in \mathcal{J}} p_{0j}(0,t) \left( \indic{j=i}   b^{j}(t) + \sum_{k \neq j}  \mu_{jk}(t) b^{jk}(t) \indic{k=i}  \right) 
\\
&+
\int_0^t \frac{d}{dt} e^{\int_s^t r^*} \sum_{j \in \mathcal{J}} p_{0j}(0,s) \left(p_{ji}(s,t)   b^{j}(s) + \sum_{k \neq j}  \mu_{jk}(s) b^{jk}(s) p_{ki}(s,t) \right) ds
\\
=&
p_{0i}(0,t) b^{i}(t) + \sum_{j \neq i} p_{0j}(0,t) \mu_{ji}(t) b^{ji}(t) 
+
r^*(t)\tilde{V}_i^*(t)
\\
&+
\int_0^t e^{\int_s^t r^*} \sum_{j \in \mathcal{J}} p_{0j}(0,s) \left( \frac{d}{dt}p_{ji}(s,t)   b^{j}(s) + \sum_{k \neq j}  \mu_{jk}(s) b^{jk}(s) \frac{d}{dt} p_{ki}(s,t) \right) ds.
\end{align*}
The Kolmogorov forward differential equations state that
$$
\frac{d}{dt}p_{ji}(s,t)=\sum_{g \neq i} p_{jg}(s,t)\mu_{gi}(t) - \mu_{ig}(t)p_{ji}(s,t)
$$
which imply that
\begin{align*}
\frac{d}{dt}\tilde{V}_i^*(t)=&
p_{0i}(0,t) b^{i}(t) + \sum_{j \neq i} p_{0j}(0,t) \mu_{ji}(t) b^{ji}(t) 
+
r^*(t)\tilde{V}_i^*(t)
\\
&+
\sum_{g \neq i} \mu_{gi}(t) \int_0^t e^{\int_s^t r^*} \sum_{j \in \mathcal{J}} p_{0j}(0,s) p_{jg}(s,t)   b^{j}(s) ds
\\
&-
\sum_{g \neq i} \mu_{ig}(t) \int_0^t e^{\int_s^t r^*} \sum_{j \in \mathcal{J}} p_{0j}(0,s)  p_{ji}(s,t)   b^{j}(s)  ds
\\
&+
\sum_{g \neq j} \mu_{gi}(t) \int_0^t e^{\int_s^t r^*} \sum_{j \in \mathcal{J}} p_{0j}(0,s) \sum_{k \neq j}  \mu_{jk}(s) b^{jk}(s) p_{kg}(s,t) ds
\\
&-
\sum_{g \neq i} \mu_{ig}(t) \int_0^t e^{\int_s^t r^*} \sum_{j \in \mathcal{J}} p_{0j}(0,s) \sum_{k \neq j}  \mu_{jk}(s) b^{jk}(s)  p_{kj}(s,t) ds
\\
=&
p_{0i}(0,t) b^{i}(t) + \sum_{j \neq i} p_{0j}(0,t) \mu_{ji}(t) b^{ji}(t) 
+
r^*(t)\tilde{V}_i^*(t)
\\
&+
\sum_{g \neq i} \mu_{gi}(t) \underbrace{ \int_0^t e^{\int_s^t r^*} \sum_{j \in \mathcal{J}} p_{0j}(0,s) \left( p_{jg}(s,t)   b^{j}(s) \sum_{k \neq j}  \mu_{jk}(s) b^{jk}(s) p_{kg}(s,t)\right)  ds}_{\tilde{V}_g^*(t)}
\\
&-
\sum_{g \neq i} \mu_{ig}(t) \underbrace{\int_0^t e^{\int_s^t r^*} \sum_{j \in \mathcal{J}} p_{0j}(0,s) \left( p_{ji}(s,t)   b^{j}(s) \sum_{k \neq j}  \mu_{jk}(s) b^{jk}(s)  p_{ki}(s,t)\right) ds}_{\tilde{V}_i^*(t)}
\\
=&
p_{0i}(0,t) b^{i}(t) + \sum_{j \neq i} p_{0j}(0,t) \mu_{ji}(t) b^{ji}(t) 
+
r^*(t)\tilde{V}_i^*(t)
\\
&+
\sum_{g \neq i} \mu_{gi}(t) \tilde{V}_g^*(t)-\mu_{ig}(t) \tilde{V}_i^*(t),
\end{align*}
which is a differential equation that bears a close resemblance to the prospective Thiele differential equation. The retrospective probability weighted reserve $\tilde{V}_i^*(t)$ develops in accordance with the probability weighted payments, the first order interest, and a diffusion between the reserves. These differential equations are generalisations of the Kolmogorov forward differential equations, that emerge when the payment stream is defined by
$$
dB(t)=\indic{t=u}\indic{Z(t)=j},
$$
that has a payout of one unit at time $u$, if $Z(t)=j$. ... Allowed for payments that depend on the retrospective reserve itself, as it is deterministic.
\\
\citet{Norberg} defined the retrospective reserve, and derived some of its important properties. At the time, the retrospective reserve was perhaps more of a mathematical curiosity than an actuarial tool, as the prospective reserves at the time provided all the information you could ask for. However, the retrospective reserve definitely deserves recognition when surplus and dividends are introduced. \citet{NorbergB} defines the individual surplus as a retrospective reserve, and derives a differential equation hereof in a simple model where no dividends are allotted.
\\
With an understanding of the development of the retrospective reserve, we now expand our set-up to allow for realistic modelling of benefits and balances, by introducing the notion of surplus and dividends.



\subsubsection{Set-Up Including Surplus and Dividends}
In this section we expand our set-up such that we can accurately describe the benefits and balances in a model where surplus and dividends are included. The first order basis on which insurance contracts are signed, are a set of prudent assumptions regarding interest and transition intensities. Knowing that the assumptions are prudent, the insurer and insured agree that when surplus has emerged as a consequence of the realized interest and transition intensities, this surplus should be given back to the insured. The surplus is returned to the insured through a dividend payment stream. What the insured chooses to do with his dividend can vary, but a very standard product design is to use the dividends to buy more insurance. In a sense, the dividend payment stream becomes a premium for a bonus benefit payment stream. We introduce two payment streams $B_1$ and $B_2$ with dynamics
$$
dB_i(t)=b_i^{Z(t)}(t) dt +\sum_{k \neq Z(t-)} b_i^{Z(t-)k}(t)dN^k(t).
$$
The payments specified by $B_1$ are the benefits which are fixed, and part of the original contract. The payments of $B_2$ specify the profile of the benefit stream that the dividend is converted into. When the contract is signed, both $B_1$ and $B_2$ are agreed upon, and while there is practically no restriction on their design, we assume that $B_2$ contains benefits only, implying that dividends are used to increase benefits, and not to decrease premiums. The payment streams $B_1$ and $B_2$, have corresponding technical reserves given by
$$
V_i^{j*}(t)=\E \left[ \int_t^n e^{-\int_t^s r^*} dB_i(s) \big| Z(t)=j \right].
$$
We assume $V_2^{0*}(0)>0$. In order to keep track of how much dividend has been materialized into the $B_2$ payment stream, we introduce the process $Q(t)$ which denotes the quantity of $B_2$ payment stream purchased at time $t$. We do not yet specify the dynamics of $Q(t)$. The payment process experienced by the policyholder, $B$, consists of one unit $B_1$ payment stream and $Q$ units of $B_2$ payment stream, thus having dynamics
$$
dB(t)=dB_1(t)+ Q(t-)dB_2(t).
$$
Where the left-limit version of $Q$ is used in order to ensure that $B$ is adapted to $\mathcal{F}_t$. We now define the savings account as the technical value of future guaranteed payments, given a certain quantity of $B_2$ payment stream,
\begin{align*}
X(t)=&\E^*\left[ \int_t^n e^{\int_t^s r*} d\left( B_1(s) + Q(t) B_2(s) \right) \right]
\\
=&
V_1^{Z(t)*}(t)+Q(t)V_2^{Z(t)*}(t). 
\end{align*}
Noting that
$$
Q(t)=\frac{X(t)-V_1^{Z(t)*}(t)}{V_2^{Z(t)*}(t)}
$$
we see that the payment stream experienced by the policyholder has dynamics
\begin{align*}
dB(t)=&dB_1(t)+\frac{X(t-)-V_1^{Z(t-)*}(t-)}{V_2^{Z(t-)*}(t-)}dB_2(t)
\\
=&b^{Z(t)}(t,X(t)) dt +\sum_{k \neq Z(t-)} b^{Z(t-)k}(t,X(t-))dN^k(t),
\end{align*}
for deterministic functions $b^j$ and $b^{jk}$ corresponding to sojourn payments and payments on transition, given by
\begin{gather*}
b^j(t,x)=b_1^j(t)+\frac{x-V_1^{j*}(t)}{V_2^{j*}(t)}b_2^j(t)
\\
b^{jk}(t,x)=b_1^{jk}(t)+\frac{x-V_1^{j*}(t)}{V_2^{j*}(t)}b_2^{jk}(t).
\end{gather*}
By introducing subscripts, the dynamics of $V_1^{Z(t)*}$ and $V_2^{Z(t)*}$ are given by \eqref{eq:AAP}. Using integration by parts for FV-functions we find the dynamics of $X$ to be
\begin{align}
dX(t)=&
dV_1^{Z(t)*}(t)+Q(t-)dV_2^{Z(t)*}(t)+V_2^{Z(t)*}(t)dQ(t) \nonumber
\\
=&
r^*(t)X(t)dt
 +V_2^{Z(t)*}(t) dQ(t)
 -b^{Z(t)}(t,X(t)) dt
- \sum_{k \neq Z(t-)} b^{Z(t-)k}(t,X(t-)) dN^k(t)
\nonumber \\
&- \sum_{k \neq Z(t-)} \rho^{Z(t-)k}(t,X(t-))dt
\nonumber \\
&+ \sum_{k \neq Z(t-)}  R^{Z(t-)k}(t,X(t-)) (dN^k(t)-\mu_{Z(t-)k}(t)dt),\label{eq:AAB}
\end{align}
where
\begin{align*}
\rho^{jk}(t,X(t-))=&\rho_1^{jk}(t)+Q(t-)\rho_2^{jk}(t)=\rho_1^{jk}(t)+\frac{X(t-)-V_1^{j*}(t-)}{V_2^{j*}(t-)}\rho_2^{jk}(t),
\\
R^{jk}(t,X(t-))=&R_1^{jk}(t)+Q(t-)R_2^{jk}(t)=R_1^{jk}(t)+\frac{X(t-)-V_1^{j*}(t-)}{V_2^{j*}(t-)}R_2^{jk}(t),
\end{align*}
respectively can be interpreted as the risk premium and sum-at-risk for the savings account. The savings account plays a crucial role in the understanding of the with-profit insurance contract, just as the first order reserve plays a crucial role in the model without dividends. Given the savings account, we can readily define the surplus as
$$
Y(t)= - \int_0^t e^{\int_s^t r} dB(s)-X(t),
$$
corresponding to the accumulated premiums less benefits excess over the savings account. It is clear from the definition of the surplus that the savings account has an influence on $Y$, but the surplus also has an influence on the savings account though the dividends. The dividends flow from the surplus to the savings account, according to some dividend strategy determined by the insurer. These dividends are instantaneously used to increase benefits, by buying more of the $B_2$ payment stream. These additional benefits are, like the fixed benefits, priced under the first order basis, which means that one unit of $B_2$ has a value of $V_2^{Z(t)*}(t)$. The total amount of accrued dividends at time $t$ are denoted by $D(t)$, and as the dividends are used to buy $B_2$, we must have that
\begin{align}
dD(t)=V_2^{Z(t)*}(t)dQ(t). \label{eq:AAQ}
\end{align}
By the principle of equivalence
\begin{gather*}
0=X(0)=V_1^{0*}(0)+Q(0-)V_2^{0*}(0)
\\
\Leftrightarrow
\\
Q(0-)=-\frac{V_1^{0*}(0)}{V_2^{0*}(0)}
\end{gather*}
providing us with the initial condition for $Q$, which along with \eqref{eq:AAQ} fully specifies $Q$. Note that the principle of equivalence puts no restrictions on the form of $B_1$ and $B_2$.
\\[12pt]
We assume the dynamics of the dividend process is given by
$$
dD(t)=\delta^{Z(t)}(t,X(t),Y(t)) dt,
$$
for some deterministic function $\delta^j$ on the form
\begin{equation*}
\delta^j(t,x,y)=\delta_1^j(t)+\delta_2^j(t)x+\delta_3^j(t)y.
\end{equation*}
In this paper, the form of $\delta$ is probably the assumption most eligible for criticism. In practice, the dividend is determined by an actuary who takes much more information into account than simply the value of the savings and surplus. Furthermore the dividend-deciding actuary is most likely going to take past development of the savings and surplus into account. The specification of the dynamics of $D$ is at the heart of what a future management action is, and, as stated earlier, we do not fully incorporate these FMA's in all their generality and glory, but suffice with crude surrogates. Some of these crude surrogates can actually perform a decent job at describing real world dividend strategies, for instance by defining the dividend as some linear function of the contribution.






%Using Itô's lemma for FV-functions and integration by parts for FV-functions, we find the dynamics of $X$ as
%\begin{align}
%dX(t)=&
%r^*(t)X(t)dt
% +\delta^{Z(t)}(t,X(t),Y(t))  dt
% -b^{Z(t)}(t,X(t)) dt
%- \sum_{k \neq Z(t-)} b^{Z(t-)k}(t,X(t-)) dN^k(t)
%\nonumber \\
%&+ \sum_{k \neq Z(t-)}  R^{Z(t-)k}(t,X(t-)) (dN^k(t)-\mu_{Z(t-)k}^*(t)dt)
%\nonumber \\
%=&
%r^*(t)X(t)dt
% +\delta^{Z(t)}(t,X(t),Y(t))  dt
% -b^{Z(t)}(t,X(t)) dt
%- \sum_{k \neq Z(t-)} b^{Z(t-)k}(t,X(t-)) dN^k(t)
%\nonumber \\
%&- \sum_{k \neq Z(t-)} \rho^{Z(t-)k}(t,X(t-))dt
%\nonumber \\
%&+ \sum_{k \neq Z(t-)}  R^{Z(t-)k}(t,X(t-)) (dN^k(t)-\mu_{Z(t-)k}(t)dt),\label{eq:AAB}
%\end{align}



%Note that the predictable compensator for $dN^k$ when $k\neq Z(t-)$ is $\mu_{Z(t-)k}(t)$, under the second order basis, while $\mu^*_{Z(t-)k}(t)$ is the predictable compensator under the first order basis.







\noin The dynamics of $Y$ can easily be derived to be
\begin{align}
dY(t)=&rY(t) dt + dC(t)-dD(t)-
\sum_{k \neq Z(t-)}  R^{Z(t-)k}(t,X(t-)) dM^k(t), \label{eq:AAC}
\end{align}
for 
\begin{gather*}
dC(t)=(r(t)-r^*(t))X(t)dt+\sum_{k\neq Z(t)} \rho^{Z(t)k}(t,X(t)) dt,
\end{gather*}
which we call the contribution process, as it represents the contributions from the savings account to the surplus. Note that the dynamics of $X$ and $Y$ are affine, and that for suitable $g$ and $h$ we can write \eqref{eq:AAB} and \eqref{eq:AAC} respectively as
\begin{align}
dX(t)=&X(t)g_{x1}(t,Z(t),Y(t))dt + \sum_{k \neq Z(t-)} X(t-) h_{x1}(t,Z(t-),k,Y(t-)) dN^k(t) \nonumber \\
&+g_{x2}(t,Z(t),Y(t))dt + \sum_{k \neq Z(t-)} h_{x2}(t,Z(t-),k,Y(t-)) dN^k(t),
\label{eq:AAD} \\
dY(t)=&Y(t)g_{y1}(t,Z(t),X(t))dt + \sum_{k \neq Z(t-)} Y(t-) h_{y1}(t,Z(t-),k,X(t-)) dN^k(t)
\nonumber \\
&+g_{y2}(t,Z(t),X(t))dt + \sum_{k \neq Z(t-)} h_{y2}(t,Z(t-),k,X(t-)) dN^k(t) \label{eq:AAE}.
\end{align}
We refer to section \ref{seq:Dyn} of the appendix for the specification of $g$ and $h$ leading to the dynamics given in \eqref{eq:AAB} and \eqref{eq:AAC}. Apart from notational ease, the use of arbitrary $g$ and $h$ functions serve to generalise the results of the paper to any FV-process with affine dynamics of the form given by \eqref{eq:AAD} and \eqref{eq:AAE}. Even though we work with the dynamics given by \eqref{eq:AAD} and \eqref{eq:AAE}, we think of the $g$ and $h$ functions as the ones required to achieve the dynamics of \eqref{eq:AAB} and \eqref{eq:AAC}. As we are interested in the interconnected dynamics of $X$ and $Y$, we introduce the two-dimensional process 
$$
W(s)= \begin{pmatrix}
X(s)\\
Y(s)
\end{pmatrix}.
$$
with dynamics given by
\begin{align*}
dW(s)=& g(s,Z(s),W(s)) ds+ \sum_{k\neq Z(s-)} h(s,Z(s-),k,W(s-)) dN^k(s),
\end{align*}
for $g$ and $h$ functions that are affine in $W$.
%In practice, the surplus account is shared among, say $N$, policyholders, implying that we need a system of $\# \{ \mathcal{J} \}^N+1$ differential equations; one for each combination of all policy states, and one for the common surplus. There are several ways to reduce the dimensionality of the problem, making it computationally tractable. However, 
\\[12pt]
It is important to realize the extent of applicable models that have affine dynamics, see \citet{Christiansen} for several relevant payment functions that are linear in the reserve, which corresponds to the savings when $D(t)=0$ for all $t$. While the reach of models with affine dynamics is extensive, there are limitations to consider. It is not uncommon to have dynamics that include some min or max function, for instance in the case of guarantees, and these non-linear functions in savings cannot be described by affine dynamics. \\
As stated in the introduction, management actions are one of the main motivators of this paper, but they are hidden in mainly two terms; the second order interest and the dividend. This is because the management decides how to invest the surplus, and how it should be distributed to the customers. Due to the very human and abstract nature of management actions, we do not incorporate them directly in the dynamics of the savings and surplus, but instead let them work in the shadows.


\iffalse
\subsection{Prospective vs. Retrospective}
The expected value of the prospective reserve is of monumental interest for insurance companies, and for good reason - they describe their liabilities. So why should we pay any concern to the savings account, that only pertains to the past? The past and future are connected through the principle of equivalence, stating that under the first order basis the expected premiums and benefits should be equal. However, under the first order basis, surplus only grows due to financial returns and not due to the difference between
The savings account stands on the verge between the surplus dependent past, and a future where no benefits are increased.


. So the savings account 

While it may seem obvious that the prospective reserve must depend solely on information available today, it may not be evident that the retrospective

When incorporating human decisions into the projection of balances and benefits in life insurance, we need to embrace the fact that these decisions are based on the past. The fact that the savings account is retrospective, in the sense that it is $\mathcal{F}_t$ measurable, is the manifestation of the retrospective nature of the FMA's. If one imagines a world where the FMA's are prospective, 

The definition and differential equation for the retrospective reserve without bonus, can be found in \citet{Norberg}. 

There is an important distinction between the savings account, and the market value of future guaranteed benefits. The savings account is $\mathcal{F}_{[0,t]}$-measurable whereas the market value of future guaranteed benefits is $\mathcal{F}_{[t,n]}$-measurable.

 Even though FMA's are one of the main reasons for considering retrospective quantities, they are not going to be evident in this paper, but are instead hidden from view under a veil of notation. 

\begin{itemize}
\item Something about Monte-carlo method
\item Something about FMA's - perhaps an example?
\item Deterministic second order basis, and discussion regarding simulation.
\end{itemize}


\fi
\subsection{One Active State}
We consider a simple model where the expected future savings are described by an easily derived differential equation. The model consists of $n$ inactive states where there are no payments, and one active state with continuous dynamics $g$ which, in this setting, may be non-linear. Denote by $0$ the active state. On transition to any one of the inactive states, the surplus and savings are nullified. We need not specify what happens to the surplus and savings on a transition - they may be paid out to the customer or the insurance company, or any combination of the two - the only important requirement is that they are zero in all inactive states. The eradication of surplus and savings on transition corresponds to the relation $h_x(t,0,j,x,y)+h_y(t,0,j,x,y)=-x-y$, for $j=1,...,n$. For notational ease, we assume that 
\begin{gather*}
h_x(t,0,j,x,y)=-x
\\
h_y(t,0,j,x,y)=-y,
\end{gather*}
for all $j$. The survival model with and without surrender options are special cases of this model.  The dynamics of $X$ and $Y$ are
\begin{align*}
dX(s)=& \indic{Z(s-)=0} g_x(s,0,X(s),Y(s))ds - \sum_{h=1}^n X(s-)dN^h(s)
\\
dY(s)=& \indic{Z(s-)=0} g_y(s,0,X(s),Y(s))ds - \sum_{h=1}^n Y(s-)dN^h(s).
\end{align*}
%Note that there are no risk premiums, as there is no risk for the insurance company company related to the transitions of the policy. Therefore, the only risk carried by the insurance company, relates to the interest of the savings account.
Let $W(s)=(X(s),Y(s))^T$, and denote by $T_1$ the time of the first jump. For the deterministic function $W_a$ that solves
$$
W_a(t)=\int_0^t g(s,0,W_a(s)) ds,
$$
we see that
$$
\hat{W}(t):=\E[W(t)|Z(0)=0] = \E [  \indic{t<T_1} W_a(t)|Z(0)=0]  = p_{00}(0,t) W_a(t),
$$
which comes at no surprise. In this case we know the past and present values of $W$ given the current state of $Z$, so the only stochastic element pertains to the state of the policy at time $t$. By differentiating w.r.t. $t$, and applying Kolmogorov's forward differential equation, we get the following forward differential equation for $\hat{W}$,
\begin{align*}
\hat{W}(0)=&\begin{pmatrix}
X(0)\\
Y(0)
\end{pmatrix},
\\
\frac{d}{dt}\hat{W}(t)=&p_{00}(0,t) g \left( s,0,\frac{\hat{W}(t)}{p_{00}(0,t)}\right)
-
\frac{\hat{W}(t)}{p_{00}(0,t)}\sum_{k=1}^n \mu_{0k}(t).
\end{align*}
Even though it may seem very simple and perhaps even trivial, the model with one active state has great applicability.
\subsubsection{Example With One Active State}
If the benefits are identical after age 65, the states 0,1,3 and 4 can be lumped, as well as 2,5 and 6, thus creating a survival model. If the dynamics in two states are identical, they can be viewed as one. Life annuity at age 65.
\def\PlA{(0,0)}
\begin{figure}[H]
\begin{center}
\begin{tikzpicture}
\begin{scope}[every node/.style={rectangle,thick,draw,inner sep=10pt,minimum width=2cm,minimum height = 1cm},rounded corners=1mm]
    \node (0) at \PlA {0, alive};
    \node (1) at ($(0) + (4.5,0)$) {1, dead};
\end{scope}

\begin{scope}[>={Stealth[black]},
              every node/.style={fill=white,circle,scale=0.9},
              every edge/.style={draw=black,very thick}]
    \path [->] 	(0) edge [bend left=0] node {$\mu$} (1);
\end{scope}
\end{tikzpicture}
\label{fig:1}
\caption{Life-Death model}
\end{center}
\end{figure}






\subsection{Two Active States}
When expanding to a model where there are two active states, and $n$ inactive states, we need to use a different method to calculate $\hat{W}$, \textit{if the active states are transient}. There is an important difference between the hierarchical model with two active states, and the transient model with two active states. In the model with one active state, we know the entire history of the policy, given that the policy is in the active state. When we introduce a second active state in the hierarchical model, we also know where the policy has been given the active state, but we do not know when it transitioned from one active state to the other. In order to calculate the expectation of the savings and surplus, we simply have to integrate over all possible transition times. If there are two transient states, there is an infinite amount of paths to any of the transient states, and for each possible path we have to integrate over all possible jump times. As it serves an informational purpose, we consider the naive method of calculating expected savings and surplus in a hierarchical model. Consider the model depicted in figure \ref{fig:2}
 \def\PlA{(0,0)}
\begin{figure}[H]
\begin{center}
\begin{tikzpicture}
\begin{scope}[every node/.style={rectangle,thick,draw,inner sep=10pt,minimum width=2cm,minimum height = 1cm},rounded corners=1mm]
    \node (0) at \PlA {0, active};
    \node (1) at ($(0.center) + (4.9,0)$) {1, active};
    \node (2) at ($(0.center) + (0,-3)$) {inactive};    
    \node (3) at ($(0.center) + (4.9,-3)$) {inactive};    
\end{scope}

\begin{scope}[>={Stealth[black]},
              every node/.style={fill=white,circle,scale=0.9},
              every edge/.style={draw=black,very thick}]
    \path [->] 	(0) edge [bend left=0] node {$\mu_{01}$} (1);
    \path [->] 	(0) edge [bend left=0] (2);
    \path [->] 	(1) edge [bend left=0] (3);
\end{scope}
\end{tikzpicture}
\caption{Two active state hierarchical model}
\label{fig:2}
\end{center}
\end{figure}
\noin In this model, there are two states for which the savings and surplus are non-zero; $Z(t)\in \{ 0, 1\}$. As in the case with one active state, we know the value of $W(t)$ for $Z(t)=0$, but for $Z(t)=1$ we need to consider all possible transition times. Let $T_1$ be the time of the transition from 0 to 1. If $W_0$ solves
\begin{align*}
W_0(t)=&\int_0^t g(s,0,W_0(s)) ds,
\intertext{then it characterizes the expected value of $W(t)$, given that $Z(t)=0$. Similarly, $W_1$ characterizes the value of $W(t)$ given $Z(t)=1$ and $dN_{01}(T_1)=1$, if it solves}
W_1(T_1,T_1)=&W_0(T_1)+h(T_1,0,1,W_0(T_1)), \\
W_1(T_1,t)=&\int_{T_1}^t g(s,1,W_1(T_1,s)) ds.\\
\intertext{The density of $T_1$, given that $Z(t)=1$ is}
q(s,t)=&\frac{p_{00}(0,s)p_{11}(s,t)}{p_{01}(0,t)}\mu_{01}(s).
\end{align*}
Let $T_1$ be the time of the first jump, then
\begin{align*}
W(t)= \indic{Z(t)=0} W_0(t)+\indic{Z(t)=1}W_1(T_1,t),
\end{align*}
implying that
\begin{align*}
\E [ W(t)] =& p_{00}(0,t) \E[W_0(t)|Z(t)=0] + p_{01}(0,t) \E[W_1(T_1,t)|Z(t)=1].
\end{align*}
%Note that
%\begin{align*}
%\E[W(t)|Z(t)=i]=
%\begin{dcases}
%W_0(t)\quad &\text{ for } Z(t)=0\\
%\int_0^t q(s,t) W_1(s,t) ds &\text{ for } Z(t)=1 \\
%0 &\text{ otherwise }. \\
%\end{dcases}
%\end{align*}
When $Z(t)=0$ all information about the history of the policy is known, and the value of $W$ is deterministic. Conditioning on $Z(t)=1$ does not provide full information about the history of the policy, as we do not know the time at which the transition from state 0 to state 1 was made. Therefore, to calculate $\E[W(t)|Z(t)=1]$ we have to integrate over all possible transition times, weighted by the transition intensity given that a jump happened prior to $t$. Thus
$$
\E [ W(t)]=p_{00}(0,t) W_0(t) + p_{01}(0,t) \int_0^t q(s,t) W_1(s,t) ds.
$$
We could apply this method of calculating $\E[W(t)]$ to any model. The basic principle is simple: given all information about the past of $Z$, we can calculate the value of $W(t)$, and the expected past can be calculated for each possible path of the policy. In general $\hat{W}$ can be calculated as
\begin{align}
\E[W(t)]= \sum_{i \in \mathcal{P}}  P(\text{path }i \text{ at time } t) \int_{(0,t]^{L_i}} W_i(t,\Theta_{L_i}) dP_i(\Theta_{L_i}),
\label{eq:AAA}
\end{align} 
where $\mathcal{P}$ is the set of possible policy paths, $L_i$ is the length of path $i$, $\Theta_{L_i}$ is an $L_i$-dimensional vector of jump-times, $dP_i$ is the density of transition times for path $i$ and $W_i(t,\Theta_{L_i})$ is the value of $W(t)$ given the path and transition times.
\\
When the model is small and hierarchical, \eqref{eq:AAA} provides a tractable method to calculate the expected savings and surplus, as there are few possible paths and they are short. When the model is transient the problem explodes, as there are infinitely many paths for the policy to take. Fortunately, there are some very large corners to cut, under the simple assumption that $g$ and $h$ are affine in $W$. Consider the case where $W$ has dynamics
$$
dW(s)=g(s,Z(s))W(s) ds,
$$
then
\begin{align*}
W(t)
%=& \int_0^{T_1} g(s,0)W(s) ds + \int_{T_1}^t g(s,1) W(s) ds \\
%=& \int_0^t \indic{Z(s)=0} g(s,0)W(s) + \indic{Z(s)=1} g(s,1) W(s) ds
%\\
=& \int_0^t W(s) g(s,Z(s)) ds.
\end{align*}
Say we want to calculate 
$$
\tilde{W}^i(t):=\E_{Z(0)}[W(t)\indic{Z(t)=i}]
=\E_{Z(0)}[W(t)|Z(t)=i]p_{Z(0)i}(0,t),
$$ 
as we can use it to calculate $\E_{Z(0)}[W(t)]$. By the tower property and Fubinis theorem,
\begin{align*}
\tilde{W}^i(t)
=&
\int_0^t \E[ \indic{Z(t)=i} W(s) g(s,Z(s))] ds
\\
=&
\int_0^t \E_{Z(0)} \left[ \sum_{j \in \mathcal{J}} \indic{Z(s)=j}\E_{Z(0)}[ \indic{Z(t)=i} W(s) g(s,Z(s))|Z(s)=j] \right] ds\\
=&
\int_0^t  \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s)\E_{Z(0)}[ \indic{Z(t)=i} W(s) g(s,Z(s))|Z(s)=j]] ds\\
=&
\int_0^t  \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s)g(s,j) \E_{Z(0)}[ \indic{Z(t)=i} W(s)|Z(s)=j]] ds\\
\intertext{By the Markov property $W(s)\independent Z(t)|Z(s)$, as $W(s)$ is $\mathcal{F}_s$-measurable, and therefore}
\tilde{W}^i(t)=&
\int_0^t  \sum_{j \in \mathcal{J}} g(s,j) \tilde{W}^j(t) p_{ji}(s,t)ds.
\end{align*}
Differentiating with respect to $t$, and using Kolmogorov's forward differential equations yields the following system of differential equations
\begin{align*}
\frac{d}{dt} \tilde{W}^i(t)=&\tilde{W}^i(t)g(t,i)+ \sum_{j\neq i} \mu_{ji}(t)\tilde{W}^j(t)-\mu_{ij}(t)\tilde{W}^i(t)
\\
\tilde{W}^i(0)=&\indic{Z(0)=i}W(0).
\end{align*}
It is crucial to note that this differential equation is invariant to whether or not the model is transient, in contrast to the naive approach where all possible paths need to be considered individually. In the next section we generalise the result.

\section{State-Wise Probability Weighted Reserve}
In the previous section we presented a differential equation for a simple model, without any payments on transition. The same methodology can be applied for a general Markov model with affine dynamics. We are interested in $\tilde{W}^i(t)$ for $i \in \mathcal{J}$, noting that the relation between $\tilde{W}^i$ and $\E_{Z(0)}[W(t)]$ is given by
\begin{align*}
\E_{Z(0)}[W(t)] =&
% \E_{Z(0)}[\E_{Z(0)} [ X(t)|Z(t)]] 
%\\
%=&
%\E_{Z(0)} \left[ \sum_{j\in \mathcal{J}} \indic{Z(t)=j} \E_{Z(0)} [ X(t)|Z(t)=j] \right]
%\\
%=&
\E_{Z(0)} \left[ \sum_{i\in \mathcal{J}} \indic{Z(t)=i} \frac{\E_{Z(0)}[W(t)\indic{Z(t)=i}]}{p_{0i}(0,t)} \right]
\\
%=&
%\sum_{j\in \mathcal{J}} p_{0j}(0,t) \frac{ \tilde{X}^j(t)}{p_{0j}(0,t)}
%\\
=&
\sum_{i\in \mathcal{J}} \tilde{W}^i(t).
\end{align*}
By using the tower property and the fact that $W(s-)\independent Z(t)|Z(s-)$, we get the following theorem
\begin{thm}[]
\label{thm:Diff_1}
Let $Z(t)$ be a Markov process on the state space $\mathcal{J}$, and let $W(t)$ be a $\mathcal{F}_t$-measurable process with dynamics
\begin{align*}
dW(s)=  g(s,Z(s),W(s))ds+
 \sum_{k \neq Z(s-)} h(s,Z(s-),k,W(s-)) dN^k(s) 
\end{align*}
for $g$ and $h$ of the form
\begin{align*}
g(s,Z(s),W(s))=&g_1(s,Z(s)) W(s)+g_2(s,Z(s))
\\
h(s,Z(s-),k,W(s-))=&h_1(s,Z(s-),k) W(s-)+h_2(s,Z(s-),k).
\end{align*}
Then
\begin{align}
\frac{d}{dt}\tilde{W}^i(t)=&
\sum_{j \neq i} \mu_{ji}(t) \tilde{W}^j(t)-\mu_{ij}(t)\tilde{W}^i(t)
 \label{eq:AAH} \\
&+
\tilde{W}^i(t)g_1(t,i)+p_{Z(0)i}(0,t)g_2(t,i)
 \label{eq:AAI}\\
&+
\sum_{j\neq i} \mu_{ji}(t) \left( \tilde{W}^j(t) h_1(t,j,i)+ p_{Z(0)j}(0,t)h_2(t,j,i)\right) \label{eq:AAF}
\\
\tilde{W}^i(0)=&\indic{Z(0)=i}W(0) \label{eq:AAG}
\end{align}
\end{thm}
The differential equations given by \eqref{eq:AAH}-\eqref{eq:AAG} bear close resemblance to the differential equation for the retrospective reserve derived by \citet{Norberg}. \citet{Norberg} allows for dynamics that depend on the expected value of $W$, while we allow for dynamics of the process to depend on the process itself. The terms \eqref{eq:AAH}-\eqref{eq:AAF} in the differential equation can be intuitively explained.

If the policy is in state $i$ at time $t$, it will develop with the continuous dynamics of that state, given by $W(t)g_1(t,i)+g_2(t,i)$. Due to the uncertainty involved pertaining to the state of the policy and the value of $W$, we have to weigh these dynamics with the probability of $Z(t)=i$, as well as the expected value of $W$, thus arriving at \eqref{eq:AAI} as
$$
\E_{Z(0)} [\indic{Z(t)=i} \left(W(t)g_1(t,i)+g_2(t,i)\right)]= \tilde{W}^i(t)g_1(t,i)+p_{Z(0)i}(0,t)g_2(t,i).
$$
Similarly, we have to account for any transitions into the current state $i$, over the small interval $t+dt$. The infinitesimal probability of transition from $j$ to $i$ over an interval from $t$ to $t+dt$ is given by $\mu_{ji}(t)$, and if such a transition was made, the savings and surplus are bumped by $W(t)h_1(t,j,i)+h_2(t,j,i)$. In order for a transition from $j$ to $i$ to be possible over the interval $t+dt$, the policy has to be in state $j$ at time $t$, thus arriving at 
\eqref{eq:AAF} as
$$
\E_{Z(0)}[ \indic{Z(t)=j} \left( W(t)h_1(t,j,i)+ h_2(t,j,i)\right)]=\tilde{W}^j(t) h_1(t,j,i)+ p_{Z(0)j}(0,t)h_2(t,j,i).
$$
Furthermore, when a transition from $j$ to $i$ is made, the savings and surplus from state $j$ (after the bump) are transferred to the savings and surplus of state $i$, amounting to the term given in \eqref{eq:AAH}. A myriad of models fit into the framework of Theorem \ref{thm:Diff_1}, and even if only the savings account and surplus are projected, several other quantities of interest can be derived from these, for instance the present value of guaranteed future benefits
\begin{align*}
\text{GY}_i(t)=&\E \left[ \int_t^n e^{-\int_t^s r} d \left( B_1(s)+\frac{X(t)-V_1^{Z(t)*}(t)}{V_2^{Z(t)*}(t)}B_2(s) \right) \big|Z(t)=i\right]
\\
=&
\E \left[ \int_t^n e^{-\int_t^s r} d B_1(s) \big| Z(t)=i \right]
\\
&+ \frac{\E[X(t)|Z(t)=i]-V_1^{i*}(t)}{V_2^{i*}(t)}  \E \left[ \int_t^n e^{-\int_t^s r} dB_2(s) \big|Z(t)=i\right]
\\
=&
V_1^i(t)+\frac{\tilde{X}^{i}(t)p_{0i}(0,t)-V_1^{i*}(t)}{V_2^{i*}(t)}V_2^i(t).
\end{align*}
Where we in the second equality have used that $X(t)\independent B_2(s)|Z(t)$ for $s>t$.
However, we cannot calculate the present value of all future benefits including bonus
\begin{align*}
\text{G}_i(t)=&\E \left[ \int_t^n e^{-\int_t^s r} d \left( B_1(s)+\frac{X(s)-V_1^{Z(s)*}(s)}{V_2^{Z(s)*}(s)}B_2(s) \right) \big|Z(t)=i \right]
\\
\overset{?}{=}&
\int_t^n e^{-\int_t^s r} \sum_{j \in \mathcal{J}} p_{ij}(t,s) \left( b_1^j(s)+ \sum_{k\neq j} \mu^{jk}(s) b^{jk}(s)  \right) ds
\\
&+
\int_t^n e^{-\int_t^s r} \sum_{j \in \mathcal{J}} p_{ij}(t,s) \frac{\E[X(s)|Z(s)=j,Z(t)=i]-V_1^{j*}(s)}{V_2^{j*}(s)}\left( b_1^j(s)+ \sum_{k\neq j} \mu^{jk}(s) b^{jk}(s)  \right) ds
\end{align*}
as it involves $\E[X(s)|Z(s)=j,Z(t)=i]$.
\newpage
\section{Dealing With Free Policy}
Syvtilstandsmodel. Forklar hvad der sker ved overgang til fripolice. Bemærk $V^{3*}(t,u)=V^{0*+}(t)f(t-u)$ når intensiteterne er ens.\\

The free policy option is the option for the insured to cease all future premiums in exchange all future benefits being scaled accordingly. In the case where benefits are not scaled according to the savings account, there is a natural way to calculate the scaling factor, also called the free policy factor, as the function $f$ that solves
\begin{align*}
\E^* \left[ \int_t^n e^{-\int_t^s r*} dB(s)|Z(t)=0 \right]
=&\E^* \left[ \int_t^n e^{-\int_t^s r*} f(t) dB^+(s)|Z(t)=3 \right]
\\
\Leftrightarrow&
\\
f(t)=&\frac{V^{0*}(t)}{V^{0*+}(t)}.
\end{align*}
However, as the value of future guarantees under the first order basis is precisely $X$, no matter how the benefits are scaled, we cannot use this method to define the free policy factor as
\begin{gather*}
\E^* \left[ \int_t^n e^{-\int_t^s r*} d \left( B_1(s)+\frac{X(t)-V_1^{Z(t)*}(t)}{V_2^{Z(t)*}(t)}B_2(s) \right) |Z(t)=0 \right]
=
\\
\E^* \left[ \int_t^n e^{-\int_t^s r*} f(t) d \left( B_1^+(s)+\frac{X(t)-V_1^{Z(t)*}(t,0)}{V_2^{Z(t)*}(t,0)}B_2^+(s) \right) |Z(t)=3 \right]
\\
\Leftrightarrow
\\
V_1^{0*}(t)+ \frac{X(t)-V_1^{0*}(t)}{V_2^{0*}(t)}V_2^{0*}(t)
=
f(t)V_1^{0*+}(t)+ \frac{X(t)-V_1^{0*+}(t)f(t)}{V_2^{0*+}(t)f(t)}V_2^{0*+}(t)f(t)
\\
 \Leftrightarrow
\\
1=1
\end{gather*}
leaving us none the wiser. Instead we require that $Q(T_F-)=Q(T_F)$ for $T_F$ being the time of transition from premium paying to free policy. That is, we require that the number of extra $B_2$ payment streams bought, does not change when transitioning from premium paying to free policy. Benefits of both $B_1$ and $B_2$ are scaled by the free policy factor on transition to free policy. Now the free policy factor must satisfy
\begin{gather*}
\E^* \left[ \int_t^n e^{-\int_t^s r*} d \left( B_1(s)+\frac{X(t)-V_1^{Z(t)*}(t)}{V_2^{Z(t)*}(t)}B_2(s) \right) |Z(t)=0 \right]
=
\\
\E^* \left[ \int_t^n e^{-\int_t^s r*} f(t) d \left( B_1^+(s)+\frac{X(t)-V_1^{0*}(t)}{V_2^{0*}(t)}B_2^+(s) \right) |Z(t)=3 \right]
\\
\Leftrightarrow
\\
X(t)
=
f(t)V_1^{0*+}(t)+ \frac{X(t)-V_1^{0*+}(t)}{V_2^{0*+}(t)}V_2^{0*+}(t)f(t)
\\
\Leftrightarrow
\\
f(t)=\frac{X(t)V_2^{0*}(t)}{V_1^{0*+}(t)V_2^{0*}(t)+(X(t)-V_1^{0*}(t))V_2^{0*+}(t)},
\end{gather*}
implying that $f$ is now not a function, but a process. It is worth noting that this choice of free policy factor leads to $R^{03}(t,X(t))=b^{03}(t,X(t))=0$. As we assume defined benefits i.e $dB_2^+=dB_2$, we see that
$$
f(t)=\frac{X(t)}{X(t)-V_1^{0*-}(t)}.
$$
To our dismay this free policy factor is not affine in $X$, which causes some trouble as we shall see. Note that the only duration dependent part of the benefit pertains to the payments that are not scaled by the savings account,
\begin{align*}
dB^i(t,x,u)=&f(t-u)dB^{i+}_1(t)+\frac{x-V_1^{i*}(t,u)}{V_2^{i*}(t,u)}dB_2^{i+}(t)f(t-u)
\\
=&
f(t-u)dB^{i+}_1(t)+\frac{x-V_1^{i*+}(t)f(t-u)}{V_2^{i*+}(t)f(t-u)}dB_2^{i+}(t)f(t-u)
\\
=&
f(t-u)\left( dB^{i+}_1(t) - \frac{V_1^{i*+}(t)}{V_2^{i*+}(t)}dB_2^{i+}(t) \right)  +\frac{x}{V_2^{i*+}(t)}dB_2^{i+}(t),
\end{align*}
implying that the dynamics of $X$ are on the form
\begin{align}
dX(s)=&X(s)g_1(s,Z(s))ds+g_2(s,Z(s))ds +  \indic{Z(s)\in \mathbb{F}} f(s-U(s)) g_3(s,Z(s))ds \label{eq:AAK} \\
&+
\sum_{h\neq Z(s-)} \left( X(s-)h_1(s,Z(s-),h)+ h_2(s,Z(s-),h) + \right) dN^h(s)
\nonumber \\
&+
\sum_{h\neq Z(s-)}  \indic{Z(s)\in \mathbb{F}} f(s-U(s))h_3(s,Z(s-),h) dN^h(s),
\nonumber
\end{align}
where $\mathbb{F} \subseteq \mathcal{J}$ are the set of free policy states. Note the two very important special cases;
\begin{itemize}
\item $dB_1^{Z(t)+}(t)=dB_2^{Z(t)+}(t)$, corresponding to the assumption that whatever benefits the insured has already bought, are the same benefits he wants to buy using his dividend.
\item $dB_1^{Z(t)+}(t)=0$, which is the case when $B_1$ only relates to the premium of the policy. 
\end{itemize}  In these cases, the dynamics of $X$ are independent of the free-policy duration. This is because the otherwise duration dependent terms of the dynamics of $X$, $dB$ and $\chi^{jk}$, can be written as
\begin{align*}
dB^i(t,x,u)=&\frac{x}{V_1^{i*+}(t)}dB_2^{i+}(t)
\\
\chi^{jk}(t,x,u)=&V_1^{k*+}(t)f(t-u)+\frac{x-V_1^{j*+}(t)f(t-u)}{V_2^{j*+}(t)f(t-u)}V_2^{k*+}(t)f(t-u)
\\
=&
\frac{x}{V_2^{j*+}(t)}V_2^{k*+}(t).
\end{align*}
Pleasing as these special cases may be, they are not general enough to encompass the real-world complexity we need. Instead we should try to derive a differential equation for the expectation of the savings account when it has dynamics given by \eqref{eq:AAK}.
\\
For general $B_1$ and $B_2$, the extra terms when taking expectation of dynamics of $X$ compared to the case without duration dependence, are
\begin{gather}
\E_{Z(0)} [ \indic{Z(s) \in \mathbb{F}} \indic{Z(t)=j} g_3(s,Z(s-)) f(s-U(s))|Z(s-)=g] \label{eq:AAL}
\intertext{and}
\sum_{h \neq g} \E_{Z(0)} [ \indic{Z(s) \in \mathbb{F}} \indic{Z(t)=j} h_3(s,Z(s-),h) dN^h(s) f(s-U(s))|Z(s-)=g]
\label{eq:AAJ}
\end{gather}
Commencing with \eqref{eq:AAL},
\begin{align*}
&\E_{Z(0)} [ \indic{Z(s) \in \mathbb{F}} \indic{Z(t)=j} g_3(s,Z(s-)) f(s-U(s))|Z(s-)=g]
\\
&= \E_{Z(0)} [  \indic{Z(t)=j} f(s-U(s))|Z(s-)=g] \indic{g \in \mathbb{F}} g_3(s,g).
\intertext{By conditioning on the indicator function and multiplying with its probability we get}
%&= \E_{Z(0)} [ f(s-U(s))|Z(s-)=g, Z(t)=j] P(Z(t)=j|Z(s-)=g,Z(0)=0) \indic{g \in \mathbb{F}} g_3(s,g)
%\\
&= \E_{Z(0)} [ f(s-U(s))|Z(s-)=g, Z(t)=j] p_{gj}(s,t) \indic{g \in \mathbb{F}} g_3(s,g).
\end{align*}
Note that $f(s-U(s))$ is $\mathcal{F}_s$-measurable, and by the Markov property independent of $Z(t)$ given $Z(s)$, for $t>s$. Therefore
\begin{align*}
&\E_{Z(0)} [ f(s-U(s))|Z(s-)=g, Z(t)=j] p_{gj}(s,t) \indic{g \in \mathbb{F}} g_3(s,g)
\\
&=
\E_{Z(0)} [ f(s-U(s))|Z(s-)=g] p_{gj}(s,t) \indic{g \in \mathbb{F}} g_3(s,g)
\\
&=
\E_{Z(0)}[ \indic{Z(s-)=g} f(s-U(s))] \frac{p_{gj}(s,t)}{p_{Z(0)g}(0,s)} \indic{g \in \mathbb{F}} g_3(s,g)
\\
&= g_3(s,g) \frac{p_{gj}(s,t)}{p_{Z(0)g}(0,s)} \indic{g \in \mathbb{F}} \int_0^s  \E_{Z(0)}[f(\tau) \indic{Z(s-)=g}|s-U(s)=\tau] dP(s-U(s)\leq \tau | Z(0)).
\end{align*}
Performing the same calculations as in section A.2 of \citet{THM_BUC}, and noting that $f(\tau)\independent \indic{Z(s-)=g}|s-U(s)$, we get
\begin{align*}
g_3(s,g)\frac{p_{gj}(s,t)}{p_{Z(0)g}(0,s)} \indic{g \in \mathbb{F}} \int_0^s  \E[f(\tau)\indic{Z(s-)=g}|Z(0),s-U(s)=\tau] dP(s-U(s)\leq \tau | Z(0))
\\
=
g_3(s,g)\frac{p_{gj}(s,t)}{p_{Z(0)g}(0,s)} \indic{g \in \mathbb{F}} \int_0^s p_{Z(0)0}(0,\tau) \mu_{03}(\tau) \E_{Z(0)}[ f(\tau)|Z(\tau)=0] p_{3g}(\tau,s) d\tau,
\end{align*}
As $f(\tau)$ is not affine in $X(\tau)$, we cannot simply replace $X$ with its expectation given $Z(\tau)$. We can however perform a second order Taylor expansion of $f$ around $\tilde{X}^0(\tau)$, and get
\begin{align*}
\E_{Z(0)}[f(\tau) |Z(\tau)=0]
=&
\E_{Z(0)}[\tilde{f}(\tau) |Z(\tau)=0]+ 
\E_{Z(0)} \left[ O \left( \left( X(\tau)-\frac{\tilde{X}^0(\tau)}{p_{Z(0)0}(0,\tau)} \right) ^2 \right) \bigg| Z(\tau)=0 \right]
\end{align*}
where 
$$
\tilde{f}(\tau)=
\frac{
	\frac{\tilde{X}^0(\tau)}{p_{Z(0)0}(0,\tau)}
}{
	\frac{\tilde{X}^0(\tau)}{p_{Z(0)0}(0,\tau)}
	-V_1^{0*-}(\tau)
}
+
\frac{
	V_1^{0*-}(\tau)
	}{
	\left( V_1^{0*-}(\tau)-
	\frac{\tilde{X}^0(\tau)}{p_{Z(0)0}(0,\tau)}
	\right)^2
}
\left( \frac{\tilde{X}^0(\tau)}{p_{Z(0)0}(0,\tau)}-X(\tau)\right),
$$
which is affine in $X$. As $\E_{Z(0)}[X(\tau)|Z(\tau)=0]=\frac{\tilde{X}^0(\tau)}{p_{Z(0)0}(0,\tau)}$, the second term vanishes and
\begin{align*}
\E_{Z(0)}[f(\tau) |Z(\tau)=0]
=&
\frac{
	\frac{\tilde{X}^0(\tau)}{p_{Z(0)0}(0,\tau)}
}{
	\frac{\tilde{X}^0(\tau)}{p_{Z(0)0}(0,\tau)}
	-V_1^{0*-}(\tau)
}
\\
&+
\E_{Z(0)} \left[ O \left( \left( X(\tau)-\frac{\tilde{X}^0(\tau)}{p_{Z(0)0}(0,\tau)} \right) ^2 \right) \bigg| Z(\tau)=0 \right].
\end{align*}
Now we perform an approximation by disregarding the expectation of the $O$-function, leaving us with a deterministic approximated free policy factor, and as the duration dependent benefits are independent of $X$, we may use the lost-all trick to conclude
\begin{align*}
\E_{Z(0)} [ \indic{Z(s) \in \mathbb{F}} \indic{Z(t)=j} g_3(s,Z(s-)) f(s-U(s))|Z(s-)=g]
=
\frac{p^{\text{lost}}_{Z(0)g}(0,s)}{p_{Z(0)g}(0,s)} \indic{g \in \mathbb{F}} p_{gj}(s,t)g_3(s,g).
\end{align*}
Now, consider \eqref{eq:AAJ}
\begin{align*}
\E_{Z(0)} [  \indic{Z(t)=j}  dN^h(s) f(s-U(s))|Z(s-)=g] h_3(s,g,h) \indic{g \in \mathbb{F}}.
\end{align*}
Note that $U(s)|Z(s-) \independent \indic{Z(t)=j}dN^h(s)|Z(s-)$ \textbf{OBS!} By the same arguments used to prove \eqref{eq:AAL}.
\begin{align*}
\E_{Z(0)}[f(s-U(s))|Z(s-)=g] \E[ \indic{Z(t)=j}dN^h(s) |Z(s-)=g] h_3(s,g,h) \indic{g \in \mathbb{F}}.
\\
=\frac{p_{0g}^\text{lost}(0,s)}{p_{0g}(0,s)} p_{hj}(s,t) \mu_{gh}(s) h_3(s,g,h) \indic{g \in \mathbb{F}}.
\end{align*}
Performing the same procedure as in the case without duration dependence brings us to the differential given by
\begin{subequations}
\begin{empheq}[box=\widefbox]{align*}
\vspace*{2em}
\frac{d}{dt}\tilde{X}^j(t)=&
\sum_{g\neq j} \mu^{gj}(t) \tilde{X}^g(t) - \mu^{jg}(t) \tilde{X}^j(t)
\\
&+ \tilde{X}^j(t) g_1(t,j)+p_{Z(0)j}(0,t) g_2(t,j)+p^\text{lost}_{Z(0)j}(0,t)g_3(t,j) \indic{j \in \mathbb{F}}
\\
&+ \sum_{g \neq j} \mu^{gj}(t) \left( \tilde{X}^g(t) h_1(t,g,j)+ p_{Z(0)g}(0,t) h_2(t,g,j) \right)
\\
&+
\sum_{g \neq j} \mu^{gj}(t) p^\text{lost}_{Z(0)g}(0,t) h_3(t,g,j)   \indic{g \in \mathbb{F}}
\\
\tilde{X}^j(0)=& \indic{Z(0)=j}X(0).
\vspace{2em}
\end{empheq}
\end{subequations}


\newpage

\subsection{General Path dependent dynamics}
Even though theorem \ref{thm:Diff_1} provides a powerful too for calculating future values of the savings and surplus, it is restricted to dynamics that only depends on the current value of $Z$ and $W$. It is not unreasonable to assume that the dividend strategy depends on the history of $Z$ and $W$. It turns out, that for certain dynamics that, in some sense, are linearly dependent on the past we can 


\begin{thm}[]
\label{thm:Diff_2}
Let $Z(t)$ be a Markov process on the state space $\mathcal{J}$, and let $W(t)$ be a $\mathcal{F}_t$ measurable process with dynamics
\begin{align*}
dW(s)= d g(s,\{Z(\tau)\}_{\tau\leq s},\{W(\tau)\}_{\tau\leq s})+
 d h(s,\{Z(\tau)\}_{\tau\leq s},\{W(\tau)\}_{\tau\leq s})
\end{align*}
for $g$ and $h$ of the form
\begin{align*}
g(s,\{Z(\tau)\}_{\tau\leq s},\{W(\tau)\}_{\tau\leq s})=&\int_{(0,s]} \varphi_1(s,\tau,Z(\tau))W(\tau) d\nu_g(\tau,t)
\\
&+
\int_{(0,s]} \varphi_2(s,\tau,Z(\tau)) d\eta_g(\tau,t)
\\
h(s,\{Z(\tau)\}_{\tau\leq s},\{W(\tau)\}_{\tau\leq s})=&\int_{(0,s]} \sum_{k\neq Z(\tau-)} \psi_1(s,\tau,Z(\tau-),k) W(\tau-)  dN^k\otimes\nu_h(\tau,t)
\\
&+
\int_{(0,s]} \sum_{k\neq Z(\tau-)} \psi_2(s,\tau,Z(\tau-),k)  dN^k\otimes\eta_h(\tau,t),
\end{align*}
for some measures $\nu_g,\nu_h,\eta_g$ and $\eta_h$.
Then
\begin{align*}
\frac{d}{dt}\tilde{W}^i(t)=&
\sum_{j \neq i} \mu_{ji}(t) \tilde{W}^j(t)-\mu_{ij}(t)\tilde{W}^i(t)
\\
&+
\int_{(0,t]} \sum_{k \in \mathcal{J}} p_{ki}(\tau,t) \varphi_1(t,\tau,k) \tilde{W}^k(\tau) d\nu_g(\tau,t) ds
\\
&+
p_{Z(0)i}(0,t)\int_{(0,t]} \sum_{k \in \mathcal{J}} p_{ki}(\tau,t) \varphi_2(t,\tau,k) d\eta_g(\tau,t) ds
\\
\tilde{W}^i(0)=&\indic{Z(0)=i}W(0)
\end{align*}

\end{thm}
We see that theorem \ref{thm:Diff_1} is a special case of theorem \ref{thm:Diff_2} with $\nu_g,\nu_h,\eta_g$ and $\eta_h$ being the Dirac measures in $t$, i.e 
$$
\nu_g(\tau,t)=\nu_h(\tau,t)=\eta_g(\tau,t)=\eta_h(\tau,t)=\indic{\tau=t}
$$



\subsection{Thoughts}
\begin{itemize}
\item Use lumping to prove that lost-all state works if and only if $\tilde{X}^i(t,\tau) = \tilde{X}^{i+}(t)f(\tau)$
\item With-profit insurance! Expected reserve including accumulation of dividends.
\item Refer to \citet{Norberg}
\begin{itemize}
\item Introduction and motivation - stochastic reserve, Monte Carlo method. A little comment on the fact that the problem is still hard to solve.
\item Life-death (simple analytic solution).
\item Life-death free policy (how to deal with extra states).
\item General model without duration.
\item Life-death-surrender free policy, including discussion of free policy factor.
\item Lost all trick works.
\item General model with duration dependence.
\item Inclusion of surplus. Use independence when dividend is assigned on discrete points in time.
\end{itemize}
\item Deterministic intensities.
\item General Hierarchical models do not need linearity. In general the variance increases as the number of states increase as the variance of the sum of transition times increases.
\item Market dependent intensities - allowed when directly dependent on the market, making them deterministic. Or intensities that depend on the expected reserve - in a sense corresponding to intensities that depend on the group of similar policies.
\item We are only concerned with the reserve.
\item Maybe we should use a different wording? \textbf{Savings}/stash/backlog/accumulation/hoard/reservoir instead of reserve, to distinguish between the Danish words for "reserve" and "depot"
\item One could imagine that information about the jump time could be partially deduced from the intensities, thus almost allowing for non-linearity. Consider case where $\mu_{01}(t)= \kappa \indic{t \in (c_1,c_2]}$ for very small $|c_2-c_1|$ and very large $\kappa$, providing almost perfect information about the jump time, whereby non-linearity in $g(s,1,W(s))$ would be allowed for.
\item Using monte-carlo methods we can get an estimate for the development of the portfolio. Using this, we can find the corresponding forward rate. If this forward rate is lower than the forward rate provided by the FSA, then the investment strategy is poor? If it is higher than the forward rate provided by the FSA, it implies existence of arbitrage?
\item To calculate GY, can we not simply use
$$
V_1^j(t)+\frac{X(t)-V_1^{j*}(t)}{V_2^{j*}(t)}V_2^{j}(t)
$$
As GY at time $t$ assumes no further dividends, implying that for $t<s$,
\begin{align*}
dX(s)
=& 
d\left(V_1^{Z(s)}(s)+\frac{X(t)-V_1^{Z(t)}(t)}{V_1^{Z(t)}(t)}V_2^{Z(s)}(s)\right)
\\
=&
d(V_1^{Z(s)}(s))+\frac{X(t)-V_1^{Z(t)}(t)}{V_1^{Z(t)}(t)}d(V_2^{Z(s)}(s))
\end{align*}
\end{itemize}
\newpage

\subsection*{Stuff to fix}
\begin{itemize}
\item Jeg kommer med flere påstande om industrien som jeg ikke er sikker på har hold i virkeligheden.
\item Der er i princippet ikke nogen grund til at vi regner retrospektivt, når vi alligevel ikke bruger historikken... Skal vi udvidde, så X kan afhænge lineært af tidligere værdier? Vi kræver blot at
$$
\E[g(t,Z(t),\{ X(\tau) \}_{\tau\leq t})|Z(t)=i]=g(t,i,\{ \E[X(\tau)|Z(t)=i] \}_{\tau \leq t})$$
fx ved
$$
g(t,i,\{X(\tau)\}_{\tau \leq t})=\int_0^t f^1_i(\tau) X(\tau) d\nu_1(\tau,t) + \int_0^t f^2_i(\tau) X(\tau) d\nu_2(\tau,t)
$$
for ét eller andet sigma-additivt mål $\nu_1$ (og $\nu_2$). Fx kunne $\nu_1$ være lebesque målet fra $t-1$ til $t$, mens $\nu_2$ kunne være punktmålet i $t$ hvilket er specialtilfældet som vi i øjeblikket kigger på. Vi kan også lade $g$ afhænge af tidligere værdier af $Z$, fx på følgende måde
$$
g(t,\{Z(\tau)\}_{\tau\leq t},\{X(\tau)\}_{\tau\leq t})=
\int_0^t f(Z(\tau),\tau,t) X(\tau) d\nu(\tau),
$$
hvorved
\begin{align*}
&\E_{Z(0)}[\indic{Z(r)=i}g(t,\{Z(\tau)\}_{\tau\leq t},\{X(\tau)\}_{\tau\leq t})|Z(t-)=g]
\\
=&
p_{gi}(t,r)\int_0^t \E[ f(Z(\tau),\tau,t) X(\tau)|Z(t-)=g] d\nu(\tau,t)
\\
=&
\int_0^t p_{gi}(t,r) \E \left[ \sum_{j \in \mathcal{J}}  \indic{Z(\tau)=j} f(j,\tau,t) \E[X(\tau)|Z(\tau)=j,Z(t-)=g] \bigg| Z(t-)=g \right] d\nu(\tau,t)
\\
=&
\int_0^t p_{gi}(t,r) \E \left[ \sum_{j \in \mathcal{J}}  \indic{Z(\tau)=j} f(j,\tau,t) \frac{\E[X(\tau)\indic{Z(\tau)=j}]}{p_{0j}(0,\tau)} \bigg| Z(t-)=g \right] d\nu(\tau,t)
\\
=&
\int_0^t p_{gi}(t,r) \sum_{j \in \mathcal{J}}  P(Z(\tau)=j|Z(0)=0,Z(t)=g) f(j,\tau,t) \frac{\tilde{X}^j(\tau)}{p_{0j}(0,\tau)}  d\nu(\tau,t)
\\
=&
\int_0^t \sum_{j \in \mathcal{J}} \frac{p_{jg}(\tau,t)}{p_{0g}(0,t)} p_{gi}(t,r) f(j,\tau,t) \tilde{X}^j(\tau) d\nu(\tau,t).
\end{align*}
hvor vi har brugt at $X(\tau)|Z(\tau)$ er uafhængig af $Z(t)|Z(\tau)$ for $\tau\leq t$. På denne måde kunne man fx. lade dividenden være en klumpbetaling svarende til det gennemsnitlige forventede bidrag over det sidste år, altså $f(j,\tau,t)X(\tau)=X(\tau)(r(\tau)-r^*(\tau))\sum_{k\neq j} \rho_1^{jk}(t)+\sum_{k\neq j} \rho_2^{jk}(t)$ for $\nu(\tau,t)$ værende lebesque målet for $(t-1,t]$ hvis $t$ er et heltal, og ellers 0. Da $\nu$ ikke nødvendigvis er absolut kontinuert, vil $g$ ikke svare til den kontinuerte udvikling af $X$ - vi tillader klump-betalinger på deterministiske tidspunkter.
\item Tilsvarende for $h$
$$
h(t,\{Z(\tau)\}_{\tau\leq t},\{X(\tau)\}_{\tau\leq t})
=\int_{(0,t]} \sum_{k \neq Z(\tau-)} \phi(\tau,t,Z(\tau-),k) X(\tau-) dN^k\otimes\nu(\tau,t)
$$
Taking the expectation and conditioning on $Z(t-)=g$
\begin{align*}
&\E[\indic{Z(r)=j} h(t,\{Z(\tau)\}_{\tau\leq t},\{X(\tau-)\}_{\tau\leq t})|Z(t-)=g]
\\
=&
\int_{(0,t]} \E \left[ \sum_{k \neq Z(\tau-)} \phi(\tau,t,Z(\tau-),k) \indic{Z(r)=j} X(\tau-) dN^k\otimes\nu(\tau,t) \bigg| Z(t-)=g \right]
\\
=&
\int_{(0,t]} \E \left[ \E \left[ \sum_{k \neq Z(\tau-)} \phi(\tau,t,Z(\tau-),k) \indic{Z(r)=j}X(\tau-) dN^k\otimes\nu(\tau,t) |Z(\tau-), Z(t-)=g \right] \bigg| Z(t-)=g \right]
\\
=&
\int_{(0,t]} \E \left[ \sum_{i \in \mathcal{J}}\indic{Z(\tau)=i} \E \left[ \sum_{k \neq i} \phi(\tau,t,i,k) \indic{Z(r)=j}X(\tau-) dN^k\otimes\nu(\tau,t) |Z(\tau-)=i, Z(t-)=g \right] \bigg| Z(t-)=g \right]
\\
=&
\int_{(0,t]} \E \left[ \sum_{i \in \mathcal{J}}\indic{Z(\tau)=i} \sum_{k \neq i} \phi(\tau,t,i,k) \E \left[  \indic{Z(r)=j}X(\tau-) dN^k\otimes\nu(\tau,t) |Z(\tau-)=i, Z(t-)=g \right] \bigg| Z(t-)=g \right]
\\
=&
\int_{(0,t]} \E \left[ \sum_{i \in \mathcal{J}}\indic{Z(\tau)=i} \sum_{k \neq i} \phi(\tau,t,i,k) \E \left[  \indic{Z(r)=j}X(\tau-) dN^k(\tau) |Z(\tau-)=i \right]\nu(\tau,t) \bigg| Z(t-)=g \right]
\intertext{og da $X(\tau-)|Z(\tau-)$ er uafhænig af $\indic{Z(r)=j}dN^h(\tau)|Z(\tau-)$}
=&
\int_{(0,t]} \E \left[ \sum_{i \in \mathcal{J}}\indic{Z(\tau)=i} \sum_{k \neq i} \phi(\tau,t,i,k) \E \left[ X(\tau-) |Z(\tau-)=i \right] \E[ \indic{Z(r)=j} dN^k(\tau) |Z(\tau-)=i]\nu(\tau,t) \bigg| Z(t-)=g \right]
\\
=&
\int_{(0,t]} \E \left[ \sum_{i \in \mathcal{J}}\indic{Z(\tau)=i} \sum_{k \neq i} \phi(\tau,t,i,k) \frac{\tilde{X}^i(\tau)}{p_{0i}(0,\tau)} \E[dN^k(\tau) |Z(\tau-)=i,Z(r)=j]p_{ij}(\tau,r)\nu(\tau,t) \bigg| Z(t-)=g \right]
\\
=&
\int_{(0,t]}  \sum_{i \in \mathcal{J}} \E \left[\indic{Z(\tau)=i}  | Z(t-)=g \right] \sum_{k \neq i} \phi(\tau,t,i,k) \frac{\tilde{X}^i(\tau)}{p_{0i}(0,\tau)} \mu_{ik|ij}(\tau|\tau,r) p_{ij}(\tau,r) d\nu(\tau,t)
\\
=&
\int_{(0,t]}  \sum_{i \in \mathcal{J}} \frac{p_{0i}(0,\tau)p_{ig}(\tau,t)}{p_{0g}(0,t)} \sum_{k \neq i} \phi(\tau,t,i,k) \frac{\tilde{X}^i(\tau)}{p_{0i}(0,\tau)} \mu_{ik|ij}(\tau|\tau,r) p_{ij}(\tau,r) d\nu(\tau,t)
\\
=&
\int_{(0,t]}  \sum_{i \in \mathcal{J}} \frac{p_{0i}(0,\tau)p_{ig}(\tau,t)}{p_{0g}(0,t)} \sum_{k \neq i} \phi(\tau,t,i,k) \frac{\tilde{X}^i(\tau)}{p_{0i}(0,\tau)} \mu_{ik}(\tau)\frac{p_{kj}(\tau,r)}{p_{ij}(\tau,r)} p_{ij}(\tau,r) d\nu(\tau,t)
\\
=&
\int_{(0,t]}  \sum_{i \in \mathcal{J}} \frac{p_{ig}(\tau,t)}{p_{0g}(0,t)} \sum_{k \neq i} \phi(\tau,t,i,k)\tilde{X}^i(\tau) \mu_{ik}(\tau)p_{kj}(\tau,r) d\nu(\tau,t)
\end{align*}
\item Meget i beviserne skal slettes. De er for lange
\item Flere steder skriver jeg at dividende også kan bruges til at nedskrive præmier. Det skaber mere forvirring end nytte at holde styr på begge muligheder. Omskriv dette så vi kun kan bruge dividende til at opskrive ydelser.
\end{itemize}


\appendix

\section{Proof of Theorem \ref{thm:Diff_1} }
\begin{proof}[Proof of theorem \ref{thm:Diff_1}]
The proof consists of two steps. First, we derive an integral equation for $\tilde{W}^i(t)$. Second, we differentiate this integral equation. \\
Assume that $p_{Z(0)i}(0,s)>0$ for all $s>0$. The general case where some states cannot be reached by time $s$ is considered at the end of the proof. By the tower property
\begin{align*}
\tilde{W}^i(t):=&\E_{Z(0)}[W(t) \indic{Z(t)=i}]
\\
=&
\E_{Z(0)} \left[ \int_0^t \indic{Z(t)=i} dW(s) \right]
\\
=&
\E_{Z(0)} \left[ \int_0^t \indic{Z(t)=i} g(s,Z(s),W(s))ds \right]
\\
&+
\E_{Z(0)} \left[ \int_0^t \sum_{k \neq Z(s-)} \indic{Z(t)=i} h(s,Z(s-),k,W(s-)) dN^k(s)  \right].
\end{align*}
Based on the calculations in section C of \citet{Norberg}, note that the intensity process of the predictable compensator for $N^{jk}(s)|Z(s-)=j, Z(t)=i$ is given by
$$
\mu_{jk}(s)\frac{p_{ki}(s,t)}{p_{ji}(s,t)}.
$$
As $h(s,Z(s-),k,W(s-)$ is predictable, we may replace the integrator $dN^k(s)$ with its predictable compensator. Using the tower property once more,
\begin{align*}
\tilde{W}^i(t)=&
\int_0^t \E_{Z(0)} \left[ \E_{Z(0)} \left[ \indic{Z(t)=i} g(s,Z(s),W(s))|Z(s) \right]\right] ds
\\
&+
\E_{Z(0)} \left[ \E_{Z(0)} \left[ \int_0^t \sum_{k \neq Z(s-)}\indic{Z(t)=i} h(s,Z(s-),k,W(s-)) dN^k(s) |Z(s-) \right] \right] 
\\
=&
\int_0^t \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s) \E_{Z(0)} \left[ \indic{Z(t)=i} g(s,Z(s),W(s))|Z(s)=j\right] ds
\\
&+
  \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s)   \E_{Z(0)} \left[\int_0^t \sum_{k \neq j} \indic{Z(t)=i} h(s,j,k,W(s-))  dN^k(s) |Z(s-)=j \right]
 \\
=&
\int_0^t \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s) \E_{Z(0)} \left[ \indic{Z(t)=i} g(s,Z(s),W(s))|Z(s)=j\right] ds
\\
&+
  \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s) p_{ji}(s,t)  \E_{Z(0)} \left[\int_0^t \sum_{k \neq j}  h(s,j,k,W(s-))  dN^k(s) |Z(s-)=j,Z(t)=i \right]
 \\
=&
\int_0^t \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s) \E_{Z(0)} \left[ \indic{Z(t)=i} g(s,Z(s),W(s))|Z(s)=j\right] ds
\\
&+
\sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s)  \int_0^t \sum_{k \neq j }   \E_{Z(0)} \left[ h(s,j,k,W(s-))  |Z(s-)=j,Z(t)=i \right] \mu_{jk}(s)p_{ki}(s,t) ds.
\end{align*}
Since $W(s)$ is $\mathcal{F}_s$-measurable, the Markov property gives us
$$
\E_{Z(0)}[\indic{Z(t)=i}W(s)|Z(s)=j]=\frac{\tilde{W}^j(s)}{p_{Z(0)j}(0,s)}p_{ji}(s,t), 
$$
and by the continuity of $\tilde{W}^i(t)$ we get
\begin{align*}
\tilde{W}^i(t)=&
\int_0^t \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s)\left( \frac{\tilde{W}^j(s)}{p_{Z(0)j}(0,s)}g_1(j,s)+g_2(j,s)\right)p_{ji}(s,t) ds
\\
&+
\int_0^t \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s)  \left( \sum_{k \neq j}  \mu_{jk}(t)p_{ki}(s,t) \left(  \frac{\tilde{W}^j(s)}{p_{Z(0)j}(0,s)} h_1(s,j,k)+h_2(s,j,k)  \right) \right) ds
\\
=&
\int_0^t \sum_{j \in \mathcal{J}} p_{ji}(s,t) \tilde{W}^j(s)g_1(j,s) ds
\\
&+
\int_0^t \sum_{j \in \mathcal{J}} \sum_{k \neq j}  \mu_{jk}(t) p_{ki}(s,t) \tilde{W}^j(s) h_1(s,j,k)  ds
\\
&+
\int_0^t \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s)g_2(j,s)p_{ji}(s,t) ds
\\
&+
\int_0^t \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s)  \sum_{k \neq j}  \mu_{jk}(t) p_{ki}(s,t)h_2(s,j,k) ds.
\end{align*}
Differentiating with respect to $t$ gives
\begin{align*}
\frac{d}{dt}\tilde{W}^i(t)=&
 \tilde{W}^i(t)g_1(i,t)+p_{Z(0)i}(0,t)g_2(i,t)\\
&+
\sum_{k \neq i} \mu_{ki}(t) \left( \tilde{W}^k(t) h_1(t,k,i) + p_{Z(0)k}(0,t)h_2(t,k,i) \right)
\\
&+
\int_0^t \frac{\partial}{\partial t}  \sum_{j \in \mathcal{J}} p_{ji}(s,t) \tilde{W}^j(s)g_1(j,s) ds
\\
&+
\int_0^t \frac{\partial}{\partial t}  \sum_{j \in \mathcal{J}} \sum_{k \neq j}  \mu_{jk}(t) p_{ki}(s,t) \tilde{W}^j(s) h_1(s,j,k)  ds
\\
&+
\int_0^t \frac{\partial}{\partial t}  \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s)g_2(j,s)p_{ji}(s,t) ds
\\
&+
\int_0^t \frac{\partial}{\partial t} \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s)  \sum_{k \neq j}  \mu_{jk}(t) p_{ki}(s,t)h_2(s,j,k) ds.
\end{align*}
By the Kolmogorov forward differential equations we arrive at
\begin{align*}
\frac{d}{dt}\tilde{W}^i(t)=&
 \tilde{W}^i(t)g_1(i,t)+p_{Z(0)i}(0,t)g_2(i,t)\\
&+
\sum_{k \neq i} \mu_{ki}(t) \left( \tilde{W}^k(t) h_1(t,k,i) + p_{Z(0)k}(0,t)h_2(t,k,i) \right)
\\
&+
\sum_{k \neq i} \mu_{ki}(t) \tilde{W}^k(t)-\mu_{ik}(t)\tilde{W}^i(t).
\end{align*}
Combined with the initial condition
$$
\tilde{W}^i(0)=\E_{Z(0)}[\indic{Z(0)=i}W(0)]=\indic{Z(0)=i}W(0),
$$
we arrive at the differential equations given by \eqref{eq:AAH}-\eqref{eq:AAG}. For the case where some state, $q$, cannot be reached before time $s$ for $s>0$, the product of intensities for all paths from $Z(0)$ into that state must be zero for all $\tau$ when $\tau \leq s$, whereby $\tilde{W}^q(s)=0$ and therefore the differential equations still hold. Thus the proof is complete.
\end{proof}

\section{Dynamics of $X$ and $Y$}
\label{seq:Dyn}
The amount by which the savings surpass the first order reserve, is spent on $B_2$. 
where
\begin{gather*}
b^j(t,x)=b_1^j(t)+\frac{x-V_1^{j*}(t)}{V_2^{j*}(t)}b^j_2(t),
\qquad \quad
b^{jg}(t,x)=b_1^{jg}(t)+\frac{x-V_1^{j*}(t)}{V_2^{j*}(t)}b^{jg}_2(t).
\end{gather*}
Dynamics of $X$
\begin{align*}
dX(t)=&
r^*(t)X(t)dt
 +\delta^{Z(t)}(t,X(t),Y(t))  dt- \sum_{g \neq Z(t-)} \rho^{Z(t-)g}(t,X(t-)) dt
 \nonumber 
\\
\nonumber
&- b^{Z(t)}(t,X(t)) dt
\\
&- \sum_{g\neq Z(t-)}\bigg(b^{Z(t-)g}(t,X(t-))+\chi^{Z(t-)g}(t,X(t-))-X(t-) \bigg) \mu^{Z(t)g}(t)dt
\\
&+ \sum_{g\neq Z(t-)}\bigg(\chi^{Z(t-)g}(t,X(t-))-X(t-) \bigg)  dN^g(t),
\end{align*}
and
\begin{align*}
dY(t)=Y(t)\frac{dS(t)}{S(t)}-\delta^{Z(t)}(t,X(t),Y(t)) + (r(t)-r^*(t)) X(t) + \sum_{g \neq Z(t-)} \rho^{Z(t)g}(t,X(t)),
\end{align*}
where
\begin{align*}
\rho^{jg}(t,x)=&(b^{jg}(t,x)+ \chi^{jg}(t,x)-x) (\mu^{*jg}(t)-\mu^{jg}(t))
\\
\chi^{jg}(t,x)=& V^{g*}_1(t) + \frac{x-V^{j*}_1(t)}{V^{j*}_2(t)}V^{g*}_2(t),
\end{align*}
\begin{equation}
\delta^j(t,x,y)=\delta_1^j(t)+\delta_2^j(t)x+\delta_3^j(t)y+\delta_4^j(t)xy.
\end{equation}

\begin{align*}
\tilde{W}^j(t):=
\begin{pmatrix}
\tilde{X}^j(t) \\
\tilde{Y}^j(t)
\end{pmatrix}
=
\begin{pmatrix}
\E[ X(t) \indic{Z(t)=j}] \\
\E[ Y(t) \indic{Z(t)=j}]
\end{pmatrix}
\end{align*}
With differential equation
\begin{align*}
\frac{d}{dt}\tilde{W}^j(t)=&
\sum_{g\neq j} \mu^{gj}(t) \tilde{W}^g(t) - \mu^{jg}(t) \tilde{W}^j(t)
\\
&+ \tilde{W}^j(t) \circ g_1(t,j,x,y)+p_{0j}(0,t) g_2(t,j)
\\
&+ \sum_{g \neq j} \mu^{gj}(t) \left( \tilde{W}^g(t) \circ h_1(t,g,j,x,y)+ p_{0g}(0,t) h_2(t,g,j) \right),
\\
\tilde{W}^j(0)=&\indic{Z(0)=j} \begin{pmatrix}
X(0)\\
Y(0)
\end{pmatrix},
\end{align*}
where $\circ$ denotes the Hadamard product (element-wise multiplication) and
\begin{gather*}
g_1(t,j,x,y)=\begin{pmatrix}
g_{x1}(t,j,y) \\
g_{y1}(t,j,x)
\end{pmatrix},
\qquad 
\quad
h_1(t,j,g,x,y)=\begin{pmatrix}
h_{x1}(t,j,g,y) \\
h_{y1}(t,j,g,x)
\end{pmatrix},
\\
g_2(t,j)=\begin{pmatrix}
g_{x2}(t,j,y) \\
g_{y2}(t,j,x)
\end{pmatrix},
\qquad 
\quad
h_2(t,j,g)=\begin{pmatrix}
h_{x2}(t,j,g,y) \\
h_{y2}(t,j,g,x)
\end{pmatrix}.
\end{gather*}
For 
\begin{align*}
g_{x1}(t,j,y)=&r^*(t)  +\delta_2^j(t)+\delta_4^j(t)y\\
&+\frac{b^j_2(t)}{V_2^{j*}(t)}
-\sum_{g \neq j} \rho_1^{jg}(t)
-\sum_{g \neq j} \left(\frac{b^{jg}_2(t)}{V_2^{j*}(t)} + \frac{V^{g*}_2(t)}{V^{j*}_2(t)}-1 \right) \mu^{jg}(t)
\\
g_{x2}(t,j,y)=& \delta_1^j(t)
+\delta_3^j(t)y
-b_1^j(t)
-\frac{V_1^{j*}(t)}{V_2^{j*}(t)}b^j_2(t)
-\sum_{g \neq j} \rho_2^{jg}(t)
\\
&-\sum_{g \neq j} \left( b_1^{jg}(t)-\frac{V_1^{j*}(t)}{V_2^{j*}(t)}b^{jg}_2(t) -\frac{V^{j*}_1(t)}{V^{j*}_2(t)}V^{g*}_2(t)+V^{g*}_1(t) \right) \mu^{jg}(t).
\end{align*}
\begin{align*}
h_x(t,j,g,x,y)=&\chi^{jg}(t,x) -x
\\
=&
V^{g*}_1(t) + \frac{x-V^{j*}_1(t)}{V^{j*}_2(t)}V^{g*}_2(t) -x
\\
=&
x
\underbrace{\left( \frac{V^{g*}_2(t)}{V^{j*}_2(t)}-1 \right)}_{h_{x1}(t,j,g,y)}+\underbrace{V^{g*}_1(t) - \frac{V^{j*}_1(t)V^{g*}_2(t)}{V^{j*}_2(t)}}_{h_{x2}(t,j,g,y)}.
\end{align*}
For $g_y$ we get
\begin{align*}
g_y(t,j,x,y)=&y \frac{dS(t)}{S(t)} - \delta^j(t,x,y) + (r(t)-r^*(t)) x + \sum_{g \neq j} \rho^{jg}(t,x) 
\\
=&y\frac{dS(t)}{S(t)} - \delta_1^j(t)-\delta_2^j(t)x-\delta_3^j(t)y-\delta_4^j(t)xy
\\
&+ (r(t)-r^*(t)) x
+\sum_{g \neq j} \rho^{jg}(t,x)
\\
=& y \underbrace{\left( \frac{dS(t)}{S(t)}-\delta_3^j(t)-\delta_4^j(t)x\right)
}_{g_{y1}(t,j,x)}\\
& \underbrace{+\sum_{g \neq j} \rho^{jg}(t,x)- \delta_1^j(t)-\delta_2^j(t)x
+ (r(t)-r^*(t)) x }_{g_{y2}(t,j,x)}
\end{align*}
Finally, as $h_y=0$ we have $h_{y1}=h_{y2}=0$.


We write out the differential equation for $\tilde{W}^i$ when $W(t)=(X(t),Y(t))^T$ and the dynamics of $X$ and $Y$ are given by \eqref{eq:AAB}-\eqref{eq:AAC}. Note that $\rho$ can be written as
\begin{align*}
\rho^{jg}(t,x)=&
(b^{jg}(t,x)+ \chi^{jg}(t,x)-x) (\mu^{*jg}(t)-\mu^{jg}(t))
\\
=& 
\bigg( x \frac{b_2^{jg}(t)}{V_2^{j*}(t)} + b_1^{jg}(t) -  \frac{V_1^{j*}(t)}{V_2^{j*}(t)}b_2^{jg}(t)
\\
& + V^{g*}_1(t) + x\frac{V^{g*}_2(t)}{V^{j*}_2(t)}-\frac{V^{j*}_1(t)}{V^{j*}_2(t)}V^{g*}_2(t)-x \bigg) (\mu^{*jg}(t)-\mu^{jg}(t))
\\
=& 
x\underbrace{\bigg(  \frac{b_2^{jg}(t)}{V_2^{j*}(t)} + \frac{V^{g*}_2(t)}{V^{j*}_2(t)}-1 \bigg) (\mu^{*jg}(t)-\mu^{jg}(t))}_{\rho^{jg}_1(t)}
\\
&+
\underbrace{\left( b_1^{jg}(t) -  \frac{V_1^{j*}(t)}{V_2^{j*}(t)}b_2^{jg}(t)
+ V^{g*}_1(t)
-\frac{V^{j*}_1(t)}{V^{j*}_2(t)}V^{g*}_2(t) \right)(\mu^{*jg}(t)-\mu^{jg}(t))}_{\rho^{jg}_2(t)}
\\
=&
\rho_1^{jg}(t)\cdot x+\rho_2^{jg}(t).
\end{align*}
The differential equation for the conditional state-wise values of $X$ are given by
\begin{align*}
\frac{d}{dt}\tilde{X}^i(t)=& \sum_{j \neq i} \mu_{ji}(t) \tilde{X}^j(t)-\mu_{ij}(t)\tilde{X}^i(t)
\\
&+ \tilde{X}^i(t) \Bigg\lbrace 
r^*(t)  +\delta_2^i(t)+\delta_4^i(t)\tilde{Y}^i(t) \\
&+\frac{b^i_2(t)}{V_2^{i*}(t)}
-\sum_{j \neq i} \rho_1^{ij}(t)
-\sum_{j \neq i} \left(\frac{b^{ij}_2(t)}{V_2^{i*}(t)} + \frac{V^{j*}_2(t)}{V^{i*}_2(t)}-1 \right) \mu_{ij}(t)  \Bigg\rbrace
\\
&+
 p_{Z(0)i}(0,t)\Bigg\lbrace 
\delta_1^i(t)
+\delta_3^i(t)\tilde{Y}^i(t)
-b_1^i(t)
-\frac{V_1^{i*}(t)}{V_2^{i*}(t)}b^i_2(t)
-\sum_{j \neq i} \rho_2^{ij}(t)
\\
&- \sum_{j \neq i} \left( b_1^{ij}(t)-\frac{V_1^{i*}(t)}{V_2^{i*}(t)}b^{ij}_2(t) -\frac{V^{i*}_1(t)}{V^{i*}_2(t)}V^{j*}_2(t)+V^{j*}_1(t) \right) \mu_{ij}(t) \Bigg\rbrace
\\
&+
\sum_{j \neq i} \mu_{ji}(t)\Bigg\lbrace
\tilde{X}^j(t)\left( \frac{V^{j*}_2(t)}{V^{i*}_2(t)}-1 \right)
+p_{Z(0)j}(0,t) \left(V^{j*}_1(t) - \frac{V^{i*}_1(t)V^{j*}_2(t)}{V^{i*}_2(t)}\right)
\Bigg\rbrace
\end{align*}

\newpage
\bibliographystyle{plainnat}
\bibliography{BIBS}

\end{document}
