
\documentclass[12pt]{article}
\usepackage[pdfstartview=FitH,hidelinks]{hyperref}
\usepackage[british]{babel}
\usepackage{a4,graphicx}
\usepackage[a4paper, hmargin={2.05cm, 2.05cm}]{geometry} 
\usepackage{amsmath,amssymb,amsthm,mathtools}
\usepackage{anyfontsize}
\usepackage{bbm}
%\usepackage{xypic}
\usepackage[latin1,utf8]{inputenc}
\usepackage{marvosym}
\usepackage{etoolbox}
\usepackage{relsize}
\usepackage{needspace}
\usepackage{nameref}
\usepackage{dsfont}
%\usepackage{thmtools}
%\usepackage{ntheorem}
%\newtheorem{lho}{Sætning}
\usepackage{filecontents}
\usepackage{tikz}
\usetikzlibrary{arrows.meta,positioning,calc}
\usetikzlibrary{matrix}
\usepackage{empheq}

\newcommand*\widefbox[1]{\fbox{\hspace{2em}#1\hspace{2em}}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\B}{\mathcal{B}}
\newcommand{\F}{\mathcal{F}}
\newcommand{\E}{\text{E}}
\newcommand{\cov}{\text{cov}}
\newcommand{\indic}[1]{\mathds{1}_{ \{ #1 \} }}
\newcommand{\unv}[1]{\mathds{1}_{  #1  }}
\newcommand\ddfrac[2]{\frac{\displaystyle #1}{\displaystyle #2}}
\newcommand{\noin}{\noindent}
\newcommand{\Var}{\text{Var}}
\renewcommand{\P}{\text{P}}
\newcommand\independent{\protect\mathpalette{\protect\independenT}{\perp}}
\def\independenT#1#2{\mathrel{\rlap{$#1#2$}\mkern2mu{#1#2}}}
\font\tt=rm-lmtl10



\usepackage{caption}
\usepackage{listings,lstautogobble}
\usepackage{color}
\usepackage{float}
\usepackage{cprotect}
\usepackage[round, comma]{natbib}
\usepackage{csquotes}


\iffalse
\begin{filecontents*}{BIBS.bib}

@article{Djehiche,
issn = {01676687},
abstract = {We suggest a unified approach to claims reserving for life insurance policies with reserve-dependent payments driven by multi-state Markov chains. The associated prospective reserve is formulated as a recursive utility function using the framework of backward stochastic differential equations (BSDE). We show that the prospective reserve satisfies a nonlinear Thiele equation for Markovian BSDEs when the driver is a deterministic function of the reserve and the underlying Markov chain. Aggregation of prospective reserves for large and homogeneous insurance portfolios is considered through mean-field approximations. We show that the corresponding prospective reserve satisfies a BSDE of mean-field type and derive the associated nonlinear Thiele equation. [web URL: http://www.sciencedirect.com/science/article/pii/S0167668715300548]},
journal = {Insurance, Mathematics and Economics},
volume = {69},
publisher = {Elsevier Sequoia S.A.},
year = {2016},
title = {Nonlinear reserving in life insurance: Aggregation and mean-field approximation},
language = {eng},
address = {Amsterdam},
author = {Djehiche, Boualem and Löfdahl, Björn},
keywords = {Studies ; Life Insurance ; Insurance Claims ; Insurance Policies ; Differential Equations ; Stochastic Models ; Life and Health Insurance ; Experiment/Theoretical Treatment},
url = {http://search.proquest.com/docview/1806433652/},
}

@article{Norberg,
journal = {Scand. Actuar. J. 1},
year = {1991},
title = {Reserves in Life and Pension Insurance},
author = {Norberg, Ragnar},
pages={3-24}}

@book{Pardoux,
series = {Stochastic Modelling and Applied Probability},
volume = {69},
publisher = {Springer International Publishing},
isbn = {9783319057132},
year = {2014},
title = {Stochastic Differential Equations, Backward SDEs, Partial Differential Equations},
edition = {2014},
language = {eng},
address = {Cham},
author = {Pardoux, Etienne and Rascanu, Aurel},
keywords = {Mathematics ; Probability Theory and Stochastic Processes ; Partial Differential Equations ; Mathematics},
}

@article{THM_BUC,
issn = {03461238},
abstract = {Within the setup of a semi-Markov process in a finite state space, we consider a life insurance contract. First, without the modelling of policyholder behaviour, we show how to calculate the expected cash flow associated with future payments, and to that end we present a version of Kolmogorov's forward integro-differential equation. The semi-Markov model is then extended to include modelling of surrender and free policy behaviour, and the main result is a modification of Kolmogorov's forward integro-differential equation, such that the cash flow can be calculated without significantly more complexity than the cash flow without policyholder modelling. The result is also demonstrated for the traditional Markov case where there is no duration dependence, and numerical examples are studied.},
journal = {Scandinavian Actuarial Journal},
volume = {2015},
publisher = {Taylor & Francis Ltd.},
number = {8},
year = {2015},
title = {Cash flows and policyholder behaviour in the semi-Markov life insurance setup},
language = {eng},
address = {Stockholm},
author = {Buchardt, Kristian and Møller, Thomas and Schmidt, Kristian},
keywords = {Studies ; Cash Flow ; Markov Analysis ; Life Insurance ; Differential Equations ; Experiment/Theoretical Treatment ; Management Science/Operations Research ; Life & Health Insurance},
url = {http://search.proquest.com/docview/1718994569/},
}


\end{filecontents*}

\fi



\begin{document}

\subsection*{Differential equation for the expected statewise-reserve}
Define
\begin{align*}
\tilde{X}^j(t):=\E_{Z(0)}[X(t)\indic{Z(t)=j}]
\end{align*}
and note that
\begin{align}
\E_{Z(0)}[X(t)\indic{Z(t)=j}]= \E_{Z(0)}[X(t)|Z(t)=j]p_{Z(0),j}(0,t), \label{eq:1}
\end{align}
by the definition of conditional expectation. We can think of $\tilde{X}^j$ as the probability weighted state-wise reserves. The relation between $\tilde{X}^j$ and $\E[X(t)]$ is
\begin{align*}
\E_{Z(0)}[X(t)] =& \E_{Z(0)}[\E_{Z(0)} [ X(t)|Z(t)]] 
\\
=&
\E_{Z(0)} \left[ \sum_{j\in \mathcal{J}} \indic{Z(t)=j} \E_{Z(0)} [ X(t)|Z(t)=j] \right]
\\
=&
\E_{Z(0)} \left[ \sum_{j\in \mathcal{J}} \indic{Z(t)=j} \frac{\E_{Z(0)}[X(t)\indic{Z(t)=j}]}{p_{0j}(0,t)} \right]
\\
=&
\sum_{j\in \mathcal{J}} p_{0j}(0,t) \frac{ \tilde{X}^j}{p_{0j}(0,t)}
\\
=&
\sum_{j\in \mathcal{J}} \tilde{X}^j.
\end{align*}
The dynamics of $X$ are assumed to be affine
\begin{align*}
dX(s)=&X(s)g_1(s,Z(s))ds+g_2(s,Z(s))ds\\
&+\sum_{h\neq Z(s-)} \left( X(s-)h_1(s,Z(s-),h)+ h_2(s,Z(s-),h)\right) dN^h(s).
\end{align*}
Without loss of generality, we can assume that $g_2=h_2=0$, as they do not appear in terms with $X$ and are therefore identical to the problem solved by \citep{Norberg}.
By the tower property,
\begin{align*}
\tilde{X}^j(t)=& \int_0^t \E_{Z(0)}[\indic{Z(t)=j}dX(s)]
\\
=&
\int_0^t \E_{Z(0)}[ \E_{Z(0)}[ \indic{Z(t)=j} dX(s)|Z(s-)]]
\\
=&
\int_0^t \E_{Z(0)} \left[ \sum_{g \in \mathcal{J}} \indic{Z(s-)=g} \E_{Z(0)}[ \indic{Z(t)=j} dX(s)|Z(s-)=g ] \right].
\end{align*}
Consider now the innermost expectation
\begin{align}
&\E_{Z(0)}[ \indic{Z(t)=j} dX(s)|Z(s-)=g ] \nonumber \\
=&
\E_{Z(0)}[ \indic{Z(t)=j} X(s) g_1(s,Z(s))ds|Z(s-)=g] \nonumber
\\
&+ 
\E_{Z(0)} \left[ \indic{Z(t)=j} \sum_{h\neq Z(s-)}  X(s-)h_1(s,Z(s-),h) dN^h(s)|Z(s-)=g \right]\nonumber
\\
=&\E_{Z(0)}[ \indic{Z(t)=j} X(s)|Z(s-)=g]g_1(s,g) ds\label{eq:2}
\\
&+ 
\sum_{h\neq g} \E_{Z(0)}[ \indic{Z(t)=j}   X(s-) dN^h(s)|Z(s-)=g]h_1(s,g,h) \label{eq:3}
\end{align}
and treat the two expectations of \eqref{eq:2}-\eqref{eq:3} separately. Regarding \eqref{eq:2}, note that $X(s)$ given $Z(s-)$ is independent of $\indic{Z(t)=j}$ given $Z(s-)$ and thus
\begin{align}
&\E_{Z(0)}[\indic{Z(t)=j}X(s)|Z(s-)=g] \nonumber
\\
&=\E_{Z(0)}[\indic{Z(t)=j}|Z(s-)=g] \E_{Z(0)}[ X(s)|Z(s-)=g] \label{eq:AAA}
\\
&=p_{gj}(s,t) \frac{\E_{Z(0)}[X(s)\indic{Z(s-)=g}]}{p_{Z(0)g}(0,s)} \nonumber
\\
&=p_{gj}(s,t) \frac{\tilde{X}^g(s)}{p_{Z(0)g}(0,s)} \nonumber,
\end{align}
where we have used \eqref{eq:1} and the Markov property. There is \textbf{NOT} independence between $X$ given $Z(s)$ and $Z(t)$ given $Z(s)$, when the intensities are market dependent through $X$. Then the future state of $Z$ does indeed depend on the past values of $X$. Similarly, regarding \eqref{eq:3}, note that $X(s-)|Z(s-) \independent \indic{Z(t)=j}dN^h(s)|Z(s-	)$ for intensities not depending on $X$, such that 
\begin{align}
&\E_{Z(0)}[ \indic{Z(t)=j}   X(s-) dN^h(s)|Z(s-)=g] \nonumber
\\
=&  \E_{Z(0)}[ X(s-) |Z(s-)=g] \E_{Z(0)}[ \indic{Z(t)=j} dN^h(s)|Z(s-)=g] \label{eq:AAB}
\\
=&
\frac{\E_{Z(0)}[ X(s-) \indic{Z(s-)=g}]}{P(Z(s-)=g|Z(0)=0)}P(Z(t)=j|Z(s-)=g)\E_{Z(0)}[dN^h(s)|Z(s-)=g,Z(t)=j] \nonumber
\\
=&
\frac{\E_{Z(0)}[ X(s-) \indic{Z(s-)=g}]}{p_{Z(0)g}(0,s)}p_{gj}(s,t) \mu^{gh|gj}(s|s,t)\nonumber
\\
\intertext{and by equation (4.12) from \citet{Norberg},}
=&
\frac{\tilde{X}^g(s)}{p_{Z(0)g}(0,s)}p_{gj}(s,t) \mu^{gh}(s)\frac{p_{hj}(s,t)}{p_{gj}(s,t)} \nonumber
\\
=&
\frac{\tilde{X}^g(s)}{p_{Z(0)g}(0,s)} \mu^{gh}(s)p_{hj}(s,t). \nonumber
\end{align}
By insertion into \eqref{eq:2}-\eqref{eq:3} we get
\begin{align*}
&\E_{Z(0)}[ \indic{Z(t)=j} dX(s)|Z(s-)=g ]
\\
=&
p_{g,j}(s,t) \frac{\tilde{X}^g(s)}{p_{Z(0)g}(0,s)} g_1(s,g)ds
+\sum_{h\neq g} \mu^{gh}(s) p_{hj}(s,t) \frac{\tilde{X}^g(s)}{p_{Z(0)g}(0,s)} h_1(s,g,h) ds.
\end{align*}
Conclusively $\tilde{X}^j(t)$ for $j\in\mathcal{J}$ can be described by the integral equations
\begin{align*}
\tilde{X}^j(t)=&
\int_0^t \sum_{g \in \mathcal{J}} p_{Z(0)g}(0,s) 
\bigg(
p_{g,j}(s,t) \frac{\tilde{X}^g(s)}{p_{Z(0)g}(0,s)} g_1(s,g)
+\sum_{h\neq g} \mu^{gh}(s) p_{hj}(s,t) \frac{\tilde{X}^g(s)}{p_{Z(0)g}(0,s)} h_1(s,g,h)
\bigg) ds
\\
=&
\int_0^t \sum_{g \in \mathcal{J}} p_{g,j}(s,t) \tilde{X}^g(s) g_1(s,g)
+\sum_{h\neq g} \mu^{gh}(s) p_{hj}(s,t) \tilde{X}^g(s) h_1(s,g,h) ds
\end{align*}
For ease of notation define
\begin{gather*}
\tilde{b}^g(s):= \tilde{X}^g(s) g_1(s,g)
\qquad 
\tilde{b}^{gh}(s):= \tilde{X}^g(s) h_1(s,g,h).
\end{gather*}
By the Leibniz rule, differentiating wrt. $t$ yields
\begin{align*}
\frac{d}{dt}\tilde{X}^j(t)=&
 \sum_{g \in \mathcal{J}}
p_{g,j}(t,t) \tilde{X}^g(t) g_1(t,g)
+\sum_{h\neq g} \mu^{gh}(t) p_{hj}(t,t) \tilde{X}^g(t) h_1(t,g,h)
\bigg)
\\
&+
\int_0^t \frac{\partial}{\partial t} \bigg( \sum_{g \in \mathcal{J}} 
 p_{g,j}(s,t) \tilde{b}^g(s)
+\sum_{h\neq g} \mu^{gh}(s) p_{hj}(s,t) \tilde{b}^{gh}(s)
\bigg) ds
\\
=&
p_{jj}(t,t) \tilde{X}^j(t) g_1(t,j)
+\sum_{g \neq j} \mu^{gj}(t) p_{jj}(t,t) \tilde{X}^g(t) h_1(t,g,j)
\\
&+
\int_0^t \frac{\partial}{\partial t} \bigg( \sum_{g \in \mathcal{J}} 
 p_{g,j}(s,t) \tilde{b}^g(s)
+\sum_{h\neq g} \mu^{gh}(s) p_{hj}(s,t) \tilde{b}^{gh}(s) \bigg) ds
\\
=&
\tilde{X}^j(t) g_1(t,j) + \sum_{g \neq j} \mu^{gj}(t) \tilde{X}^g(t) h_1(t,g,j)
\\
&+
\int_0^t \frac{\partial}{\partial t} \bigg( \sum_{g \in \mathcal{J}}
 p_{g,j}(s,t) \tilde{b}^g(s)
+\sum_{h\neq g} \mu^{gh}(s) p_{hj}(s,t) \tilde{b}^{gh}(s) \bigg) ds.
\end{align*}
Regarding the integrand, note that
\begin{align*}
&\frac{\partial}{\partial t} \bigg( \sum_{g \in \mathcal{J}}
 p_{g,j}(s,t) \tilde{b}^g(s)
+\sum_{h\neq g} \mu^{gh}(s) p_{hj}(s,t) \tilde{b}^{gh}(s)
\bigg) ds
\\
=&
\sum_{g \in \mathcal{J}}
\frac{\partial}{\partial t} p_{g,j}(s,t) \tilde{b}^g(s)
+\sum_{h\neq g} \mu^{gh}(s) \frac{\partial}{\partial t} p_{hj}(s,t) \tilde{b}^{gh}(s)
ds,
\end{align*}
and by the Kolmogorov forward differential equations,
\begin{align*}
\frac{\partial}{\partial t} p_{i,j}(s,t) = - p_{ij}(s,t) \mu^{j\cdot}(t) +\sum_{h\neq j} p_{ih}(s,t) \mu^{hj}(s),
\end{align*}
we get
\begin{align*}
\frac{\partial}{\partial t} p_{g,j}(s,t) \tilde{b}^g(s) 
=&
 -\mu^{j\cdot}(t) p_{g,j}(s,t) \tilde{b}^g(s) 
\\
&+ \sum_{h\neq j} p_{g,h}(s,t)\mu^{hj}(t)\tilde{b}^g(s)
\intertext{and}
\frac{\partial}{\partial t} p_{hj}(s,t) \tilde{b}^{gh}(s)
=&
 -\mu^{j\cdot}(t) p_{h,j}(s,t) \tilde{b}^{gh}(s) 
\\
&+ \sum_{k\neq j} p_{h,k}(s,t)\mu^{kj}(t)\tilde{b}^{gh}(s).
\end{align*}
Therefore
\begin{align*}
&\int_0^t \sum_{g \in \mathcal{J}} 
\frac{\partial}{\partial t} p_{g,j}(s,t) \tilde{b}^g(s)
+\sum_{h\neq g} \mu^{gh}(s) \frac{\partial}{\partial t} p_{hj}(s,t) \tilde{b}^{gh}(s) ds
\\
=&\int_0^t
\sum_{g \in \mathcal{J}} \sum_{h \neq j} p_{gh}(s,t)\mu^{hj}(t) \tilde{b}^g(s)  -\sum_{h\neq j} \mu^{jh}(t) p_{gj}(s,t)\tilde{b}^g(s)
\\
+&
\sum_{g \in \mathcal{J}}  \sum_{k\neq g} \mu^{gh}(s)
\bigg(
\sum_{k\neq j} p_{hk}(s,t)\mu^{kj}(t) \tilde{b}^{gh}(s)
-\sum_{h\neq j} \mu^{jh}(t) p_{hj}(s,t) \tilde{b}^{gh}(s)
\bigg) ds
\\
=&
\int_0^t\sum_{h\neq j} \mu^{hj}(t)  \sum_{g \in \mathcal{J}} p_{gh}(s,t) \tilde{b}^g(s)
\\
&+
\sum_{h\neq j}\mu^{hj}(t) \bigg( \sum_{g \in \mathcal{J}} \sum_{k \neq g} \mu^{kg}(t) p_{kh}(s,t) \tilde{b}^{gk}(t) \bigg)\\
&-\sum_{h\neq j} \mu^{jh}(t) \sum_{g \in \mathcal{J}}  p_{gj}(s,t) \tilde{b}^g(s)
\\
&-\sum_{h\neq j}\mu^{jh}(t) \bigg( \sum_{g \in \mathcal{J}}\sum_{k \neq g} \mu^{kg}(t) p_{kj}(s,t) \tilde{b}^{gk}(t) \bigg)ds
\displaybreak
\\
=&
\sum_{h\neq j} \mu^{hj}(t) \underbrace{ \int_0^t \sum_{g \in \mathcal{J}} p_{gh}(s,t) \tilde{b}^g(s) + \sum_{k \neq g} \mu^{kg}(t) p_{kh}(s,t) \tilde{b}^{gk}(t)  ds}_{\tilde{X}^h(t)}
\\
&-\sum_{h\neq j} \mu^{jh}(t) \underbrace{\int_0^t \sum_{g \in \mathcal{J}}   p_{gj}(s,t) \tilde{b}^g(s) + \sum_{k \neq g} \mu^{kg}(t) p_{kj}(s,t) \tilde{b}^{gk}(t)  ds}_{\tilde{X}^j(t)}.
\end{align*}
In conclusion
\begin{align*}
\frac{d}{dt}\tilde{X}^j(t)
=&\sum_{g\neq j} \mu^{gj}(t) \tilde{X}^g(t) - \mu^{jg}(t)\tilde{X}^j(t)
\\
&+\tilde{X}^j(t) g_1(t,j) + \sum_{g \neq j} \mu^{gj}(t) \tilde{X}^g(t) h_1(t,g,j),
\\
\tilde{X}^j(0)=& \indic{Z(0)=j}X(0),
\end{align*}
are the ordinary differential equations that satisfy
$$
\tilde{X}^j(t)=\E[X(t)\indic{Z(t)=j}|Z(0),X(0)].
$$
The full differential equation including $g_2$ and $h_2$ is
\begin{subequations}
\begin{empheq}[box=\widefbox]{align*}
\vspace*{2em}
\frac{d}{dt}\tilde{X}^j(t)=&
\sum_{g\neq j} \mu^{gj}(t) \tilde{X}^g(t) - \mu^{jg}(t) \tilde{X}^j(t)
\\
&+ \tilde{X}^j(t) g_1(t,j)+p_{Z(0)j}(0,t) g_2(t,j)
\\
&+ \sum_{g \neq j} \mu^{gj}(t) \left( \tilde{X}^g(t) h_1(t,g,j)+ p_{Z(0)g}(0,t) h_2(t,g,j) \right),
\\
\tilde{X}^j(0)=& \indic{Z(0)=j}X(0).
\vspace{2em}
\end{empheq}
\end{subequations}
Introducing the surplus process $Y$, define
\begin{align*}
\tilde{W}^j(t):=
\begin{pmatrix}
\tilde{X}^j(t) \\
\tilde{Y}^j(t)
\end{pmatrix}
=
\begin{pmatrix}
\E[ X(t) \indic{Z(t)=j}] \\
\E[ Y(t) \indic{Z(t)=j}]
\end{pmatrix}
\end{align*}
With differential equation
\begin{align*}
\frac{d}{dt}\tilde{W}^j(t)=&
\sum_{g\neq j} \mu^{gj}(t) \tilde{W}^g(t) - \mu^{jg}(t) \tilde{W}^j(t)
\\
&+ \tilde{W}^j(t) \circ g_1(t,j,x,y)+p_{0j}(0,t) g_2(t,j)
\\
&+ \sum_{g \neq j} \mu^{gj}(t) \left( \tilde{W}^g(t) \circ h_1(t,g,j,x,y)+ p_{0g}(0,t) h_2(t,g,j) \right),
\\
\tilde{W}^j(0)=&\indic{Z(0)=j} \begin{pmatrix}
X(0)\\
Y(0)
\end{pmatrix},
\end{align*}
where $\circ$ denotes the Hadamard product (element-wise multiplication) and
\begin{gather*}
g_1(t,j,x,y)=\begin{pmatrix}
g_{x1}(t,j,y) \\
g_{y1}(t,j,x)
\end{pmatrix},
\qquad 
\quad
h_1(t,j,g,x,y)=\begin{pmatrix}
h_{x1}(t,j,g,y) \\
h_{y1}(t,j,g,x)
\end{pmatrix},
\\
g_2(t,j)=\begin{pmatrix}
g_{x2}(t,j,y) \\
g_{y2}(t,j,x)
\end{pmatrix},
\qquad 
\quad
h_2(t,j,g)=\begin{pmatrix}
h_{x2}(t,j,g,y) \\
h_{y2}(t,j,g,x)
\end{pmatrix}.
\end{gather*}
For $X$ and $Y$ market dynamics given by
\begin{align*}
dX(t)=&
r^*(t)X(t)dt
 +\delta^{Z(t)}(t,X(t),Y(t))  dt- \sum_{g \neq Z(t-)} \rho^{Z(t-)g}(t,X(t-)) dt
 \nonumber 
\\
\nonumber
&- b^{Z(t)}(t,X(t)) dt
\\
&- \sum_{g\neq Z(t-)}\bigg(b^{Z(t-)g}(t,X(t-))+\chi^{Z(t-)g}(t,X(t-))-X(t-) \bigg) \mu^{Z(t)g}(t)dt
\\
&+ \sum_{g\neq Z(t-)}\bigg(\chi^{Z(t-)g}(t,X(t-))-X(t-) \bigg)  dN^g(t),
\end{align*}
and
\begin{align*}
dY(t)=Y(t)\frac{dS(t)}{S(t)}-\delta^{Z(t)}(t,X(t),Y(t)) + (r(t)-r^*(t)) X(t) + \sum_{g \neq Z(t-)} \rho^{Z(t)g}(t,X(t)),
\end{align*}
where
\begin{align*}
\rho^{jg}(t,x)=&(b^{jg}(t,x)+ \chi^{jg}(t,x)-x) (\mu^{*jg}(t)-\mu^{jg}(t))
\\
\chi^{jg}(t,x)=& V^{g*}_1(t) + \frac{x-V^{j*}_1(t)}{V^{j*}_2(t)}V^{g*}_2(t),
\end{align*}
we have the $g$ and $h$ functions
\begin{align*}
g_x(t,j,x,y)=&r^*(t) x + \delta^j(t,x,y)-b^j(t,x)-\sum_{g \neq j} \rho^{jg}(t,x)
\\
&-\sum_{g \neq j} \left( b^{jg}(t,x)+\chi^{jg}(t,x)-x \right) \mu^{jg}(t)
\\
h_x(t,j,g,x,y)=& \chi^{jg}(t,x)-x
\\
g_y(t,j,x,y)=& y \frac{dS(t)}{S(t)} - \delta^j(t,x,y) + (r(t)-r^*(t)) x + \sum_{g \neq j} \rho^{jg}(t,x) 
\\
h_y(t,j,g,x,y)=& 0.
\end{align*}
Since
\begin{gather*}
b^j(t,x)=b_1^j(t)+\frac{x-V_1^{j*}(t)}{V_2^{j*}(t)}b^j_2(t),
\qquad \quad
b^{jg}(t,x)=b_1^{jg}(t)+\frac{x-V_1^{j*}(t)}{V_2^{j*}(t)}b^{jg}_2(t)
\end{gather*}
are affine in $x$, the $g$ and $h$ functions for $X$ and $Y$ are affine if and only if $\delta$ is affine in $x$ and $y$, that is, $\delta$ can be written on the form
\begin{equation}
\delta^j(t,x,y)=\delta_1^j(t)+\delta_2^j(t)x+\delta_3^j(t)y+\delta_4^j(t)xy. \label{eq:AAE}
\end{equation}
Note that $\rho$ can be written as
\begin{align*}
\rho^{jg}(t,x)=&
(b^{jg}(t,x)+ \chi^{jg}(t,x)-x) (\mu^{*jg}(t)-\mu^{jg}(t))
\\
=& 
\bigg( x \frac{b_2^{jg}(t)}{V_2^{j*}(t)} + b_1^{jg}(t) -  \frac{V_1^{j*}(t)}{V_2^{j*}(t)}b_2^{jg}(t)
\\
& + V^{g*}_1(t) + x\frac{V^{g*}_2(t)}{V^{j*}_2(t)}-\frac{V^{j*}_1(t)}{V^{j*}_2(t)}V^{g*}_2(t)-x \bigg) (\mu^{*jg}(t)-\mu^{jg}(t))
\\
=&
\rho_1^{jg}(t)\cdot x+\rho_2^{jg}(t).
\end{align*}
Assuming \eqref{eq:AAE}, we can identify the eight $g$ and $h$ functions that appear in the differential equation for $\tilde{W}^j$. For $g_x$ we see
\begin{align*}
g_x(t,j,x,y)=&r^*(t) x + \delta^j(t,x,y)-b^j(t,x)-\sum_{g \neq j} \rho^{jg}(t,x)
\\
&-\sum_{g \neq j} \left( b^{jg}(t,x)+\chi^{jg}(t,x)-x \right) \mu^{jg}(t)
\\
=&
r^*(t) x + \delta_1^j(t)+\delta_2^j(t)x+\delta_3^j(t)y+\delta_4^j(t)xy\\
&-b_1^j(t)+\frac{x-V_1^{j*}(t)}{V_2^{j*}(t)}b^j_2(t)
-\sum_{g \neq j} \rho_1^{jg}(t)\cdot x
\\
&-\sum_{g \neq j} \rho_2^{jg}(t)
\\
&-\sum_{g \neq j} \left( b_1^{jg}(t)+\frac{x-V_1^{j*}(t)}{V_2^{j*}(t)}b^{jg}_2(t)+ V^{g*}_1(t) + \frac{x-V^{j*}_1(t)}{V^{j*}_2(t)}V^{g*}_2(t)-x \right) \mu^{jg}(t)
\\
=&
r^*(t) x +\delta_2^j(t)x+\delta_4^j(t)xy\\
&+\frac{b^j_2(t)}{V_2^{j*}(t)}x
-\sum_{g \neq j} \rho_1^{jg}(t)\cdot x
\\
&-\sum_{g \neq j} \left(\frac{b^{jg}_2(t)}{V_2^{j*}(t)}x + \frac{V^{g*}_2(t)}{V^{j*}_2(t)}x-x \right) \mu^{jg}(t)
\\
&-\sum_{g \neq j} \left( b_1^{jg}(t)-\frac{V_1^{j*}(t)}{V_2^{j*}(t)}b^{jg}_2(t) -\frac{V^{j*}_1(t)}{V^{j*}_2(t)}V^{g*}_2(t)+V^{g*}_1(t) \right) \mu^{jg}(t)
\\
&+ \delta_1^j(t)
+\delta_3^j(t)y
-b_1^j(t)
-\frac{V_1^{j*}(t)}{V_2^{j*}(t)}b^j_2(t)
-\sum_{g \neq j} \rho_2^{jg}(t)
\\
=&
\bigg\lbrace 
r^*(t)  +\delta_2^j(t)+\delta_4^j(t)y\\
&+\frac{b^j_2(t)}{V_2^{j*}(t)}
-\sum_{g \neq j} \rho_1^{jg}(t)
-\sum_{g \neq j} \left(\frac{b^{jg}_2(t)}{V_2^{j*}(t)} + \frac{V^{g*}_2(t)}{V^{j*}_2(t)}-1 \right) \mu^{jg}(t)
\bigg\rbrace x
\\
&+ \delta_1^j(t)
+\delta_3^j(t)y
-b_1^j(t)
-\frac{V_1^{j*}(t)}{V_2^{j*}(t)}b^j_2(t)
-\sum_{g \neq j} \rho_2^{jg}(t)
\\
&-\sum_{g \neq j} \left( b_1^{jg}(t)-\frac{V_1^{j*}(t)}{V_2^{j*}(t)}b^{jg}_2(t) -\frac{V^{j*}_1(t)}{V^{j*}_2(t)}V^{g*}_2(t)+V^{g*}_1(t) \right) \mu^{jg}(t).
\end{align*}
Thus
\begin{align*}
g_{x1}(t,j,y)=&r^*(t)  +\delta_2^j(t)+\delta_4^j(t)y\\
&+\frac{b^j_2(t)}{V_2^{j*}(t)}
-\sum_{g \neq j} \rho_1^{jg}(t)
-\sum_{g \neq j} \left(\frac{b^{jg}_2(t)}{V_2^{j*}(t)} + \frac{V^{g*}_2(t)}{V^{j*}_2(t)}-1 \right) \mu^{jg}(t)
\\
g_{x2}(t,j,y)=& \delta_1^j(t)
+\delta_3^j(t)y
-b_1^j(t)
-\frac{V_1^{j*}(t)}{V_2^{j*}(t)}b^j_2(t)
-\sum_{g \neq j} \rho_2^{jg}(t)
\\
&-\sum_{g \neq j} \left( b_1^{jg}(t)-\frac{V_1^{j*}(t)}{V_2^{j*}(t)}b^{jg}_2(t) -\frac{V^{j*}_1(t)}{V^{j*}_2(t)}V^{g*}_2(t)+V^{g*}_1(t) \right) \mu^{jg}(t).
\end{align*}
For $h_x$ we have
\begin{align*}
h_x(t,j,g,x,y)=&\chi^{jg}(t,x) -x
\\
=&
V^{g*}_1(t) + \frac{x-V^{j*}_1(t)}{V^{j*}_2(t)}V^{g*}_2(t) -x
\\
=&
x
\underbrace{\left( \frac{V^{g*}_2(t)}{V^{j*}_2(t)}-1 \right)}_{h_{x1}(t,j,g,y)}+\underbrace{V^{g*}_1(t) - \frac{V^{j*}_1(t)V^{g*}_2(t)}{V^{j*}_2(t)}}_{h_{x2}(t,j,g,y)}.
\end{align*}
For $g_y$ we get
\begin{align*}
g_y(t,j,x,y)=&y \frac{dS(t)}{S(t)} - \delta^j(t,x,y) + (r(t)-r^*(t)) x + \sum_{g \neq j} \rho^{jg}(t,x) 
\\
=&y\frac{dS(t)}{S(t)} - \delta_1^j(t)-\delta_2^j(t)x-\delta_3^j(t)y-\delta_4^j(t)xy
\\
&+ (r(t)-r^*(t)) x
+\sum_{g \neq j} \rho^{jg}(t,x)
\\
=& y \underbrace{\left( \frac{dS(t)}{S(t)}-\delta_3^j(t)-\delta_4^j(t)x\right)
}_{g_{y1}(t,j,x)}\\
& \underbrace{+\sum_{g \neq j} \rho^{jg}(t,x)- \delta_1^j(t)-\delta_2^j(t)x
+ (r(t)-r^*(t)) x }_{g_{y2}(t,j,x)}
\end{align*}
Finally, as $h_y=0$ we have $h_{y1}=h_{y2}=0$.

\section*{Free policy}
How do we deal with the free policy option? Classically the free policy benefits are are duration dependent fraction of the premium paying benefits. To avoid solving a two-dimensional system of differential equations to deal with the duration dependence, the so called lost all trick is used. The trick is to scale the probabilities in the free policy states instead of the payments, which produces the same expected cashflow without the need of calculating duration dependence. We start by proving that the lost all trick works for the retrospective reserve when there are no reserve dependent benefits.
\subsection*{Lost All state (retrospective)}
Denote by the $lost$ subscript, intensities and transition probabilities in the model where there are two transitions from state 0; one to the active free policy state 3, and one to the lost all state 3'. We define the intensities in the lost all model as
\begin{gather*}
\mu^{lk}_\text{lost}(t) = \begin{cases}
\mu^{03}f(t) \quad &\text{for } l=0,k=3 \\
\mu^{03}(1-f(t))  &\text{for } l=0,k=3' \\
\mu^{lk}f(t)  &\text{else},
\end{cases}
\end{gather*}
where $f(t)\in [0,1]$ is the free policy factor. We now prove that
$$
\int_s^t p^{j0}(s,\tau) \mu^{03}(\tau) f(\tau) p^{0k}(\tau,s) d\tau = p_{\text{lost}}^{jk}(s,t)
$$
for $j \in \{ 0,1,2 \}$ and $k \in \{ 3,4,5 \}$, and $p_{\text{lost}}^{jk}(s,t)$ are the transition probabilities in the model including the lost all state. In contrast to the previously seen derivations of this proof, that rely on the Kolmogorov backward differential equations, we prove it using the Kolmogorov forward differential equations.
\begin{align*}
\frac{d}{dt}\int_s^t p^{j0}(s,\tau) &\mu^{03}(\tau) f(\tau) p^{3k}(\tau,t) d\tau\\
=&
p^{j0}(s,t) \mu^{03}(t) f(t) p^{3k}(t,t)
\\
&+
\int_s^t \frac{d}{dt} p^{j0}(s,\tau) \mu^{03}(\tau) f(\tau) p^{3k}(\tau,t) d\tau
\\
=&
p^{j0}(s,t) \mu^{03}(t) f(t) p^{3k}(t,t) 
\\
& - \sum_{l \neq k} \mu^{kl}(t) \int_s^t p^{j0}(s,\tau) \mu^{03}(\tau) f(\tau) p^{3k}(\tau,t)  d\tau
\\
& + \sum_{l \neq k} \mu^{lk}(t) \int_s^t p^{j0}(s,\tau) \mu^{03}(\tau) f(\tau) p^{3l}(\tau,t) d\tau\\
=&
p^{j0}(s,t) \mu^{03}(t) f(t) \indic{k=3}
\\
& - \sum_{l \neq k} \mu^{kl}(t) \int_s^t p^{j0}(s,\tau) \mu^{03}(\tau) f(\tau) p^{3k}(\tau,t)  d\tau
\\
& + \sum_{\substack{ l \in \{3,4,5 \} \\ l \neq k}} \mu^{lk}(t) \int_s^t p^{j0}(s,\tau) \mu^{03}(\tau) f(\tau) p^{3l}(\tau,t) d\tau
\\
&+ \indic{k=3} \mu^{03}(t) \int_s^t p^{j0}(s,\tau) \mu^{03}(\tau) f(\tau) \underbrace{p^{30}(\tau,t)}_{=0} d\tau \\
=&
p^{j0}(s,t) \mu^{03}(t) f(t) \indic{k=3}
\\
& - \sum_{l \neq k} \mu^{kl}(t) \int_s^t p^{j0}(s,\tau) \mu^{03}(\tau) f(\tau) p^{3k}(\tau,t)  d\tau
\\
& + \sum_{\substack{ l \in \{3,4,5 \} \\ l \neq k}} \mu^{lk}(t) \int_s^t p^{j0}(s,\tau) \mu^{03}(\tau) f(\tau) p^{3l}(\tau,t) d\tau.
\end{align*}
Now concerning $p_{\text{lost}}^{jk}(s,t)$, note that $ p_{\text{lost}}^{j0}(s,t)=p^{j0}(s,t)$ as $\mu_{\text{lost}}^{0\cdot}(t)=\mu^{0\cdot}(t)$. And that all intensities are identical $\mu_{\text{lost}}^{lk}(t)=\mu^{lk}(t)$ for $k\neq 3$. By the Kolmogorov forward differential equations
\begin{align*}
\frac{d}{dt} p_{\text{lost}}^{jk}(s,t) =& \sum_{l \neq k} \mu^{lk}_{\text{lost}}(t) p_{\text{lost}}^{jl}(s,t) -\mu^{kl}_{\text{lost}}(t) p_{\text{lost}}^{jk}(s,t) 
\\
=&
\sum_{l \neq k} \mu^{lk}_{\text{lost}}(t) p_{\text{lost}}^{jl}(s,t)
\\
&-\sum_{l \neq k} \mu^{kl}_{\text{lost}}(t) p_{\text{lost}}^{jk}(s,t) \\
=&
\sum_{\substack{ l \in \{3,4,5 \} \\ l \neq k}} \mu^{lk}(t) p_{\text{lost}}^{jl}(s,t)
\\
&-\sum_{l \neq k} \mu^{kl}(t) p_{\text{lost}}^{jk}(s,t) 
\\
&+ \indic{k=3} \mu^{03}_{\text{lost}}(t) p_{\text{lost}}^{j0}(s,t) \\
&+ \indic{k=3'}\mu^{03'}_{\text{lost}}(t) p_{\text{lost}}^{j0}(s,t).
\intertext{As the transition probabilities within the premium paying states are the same with and without the lost all state, and we only consider $k\neq 3'$ we get}
\frac{d}{dt} p_{\text{lost}}^{jk}(s,t) =&
 p^{j0}(s,t) \mu^{03}(t)f(t) \indic{k=3}
\\
&-\sum_{l \neq k} \mu^{kl}(t) p_{\text{lost}}^{jk}(s,t) 
\\
&+\sum_{\substack{ l \in \{3,4,5 \} \\ l \neq k}} \mu^{lk}(t) p_{\text{lost}}^{jl}(s,t).
\end{align*}
Since the two differential equations are the same, and the boundary condition at $s=t$ is zero, the two quantities are the same. This implies that we may use the probabilities from the lost all model to calculate the cashflow in the regular model, and thus correctly account for duration dependence in the free policy states. This result is certainly useful if we wanted to consider the retrospective reserves without reserve dependent benefits, however, as we are interested in retrospective reserves with reserve dependent benefits, we may not be able to simply use the probabilities from the lost all model to calculate $\tilde{X}^j$ - only if the non-reserve-dependent benefits are the only scaled benefits (which may be the case). Even with scaled reserve dependent benefits it is a strong result, as we may approximate the reserve dependent benefits with benefits that depend on the \textit{expected reserve} which is deterministic. Furthermore, if the free policy scaling only influences the terms of the dynamics of $X$ that are independent of $X$, we may use the lost-all trick. Simply replace $p_{0j}(0,t)$ and $p_{0g}(0,t)$ in the differential equation for $\tilde{X}^j$ with the corresponding lost-all probabilities $p^\text{lost}_{0j}(0,t)$ and $p^\text{lost}_{0g}(0,t)$.

\subsection*{Scaled non-reserve-dependent benefits}
Consider the dynamics of $X$ given by
\begin{align*}
dX(s)=&X(s)g_1(s,Z(s))ds+g_2(s,Z(s))ds +  \indic{Z(s)\in \mathbb{F}} f(s-U(s)) g_3(s,Z(s))ds \\
&+
\sum_{h\neq Z(s-)} \left( X(s-)h_1(s,Z(s-),h)+ h_2(s,Z(s-),h) + \right) dN^h(s)
\\
&+
\sum_{h\neq Z(s-)} \left(  \indic{Z(s)\in \mathbb{F}} f(s-U(s))h_3(s,Z(s-),h)\right) dN^h(s) ,
\end{align*}
corresponding to a case where some/all/none of the non-reserve-dependent dynamics are duration dependent. This is for instance the case when only the $B_1$ cashflow is scaled upon transition to free policy. The extra terms compared to the case without duration dependence are
\begin{gather}
\E_{Z(0)} [ \indic{Z(s) \in \mathbb{F}} \indic{Z(t)=j} g_3(s,Z(s-)) f(s-U(s))|Z(s-)=g] \label{eq:AAI}
\intertext{and}
\sum_{h \neq g} \E_{Z(0)} [ \indic{Z(s) \in \mathbb{F}} \indic{Z(t)=j} h_3(s,Z(s-),h) dN^h(s) f(s-U(s))|Z(s-)=g]
\label{eq:AAJ}
\end{gather}
Commencing with \eqref{eq:AAI},
\begin{align*}
&\E_{Z(0)} [ \indic{Z(s) \in \mathbb{F}} \indic{Z(t)=j} g_3(s,Z(s-)) f(s-U(s))|Z(s-)=g]
\\
&= \E_{Z(0)} [  \indic{Z(t)=j} f(s-U(s))|Z(s-)=g] \indic{g \in \mathbb{F}} g_3(s,g)
\intertext{and by \eqref{eq:1} we get}
&= \E_{Z(0)} [ f(s-U(s))|Z(s-)=g, Z(t)=j] P(Z(t)=j|Z(s-)=g,Z(0)=0) \indic{g \in \mathbb{F}} g_3(s,g)
\\
&= \E_{Z(0)} [ f(s-U(s))|Z(s-)=g, Z(t)=j] p_{gj}(s,t) \indic{g \in \mathbb{F}} g_3(s,g).
\end{align*}
Because of the indicator function $\indic{g \in \mathbb{F}}$ and $p_{gj}(s,t)=0$ for $j\notin \mathbb{F}$, the only interesting values of $g$ and $j$ are the ones where both $g$ and $j$ are free policy states. When calculating the expected free policy factor at time $s$ given $Z(s-)=g$, then $Z(t)=j$ provides no extra information. We can disregard the condition on $Z(t)$ as $f(s-U(s))$ only depends on $Z(s-)$ by the Markov property. In other words, $U(s)$ given $Z(s-) \in \mathbb{F}$ is independent of $Z(t)$ for $s<t$. Therefore
\begin{align*}
&\E_{Z(0)} [ f(s-U(s))|Z(s-)=g, Z(t)=j] p_{gj}(s,t) \indic{g \in \mathbb{F}} g_3(s,g)
\\
&=
\E_{Z(0)} [ f(s-U(s))|Z(s-)=g] p_{gj}(s,t) \indic{g \in \mathbb{F}} g_3(s,g)
\\
&=
\E[ \indic{Z(s-)=g} f(s-U(s))|Z(0)] \frac{p_{gj}(s,t)}{p_{Z(0)g}(0,s)} \indic{g \in \mathbb{F}} g_3(s,g)
\\
&= g_3(s,g) \frac{p_{gj}(s,t)}{p_{Z(0)g}(0,s)} \indic{g \in \mathbb{F}} \int_0^s f(\tau) E[\indic{Z(s-)=g}|Z(0),s-U(s)=\tau] dP(s-U(s)\leq \tau | Z(0)).
\end{align*}
Perfoming the same calculations as in section A.2 of \citet{THM_BUC} we get
\begin{align*}
g_3(s,g)\frac{p_{gj}(s,t)}{p_{Z(0)g}(0,s)} \indic{g \in \mathbb{F}} \int_0^s f(\tau) E[\indic{Z(s-)=g}|Z(0),s-U(s)=\tau] dP(s-U(s)\leq \tau | Z(0))
\\
=
g_3(s,g)\frac{p_{gj}(s,t)}{p_{Z(0)g}(0,s)} \indic{g \in \mathbb{F}} \int_0^s p_{Z(0)0}(0,\tau) \mu_{03}(\tau) f(\tau) p_{3g}(\tau,s) d\tau,
\end{align*}
and since we have proved that
$$
\int_0^s p_{j0}(0,\tau) \mu^{03}(\tau) f(\tau) p_{0g}(\tau,s) d\tau = p^{\text{lost}}_{jg}(0,s),
$$
we have
\begin{align*}
\E_{Z(0)} [ \indic{Z(s) \in \mathbb{F}} \indic{Z(t)=j} g_3(s,Z(s-)) f(s-U(s))|Z(s-)=g]
=
\frac{p^{\text{lost}}_{Z(0)g}(0,s)}{p_{Z(0)g}(0,s)} \indic{g \in \mathbb{F}} p_{gj}(s,t)g_3(s,g).
\end{align*}
Now, consider \eqref{eq:AAJ}
\begin{align*}
\E_{Z(0)} [  \indic{Z(t)=j}  dN^h(s) f(s-U(s))|Z(s-)=g] h_3(s,g,h) \indic{g \in \mathbb{F}}.
\end{align*}
Note that $U(s)|Z(s-) \independent \indic{Z(t)=j}dN^h(s)|Z(s-)$ \textbf{OBS!} Use same argument to prove \eqref{eq:AAI}.
\begin{align*}
\E_{Z(0)}[f(s-U(s))|Z(s-)=g] \E[ \indic{Z(t)=j}dN^h(s) |Z(s-)=g] h_3(s,g,h) \indic{g \in \mathbb{F}}.
\\
=\frac{p_{0g}^\text{lost}(0,s)}{p_{0g}(0,s)} p_{hj}(s,t) \mu_{gh}(s) h_3(s,g,h) \indic{g \in \mathbb{F}}.
\end{align*}
Performing the same procedure as in the case without duration dependence brings us to the differential equation for
$$
\tilde{X}^j(t)=\E[X(t)\indic{Z(t)=j}|Z(0),X(0)].
$$
given by
\begin{subequations}
\begin{empheq}[box=\widefbox]{align*}
\vspace*{2em}
\frac{d}{dt}\tilde{X}^j(t)=&
\sum_{g\neq j} \mu^{gj}(t) \tilde{X}^g(t) - \mu^{jg}(t) \tilde{X}^j(t)
\\
&+ \tilde{X}^j(t) g_1(t,j)+p_{Z(0)j}(0,t) g_2(t,j)+p^\text{lost}_{Z(0)j}(0,t)g_3(t,j) \indic{j \in \mathbb{F}}
\\
&+ \sum_{g \neq j} \mu^{gj}(t) \left( \tilde{X}^g(t) h_1(t,g,j)+ p_{Z(0)g}(0,t) h_2(t,g,j) \right)
\\
&+
\sum_{g \neq j} \mu^{gj}(t) p^\text{lost}_{Z(0)g}(0,t) h_3(t,g,j)   \indic{g \in \mathbb{F}}
\\
\tilde{X}^j(0)=& \indic{Z(0)=j}X(0).
\vspace{2em}
\end{empheq}
\end{subequations}





\subsection*{Free policy factor with reserve dependent benefits}
We are interested in the differential equation for $\E_{Z(0)}[X(t)\indic{Z(t)=j}]$, now with
$$
X(t)=\int_{[0,t-U(t))} dX_P(s)+\int_{[t-U(t),t)} dX_F(s,U(t)),
$$
where $dX_P$ denotes the dynamics in the premium paying states and $dX_F(s,U(t))$ denotes the dynamics in the free policy states given a duration of $U(t)$ at time $t$. We intend to write the dynamics of $X$ in the free policy states as a function that is affine in the free policy factor. We now discuss how to determine the free policy factor. As stated by \citet{THM_BUC}
\begin{quote}
The free policy factor $f(t)$ should be deterministic and is usually chosen according to the equivalence principle on the technical basis: the prospective reserve for the technical basis should not change as a consequence of the exercise of the free policy option. \newline $\sim$ \citet{THM_BUC}
\end{quote}
Resulting in the free policy factor
$$
V^{0*}(t)=f(t)V^{0+*}(t) \Leftrightarrow f(t)=\frac{V^{0*}(t)}{V^{0+*}(t)}.
$$
In contrast to \citet{THM_BUC}, we should include information about the retrospective reserve, and the extra benefits that have been purchased for the accrued dividends, and thus also allow for a non-deterministic free policy factor. We (mis)use the notation $f(t)$ for the possibly stochastic process $f$. One idea is to define it as the current reserve relative to the current reserve including expected future premiums
\begin{align}
f(t)=\frac{X(t)}{X(t)-V^{0-*}(t)} \label{eq:AAH}
\end{align}
which resembles the classical definition as $V^{0+*}(t)=V^{0*}(t)-V^{0-*}(t) \approx X(t) - V^{0-*}(t)$. However, we are dealing with two types of reserves, and this formulation does not specify which role each reserve plays (even though we think of premiums as being part of $B_1$). 
Instead we could, motivated by the formulation in \citet{THM_BUC}, require that the prospective reserve on the technical basis does not change as a consequence of the exercise of the free policy option, given the guaranteed benefits evaluated at time $t$. Whatever benefits you have been guaranteed in the premium paying states, are now scaled by a time-dependent factor $f(t)$. Contrary to the set-up of \citet{THM_BUC}, we also have to account for the extra benefits, $B_2$, that can be bought for whatever is not spent on $B_1$. Formally we require that $f(t)$ solves
\begin{gather*}
\E^*_{t,x} \left[ \int_t^n e^{-\int_t^sr^*} \left( dB_1(s) + \frac{x-V_1^{0*}(t)}{V_2^{0*}(t)} dB_2(s) \right)  \right]
\\
=
\\
\E^*_{t,x} \left[ \int_t^n e^{-\int_t^sr^*} f(t) \left( dB_1^+(s) + \frac{x-V_1^{0+*}(t)f(t)}{V_2^{0+*}(t)f(t)} dB_2^+(s) \right)  \right]
\\
\Leftrightarrow
\\
X(t)=X(t)
\end{gather*}
implying that the prospective reserve on the technical basis never changes as a consequence of the free policy option, no matter how the free policy factor is chosen. This is because any reserve changes are absorbed in how much of the $B_2$ contract is bought. Say for instance that $f(t)=1$, then $x-V_1^{0+*}(t)f(t)$ will become negative if $V_1^{0-*}(t)<0$, and thus the \textbf{insured} will simply sell $B_2$ to the insurer. This construction is viable in the mathematical set-up we have constructed, in the real world however, premiums in the free policy states are not allowed for. Therefore $f$ should instead be chosen such that $P(X(t)-V_1^{0+*}(t)f(t)<0)$ is small, while maintaining a ratio between the benefits of $B_1$ and $B_2$ that for the policyholder is desired. We propose
\begin{gather*}
\E^*_{t,x} \left[ \int_t^n e^{-\int_t^sr^*} \left( dB_1(s) + \frac{x-V_1^{0*}(t)}{V_2^{0*}(t)} dB_2(s) \right)  \right]
\\
=
\\
\E^*_{t,x} \left[ \int_t^n e^{-\int_t^sr^*} f(t) \left( dB_1^+(s) + \frac{x-V_1^{0*}(t)}{V_2^{0*}(t)} dB_2^+(s) \right)  \right],
\end{gather*}
which is equivalent to
\begin{gather}
X(t)=f(t)V_1^{0+*}(t)+\frac{X(t)-V_1^{0*}(t)}{V_2^{0*}(t)}f(t)V_2^{0+*}(t)
\nonumber \\
\Leftrightarrow
\nonumber \\
X(t)=f(t) \left( V_1^{0+*}(t)+\frac{X(t)-V_1^{0*}(t)}{V_2^{0*}(t)}V_2^{0+*}(t)\right)
\nonumber \\
\Leftrightarrow
\nonumber \\
f(t)=\ddfrac{X(t)V_2^{0*}(t)}{V_1^{0+*}(t)V_2^{0*}(t)+(X(t)-V_1^{0*}(t))V_2^{0+*}(t) }.\label{eq:AAF}
\end{gather}
Note, as a special case when $X(t)=V_1^{0*}(t)$, which is the case when dividends equal the risk premiums, we get the classical formulation,
$$
f(t)=\ddfrac{V_1^{0*}(t)V_2^{0*}(t)}{V_1^{0+*}(t)V_2^{0*}(t)}=\ddfrac{V_1^{0*}(t)}{V_1^{0+*}(t)}.
$$
Furthermore, if $V_2^{0+*}(t)=V_2^{0*}(t)$, which is very reasonable to assume, then
$$
f(t)=\ddfrac{X(t)}{V_1^{0+*}(t)+X(t)-V_1^{0+*}(t)-V_1^{0-*}(t)}=\ddfrac{X(t)}{X(t)-V_1^{0-*}(t)},
$$
closely resembling \eqref{eq:AAH}. An important note, is that $f(t)$ is not linear in $X$, which may have a large influence on the implementation of the lost all trick, as the intensity
$$
\mu^{03}(t)f(t)
$$
now depends non-linearly on the value of $X$. 
\\
Another suggestion on the choice of free policy factor, is to scale the benefits related to the $B_1$ cashflow only. Formally
\begin{gather*}
\E^*_{t,x} \left[ \int_t^n e^{-\int_t^sr^*} \left( dB_1(s) + \frac{x-V_1^{0*}(t)}{V_2^{0*}(t)} dB_2(s) \right)  \right]
\\
=
\\
\E^*_{t,x} \left[ \int_t^n e^{-\int_t^sr^*}  \left( f(t) dB_1^+(s) + \frac{x-V_1^{0*}(t)}{V_2^{0*}(t)} dB_2^+(s) \right)  \right],
\end{gather*}
which is equivalent to
\begin{gather}
X(t)=f(t)V_1^{0+*}(t)+\frac{X(t)-V_1^{0*}(t)}{V_2^{0*}(t)}V_2^{0+*}(t)
\nonumber
\\
\nonumber
\Leftrightarrow
\\
\nonumber
X(t) \left( 1-\frac{V_2^{0+*}(t)}{V_2^{0*}(t)} \right) +\frac{V_1^{0*}(t)V_2^{0+*}(t)}{V_2^{0*}(t)} =f(t)V_1^{0+*}(t)
\\
\nonumber
\Leftrightarrow
\\
f(t)= \frac{X(t)}{V_1^{0+*}(t)} \left( 1-\frac{V_2^{0+*}(t)}{V_2^{0*}(t)} \right) +\frac{V_1^{0*}(t)V_2^{0+*}(t)}{V_2^{0*}(t)V_1^{0+*}(t)}  .\label{eq:AAG}
\end{gather}
Note that if $V_2^{0+*}(t)=V_2^{0*}(t)$, again we arrive at
$$
f(t)=\ddfrac{V_1^{0*}(t)}{V_1^{0+*}(t)},
$$
and for for $X(t)=V_1^{0*}(t)$,
\begin{align*}
f(t)=& \frac{X(t)}{V_1^{0+*}(t)} \left( 1-\frac{V_2^{0+*}(t)}{V_2^{0*}(t)} \right) +\frac{V_1^{0*}(t)V_2^{0+*}(t)}{V_2^{0*}(t)V_1^{0+*}(t)}
\\
=&\frac{V_1^{0*}(t)}{V_1^{0+*}(t)} -\frac{V_1^{0*}(t)V_2^{0+*}(t)}{V_1^{0+*}(t)V_2^{0*}(t)}  +\frac{V_1^{0*}(t)V_2^{0+*}(t)}{V_2^{0*}(t)V_1^{0+*}(t)}
\\
=&
\ddfrac{V_1^{0*}(t)}{V_1^{0+*}(t)}.
\end{align*}
Furthermore this formulation of $f$ is linear in $X$, which may prove to be useful. The two formulations of $f$ given in \eqref{eq:AAF} and \eqref{eq:AAG} depend on what has been agreed upon with the policyholder, concerning the bonus payments $B_2$. Do they scale relative to the reserve, or are they scaled like $B_1$.
\\
 We would like $$
f(t)=\ddfrac{V_1^{0*}(t)}{V_1^{0+*}(t)}.
$$
A compelling argument to choose the usual free policy factor, is that the policyholder signs a contract based on the technical basis, where there is no bonus i.e they are under the belief that $X(t)=V_1^{0*}(t)$. Note that in the real world, the $B_2$ benefits that have been bought cannot be sold back to the insurer, and may only be scaled on transition to free policy.


\begin{itemize}
\item The problem is that we have stochastic benefits that depend on the duration via the value of the reserve, and not only the free policy factor, therefore we cannot separate benefits and probabilities in lost-all model. We cannot write
\begin{align*}
&\int_0^s f(\tau) \E[ \indic{Z(t)=j}X(s)|Z(0),Z(s-)=g,s-U(s)=\tau] dP(s-U(s)\leq \tau| Z(0),Z(s-)=g)
\\
=&\int_0^s f(\tau) \hat{X}^j(s)  p_{Z(0)0}(0,\tau) \mu^{03}(\tau) p_{3g}(\tau,s) d\tau
\\
= &\hat{X}^j(s)\int_0^s f(\tau)  p_{Z(0)0}(0,\tau) \mu^{03}(\tau) p_{3g}(\tau,s) d\tau,
\end{align*}
for some quantity $\hat{X}^j(t)=\E[ \indic{Z(t)=j}X(s)|Z(0),Z(s-)=g,s-U(s)=\tau]$, since $\hat{X}^j$ also will depend on the duration.
\item What if, on transition to free policy, we only include the benefits and do not scale them,
$$
b^3(t,x)=\frac{X(t)}{V_1^{0+*}(t)}b_1^{0+}(t).
$$
In a sense corresponding to paying out as much of the benefits as possible. Note that for $b_1^+=b_2^+$, and any choice of free policy factor we have
\begin{align*}
b^3(t,x,u)=&f(t-u)b_1^{0+}(t)+\frac{X(t)-V_1^{0+*}(t)f(t-u)}{V_2^{0+*}(t)f(t-u)} f(t-u)b_2^{0+}(t)
\\
=& b_2^{0+}(t) \left( f(t-u) +\frac{X(t)}{V_2^{0+*}(t)} -\frac{V_1^{0+*}(t)f(t-u)}{V_2^{0+*}(t)} \right)
\\
=& b_2^{0+}(t) \left( f(t-u) +\frac{X(t)}{V_2^{0+*}(t)} -f(t-u) \right)
\\
=& b_2^{0+}(t) \frac{X(t)}{V_2^{0+*}(t)},
\end{align*}
which does not depend on $u$. Similarly, for $b_1^+=0$, implying that $B_1$ purely concerns premiums,
\begin{align*}
b^3(t,x,u)=&f(t-u)b_1^{0+}(t)+\frac{X(t)-V_1^{0+*}(t)f(t-u)}{V_2^{0+*}(t)f(t-u)} f(t-u)b_2^{0+}(t)
\\
=& \frac{X(t)}{V_2^{0+*}(t)f(t-u)} f(t-u)b_2^{0+}(t)
\\
=& b_2^{0+}(t) \frac{X(t)}{V_2^{0+*}(t)} .
\end{align*}
\item How about keeping the free policy factor unchanged? Any extra benefits that may have been bought, will simply be bought again. Furthermore, under the technical basis (with zero surplus at time zero) the dynamics of $X$ will simply be those of $V_1$.
\item We can choose any free policy factor, and it will not make any difference, as we simply scale $B_2$. The problem is guarantees. If for instance the policy always has a death sum of 10, the un-guaranteed benefits should be scaled to ensure that the death sum can be paid out. What if there are no other benefits? How do we deal with guarantees in the active states?
\end{itemize}

\subsection*{$\tilde{X}^j$ including free policy factor}
Denote by $\mathbb{F}$ the subspace of $\mathcal{J}$ consisting of all the free policy states. Define
$$
U(t)=\inf \{ s \geq 0 | Z(t-s) \in \mathbb{F} \}
$$
and
$$
\hat{X}^j(t,\tau)=\E_{Z(0)}[ \indic{Z(t)=j}X(t)|t-U(t)=\tau].
$$
Note that we allow for negative values of $U(t)$, implying that it is not $\mathcal{F}_t$-measurable. Note that for $j \notin \mathbb{F}$ we have $U(t)=0$ implying that $\E_{Z(0)}[ \indic{Z(t)=j}X(t)|t-0=t]=\tilde{X}^j(t)$, for which we have the differential equation derived in the first section. In this section, we are thus only concerned with $\hat{X}^j$ for $j \in \{3,4,5 \}$. If we are to use the lost-all trick it is a necessary condition that
$$
\tilde{X}^{j+}(t)f(\tau)=\hat{X}^j(t,\tau),
$$
if we want the expected benefits with and without the lost all state to be identical. By the $+$ superscript on $\tilde{X}^{j+}$ we mean the lost-nothing state $j$.
\\
Sketch of proof: We require that the benefits in the free policy states
$$
\E[b^j(t,X(t))|t-U(t)=\tau]
$$
are unaffected by the introduction of the lost all state, that is,
\begin{gather*}
\E[b^j(t,X(t))|t-U(t)=\tau]=f(\tau)b_1^{j+}(t)+ \frac{\hat{X}^j(t,\tau) - V_1^{j+*}(t)f(\tau)}{V_2^{j+*}(t)}b_2^{j+}(t)
\intertext{should be equal to}
\frac{ \left( b_1^{j+}(t)+ \frac{\hat{X}^{j+}(t) - V_1^{j+*}(t)}{V_2^{j+*}(t)}b_2^{j+}(t)\right) p_j^+(t)}{p_j^+(t)+p_j^0(t)},
\intertext{which is equivalent to}
\frac{\hat{X}^j(t,\tau)}{f(\tau)}=\hat{X}^{j+}(t)
\end{gather*}
as 
$$
\frac{p_{3j}^+(\tau,t)}{p_{3j}^+(\tau,t)+p_{3j}^0(\tau,t)}=f(\tau).
$$
We require that for all durations, there is a constant relation between the regular retrospective reserve, and the lost-nothing retrospective reserve. This stands in contrast to the classical requirement when dealing with prospective reserves, where it is only required that on the moment of transition, the free policy reserve should be a factor of the non-free policy reserve. Written in different notation, we require
$$
\E[X(t) \indic{Z(t)=j} | U(t)=u]= f(t-u) E[X^+(t)\indic{Z(t)=j}]
$$
\subsection*{Differential equation for $\tilde{X}^j(t,\tau)$}
Let the dynamics of $X$ be given by
\begin{align*}
dX(s)=& \indic{Z(s) \notin \mathbb{F} } X(s)g_1(s,Z(s)) ds 
\\
+ & \indic{Z(s) \in \mathbb{F} }   X(s) g_1^+(s,Z(s)) f(s-U(s)) ds,
\end{align*}
which is an oversimplification of the dynamics, but notationally convenient. By the tower property we get
\begin{align*}
\hat{X}^j(t,\tau)=& \E_{Z(0)}[ \indic{Z(t)=j}X(t)|t-U(t)=\tau] \\
=& \int_0^{\tau} \E_{Z(0)}[  \indic{Z(t)=j} dX(s)|t-U(t)=\tau] \\
&+  \int_{\tau}^t \E_{Z(0)}[ \indic{Z(t)=j} dX(s)|t-U(t)=\tau]
\\
=& \int_0^{\tau} \sum_{g \in \mathcal{J}} P(Z(s)=g|Z(0),t-U(t)=\tau) \E_{Z(0)}[  \indic{Z(t)=j} dX(s)|Z(s)=g,t-U(t)=\tau] \\
&+  \int_{\tau}^t \sum_{g \in \mathcal{J}} P(Z(s)=g|Z(0),t-U(t)=\tau) \E_{Z(0)}[ \indic{Z(t)=j} dX(s)|Z(s)=g, t-U(t)=\tau]
\end{align*}
Only the states from which there is a path to $\mathbb{F}$, the possibility of being in that state at time $s<\tau$ is positive. As there is no way to re-enter the premium paying states, we can also conclude that after transition, the state process will stay in $\mathbb{F}$, and so
\begin{align*}
\hat{X}^j(t,\tau)=& \int_0^{\tau} \sum_{g \in \{0,1\} } P(Z(s)=g|Z(0),t-U(t)=\tau) \E_{Z(0)}[  \indic{Z(t)=j} dX(s)|Z(s)=g,t-U(t)=\tau] \\
&+  \int_{\tau}^t \sum_{g \in \mathbb{F}} P(Z(s)=g|Z(0),t-U(t)=\tau) \E_{Z(0)}[ \indic{Z(t)=j} dX(s)|Z(s)=g, t-U(t)=\tau].
\end{align*}
Note that 
$$
dX(s)= \begin{cases}
X(s)g_1(s,Z(s)) ds \qquad &\text{ for } s < \tau \\
f(s-U(s)) X(s)g_1^+(s,Z(s))  ds &\text{ for } s \geq \tau,
\end{cases}
$$
and that $Z(t)|Z(s),U(t) \independent  X(s)|Z(s),U(t)$. We see that
\begin{align*}
E_{Z(0)}[ X(s)|Z(s)=g,t-U(t)=\tau] =& 
\frac{E_{Z(0)}[ X(s)\indic{Z(s)=g}|t-U(t)=\tau]}{P(Z(s)=g|Z(0),t-U(t)=\tau)}
\\
=&\frac{ \hat{X}^g(s,\tau)}{P(Z(s)=g|Z(0),t-U(t)=\tau)},
\end{align*}
therefore
\begin{align*}
\hat{X}^j(t,\tau)=& \int_0^{\tau} \sum_{g \in \{ 0, 1\} }  
P(Z(t)=j |Z(0),Z(s)=g, t-U(t)=\tau) \hat{X}^g(s,\tau) g_1(s,g) \\
&+ f(\tau)  \int_{\tau}^t \sum_{g \in \mathbb{F}} 
P(Z(t)=j |Z(0),Z(s)=g, t-U(t)=\tau) \hat{X}^g(s,\tau) g_1^+(s,g).
\end{align*}
By the Markov property we see that
\begin{align*}
& P(Z(t)=j |Z(0),Z(s)=g, t-U(t)=\tau)\\
=
&\frac{P(Z(t)=j,Z(0),Z(s)=g,t-U(t)=\tau)}{P(Z(0),Z(s)=g,t-U(t)=\tau)} 
\\
=&
\begin{dcases}
p_{3j}(\tau,t) \qquad &\text{ for } s < \tau \\
p_{gj}(s,t) &\text{ for } s \geq \tau,
\end{dcases}
\end{align*}
such that
\begin{align*}
\hat{X}^j(t,\tau)=& \int_0^{\tau} \sum_{g \in \{0, 1\} }  
p_{3j}(\tau,t) \hat{X}^g(s,\tau) g_1(s,g) \\
&+ f(\tau)  \int_{\tau}^t \sum_{g \in \mathbb{F}} 
p_{gj}(s,t) \hat{X}^g(s,\tau) g_1^+(s,g)
\\
=&
p_{3j}(\tau,t) 
\int_0^{\tau} \sum_{g \in \{0 , 1\}}   \hat{X}^g(s,\tau) g_1(s,g) ds \\
&+ f(\tau)  \int_{\tau}^t \sum_{g \in \mathbb{F}} 
p_{gj}(s,t) \hat{X}^g(s,\tau) g_1^+(s,g) ds
\end{align*}
To calculate $\hat{X}^j$ we need a partial differential equation. Differentiating w.r.t $t$ and $\tau$ yields
\begin{align}
\frac{\partial}{\partial t}\hat{X}^j(t,\tau)+ \frac{\partial}{\partial \tau}\hat{X}^j(t,\tau)=
&\sum_{g \in \{0 , 1\}}  
\frac{\partial}{\partial t} p_{3j}(\tau,t) 
\int_0^{\tau}  \hat{X}^g(s,\tau) g_1(s,g) ds \nonumber \\
&+ f(\tau)  \frac{\partial}{\partial t} \int_{\tau}^t \sum_{g \in \mathbb{F}} 
p_{gj}(s,t) \hat{X}^g(s,\tau) g_1^+(s,g)  ds
\nonumber \\
&+ \frac{\partial}{\partial \tau} \left( \sum_{g \in \{0 , 1\}}  
p_{3j}(\tau,t) 
\int_0^{\tau}  \hat{X}^g(s,\tau) g_1(s,g) ds \right) \nonumber \\
&+
\frac{\partial}{\partial \tau}  \left( f(\tau)  \int_{\tau}^t \sum_{g \in \mathbb{F}} 
p_{gj}(s,t) \hat{X}^g(s,\tau) g_1^+(s,g) ds \right)
\nonumber \\
=&
\label{eq_diff:1}
\frac{\partial}{\partial t} p_{3j}(\tau,t) 
\int_0^{\tau} \sum_{g \in \{0 , 1\}} \hat{X}^g(s,\tau) g_1(s,g) ds \\
&+
\label{eq_diff:2}
f(\tau)  \frac{\partial}{\partial t} \int_{\tau}^t \sum_{g \in \mathbb{F}} 
p_{gj}(s,t) \hat{X}^g(s,\tau) g_1^+(s,g)  ds
\\
&
\label{eq_diff:3}
+  
\frac{\partial}{\partial \tau}  p_{3j}(\tau,t) 
\int_0^{\tau} \sum_{g \in \{0 , 1\}}  \hat{X}^g(s,\tau) g_1(s,g) ds  \\
&
\label{eq_diff:4}
+ \sum_{g \in \{0 , 1\}}  
p_{3j}(\tau,t) 
 \frac{\partial}{\partial \tau} \int_0^{\tau}  \hat{X}^g(s,\tau) g_1(s,g) ds  \\
&
\label{eq_diff:5}
+
\frac{\partial}{\partial \tau}   f(\tau)  \int_{\tau}^t \sum_{g \in \mathbb{F}} 
p_{gj}(s,t) \hat{X}^g(s,\tau) g_1^+(s,g) ds \\
&
\label{eq_diff:6}
+ f(\tau)  \frac{\partial}{\partial \tau} \int_{\tau}^t \sum_{g \in \mathbb{F}} 
p_{gj}(s,t) \hat{X}^g(s,\tau) g_1^+(s,g) ds
\end{align}
Term by term, using Kolmogorovs forward and backward differential equations as well as Leibniz integral rule, we get
\begin{itemize}
\item[\eqref{eq_diff:1}] Using Kolmogorov \eqref{eq_diff:1} simplifies to
\begin{gather*}
\frac{\partial}{\partial t}p_{3j}(\tau,t) \int_0^{\tau} \sum_{g \in \{0 , 1\}} \hat{X}^g(s,\tau) g_1(s,g) ds = \\
\left( \sum_{k\neq 3} p_{3k}(\tau,t)\mu_{kj}(t)- p_{3j}(\tau,t)\mu_{jk}(t) \right)
\int_0^{\tau} \sum_{g \in \{0 , 1\}} \hat{X}^g(s,\tau) g_1(s,g) ds
\end{gather*}
\item[\eqref{eq_diff:2}] Leibniz and Kolmogorov
\begin{gather*}
\frac{\partial}{\partial t} \int_{\tau}^t \sum_{g \in \mathbb{F}} 
p_{gj}(s,t) \hat{X}^g(s,\tau) g_1^+(s,g)  ds
=
\\
\sum_{g \in \mathbb{F}} 
p_{gj}(t,t) \hat{X}^g(t,\tau) g_1^+(t,g) 
+
\int_{\tau}^t \sum_{g \in \mathbb{F}} 
\frac{\partial}{\partial t}  p_{gj}(s,t) \hat{X}^g(s,\tau) g_1^+(s,g) ds
=
\\
\hat{X}^j(t,\tau) g_1^+(t,j)  
+
\int_{\tau}^t \sum_{g \in \mathbb{F}} 
\left(\sum_{k\neq g} p_{gk}(s,t)\mu_{kj}(t)- p_{gj}(s,t)\mu_{jk}(t)\right) \hat{X}^g(s,\tau) g_1^+(s,g) ds,
\end{gather*}
using that
$$
\frac{\partial}{\partial t}  p_{gj}(s,t)= \sum_{k\neq g} p_{gk}(s,t)\mu_{kj}(t)- p_{gj}(s,t)\mu_{jk}(t)
$$
\item[\eqref{eq_diff:3}] Kolmogorov backward
\begin{gather*}
\frac{\partial}{\partial \tau}  p_{3j}(\tau,t) 
\int_0^{\tau}  \sum_{g \in \{0 , 1\}} \hat{X}^g(s,\tau) g_1(s,g) ds = \\
\left( \sum_{k\neq 3} \mu_{3k}(t)p_{3j}(\tau,t) - \mu_{3k}(t) p_{kj}(\tau,t) \right)
\int_0^{\tau}  \sum_{g \in \{0 , 1\}}   \hat{X}^g(s,\tau) g_1(s,g) ds ,
\end{gather*}
using that
$$
\frac{\partial}{\partial \tau}  p_{3j}(\tau,t) =\sum_{k\neq 3} \mu_{3k}(t)p_{3j}(\tau,t) - \mu_{3k}(t) p_{kj}(\tau,t)
$$
\item[\eqref{eq_diff:4}] Leibniz
\begin{gather*}
p_{3j}(\tau,t) \frac{\partial}{\partial \tau}\int_0^{\tau}  \sum_{g \in \{0 , 1\}} \hat{X}^g(s,\tau) g_1(s,g) ds = \\
p_{3j}(\tau,t)  \sum_{g \in \{0 , 1\}}   \hat{X}^g(\tau,\tau) g_1(\tau,g) 
+
p_{3j}(\tau,t)  \int_0^{\tau}  \sum_{g \in \{0 , 1\}}  \frac{\partial}{\partial \tau} \hat{X}^g(s,\tau) g_1(s,g) ds
\end{gather*}
\item[\eqref{eq_diff:5}] as we have not yet defined $f$, \eqref{eq_diff:5} cannot be further simplified.
\item[\eqref{eq_diff:6}] Leibniz integral rule
\begin{gather*}
f(\tau)  \frac{\partial}{\partial \tau} \int_{\tau}^t \sum_{g \in \mathbb{F}} 
p_{gj}(s,t) \hat{X}^g(s,\tau) g_1^+(s,g) ds =
\\
f(\tau)  \int_{\tau}^t \sum_{g \in \mathbb{F}} 
p_{gj}(s,t)  \frac{\partial}{\partial \tau} \hat{X}^g(s,\tau) g_1^+(s,g) ds
-
f(\tau) \sum_{g \in \mathbb{F}} 
p_{gj}(\tau,t)   \hat{X}^g(\tau,\tau) g_1^+(\tau,g) 
\end{gather*}
\end{itemize}
Combining the simplified versions of \eqref{eq_diff:1}-\eqref{eq_diff:6}
\begin{align*}
&\frac{\partial}{\partial t}\hat{X}^j(t,\tau)+ \frac{\partial}{\partial \tau}\hat{X}^j(t,\tau)
\\
&=
\left( \sum_{k\neq 3} p_{3k}(\tau,t)\mu_{kj}(t)- p_{3j}(\tau,t)\mu_{jk}(t) \right)
\int_0^{\tau} \sum_{g \in \{0 , 1\}} \hat{X}^g(s,\tau) g_1(s,g) ds
\\
& \quad +
\hat{X}^j(t,\tau) g_1^+(t,j)  
+
\int_{\tau}^t \sum_{g \in \mathbb{F}} 
\left(\sum_{k\neq g} p_{gk}(s,t)\mu_{kj}(t)- p_{gj}(s,t)\mu_{jk}(t)\right) \hat{X}^g(s,\tau) g_1^+(s,g) ds
\\
&\quad +
\left( \sum_{k\neq 3} \mu_{3k}(t)p_{3j}(\tau,t) - \mu_{3k}(t) p_{kj}(\tau,t) \right)
\int_0^{\tau}  \sum_{g \in \{0 , 1\}}   \hat{X}^g(s,\tau) g_1(s,g) ds
\\
&\quad +
p_{3j}(\tau,t)  \sum_{g \in \{0 , 1\}}   \hat{X}^g(\tau,\tau) g_1(\tau,g) 
+
p_{3j}(\tau,t)    \int_0^{\tau} \sum_{g \in \{0 , 1\}} \frac{\partial}{\partial \tau} \hat{X}^g(s,\tau) g_1(s,g) ds
\\
&\quad +
\frac{\partial}{\partial \tau}   f(\tau)  \int_{\tau}^t \sum_{g \in \mathbb{F}} 
p_{gj}(s,t) \hat{X}^g(s,\tau) g_1^+(s,g) ds
\\
&\quad +
f(\tau)  \int_{\tau}^t \sum_{g \in \mathbb{F}} 
p_{gj}(s,t)  \frac{\partial}{\partial \tau} \hat{X}^g(s,\tau) g_1^+(s,g) ds
-
f(\tau) \sum_{g \in \mathbb{F}} 
p_{gj}(\tau,t)   \hat{X}^g(\tau,\tau) g_1^+(\tau,g) 
\end{align*}
We now intend to prove that this differential equation is identical to the one achieved by differentiating
$$
\frac{X^{j+}(t)p_{3j}^+(\tau,t)}{p_{3j}^+(\tau,t)+p_{3j}^0(\tau,t)}=X^{j+}(t)f(\tau)
$$
where $X^{j+}(t)$ is the value of the reserve in the lost-nothing state $j$. Can it be done? - Probably not!
\newpage

% NEDENSTÅENDE compiles ikke!
\iffalse
Let the dynamics of $X$ be given by
\begin{align*}
dX(s)=&X(s)g_1(s,Z(s)) ds + g_s(s,Z(s)) ds 
\\
& + \sum_{h \neq Z(s-)} \big( X(s) h_1(s,Z(s-),h)+h_2(s,Z(s-),h) \big) dN^h(s)
\\
&+ \indic{Z(s) \in \mathbb{F} } f(s-U(s))\big(  X(s) g_3(s,Z(s)) ds + g_4(s,Z(s)) ds \big)
\\
& +  \indic{Z(s) \in \mathbb{F} } f(s-U(s)) \left( \sum_{h \neq Z(s-)} \big( X(s) h_3(s,Z(s-),h)+h_4(s,Z(s-),h) \big) dN^h(s) \right)
\end{align*}
allowing for dynamics of $X$ that are scaled upon transition to free policy, as well as non-scaled free policy dynamics, and any combination of the two. Let us now derive an integral equation for $\hat{X}^j(t,\tau)$ by methods similar to the case without duration dependence.
\begin{align*}
\hat{X}^j(t,\tau)=& \E_{Z(0)}[ \indic{Z(t)=j}X(t)|t-U(t)=\tau] \\
=& \int_0^t \E_{Z(0)}[ \indic{Z(t)=j} dX(s)|t-U(t)=\tau] \\
=& \int_0^t \E_{Z(0)} \left[ \sum_{g \in \mathcal{J}} \indic{Z(s-)=g} \E [ \indic{Z(t)=j} dX(s)|Z(s-)=g, t-U(t)=\tau]  \bigg| t-U(t)=\tau \right].
\end{align*}
To shorten notation define $\mathbb{G}_{g,\tau}= \sigma (Z(s-)=g, t-U(t)=\tau)$. Consider now the innermost expectation
\begin{align*}
& \E_{Z(0)} [  \indic{Z(t)=j} dX(s)|\mathbb{G}_{g,\tau}]
\\
=
&\E_{Z(0)} \Bigg[  \indic{Z(t)=j} \Bigg\lbrace
 X(s)g_1(s,Z(s)) ds + g_s(s,Z(s)) ds 
\\
& + \sum_{h \neq Z(s-)} \big( X(s) h_1(s,Z(s-),h)+h_2(s,Z(s-),h) \big) dN^h(s)
\\
&+ \indic{Z(s) \in \mathbb{F} } f(s-U(s))\big(  X(s) g_3(s,Z(s)) ds + g_4(s,Z(s)) ds \big)
\\
& +  \indic{Z(s) \in \mathbb{F} } f(s-U(s)) \left( \sum_{h \neq Z(s-)} \big( X(s) h_3(s,Z(s-),h)+h_4(s,Z(s-),h) \big) dN^h(s) \right) \Bigg\rbrace  \bigg| \mathbb{G}_{g,\tau} \Bigg] \\
= 
&\E_{Z(0)} [  \indic{Z(t)=j}   X(s)g_1(s,Z(s)) ds  | \mathbb{G}_{g,\tau}  ] \\
&+\E_{Z(0)} [  \indic{Z(t)=j}  g_s(s,Z(s)) ds  | \mathbb{G}_{g,\tau}  ] \\
&+\E_{Z(0)} [  \indic{Z(t)=j} \left( \sum_{h \neq Z(s-)}  X(s) h_1(s,Z(s-),h) dN^h(s) \right) | \mathbb{G}_{g,\tau}  ] \\
&+ \E_{Z(0)} [  \indic{Z(t)=j} \left( \sum_{h \neq Z(s-)} h_2(s,Z(s-),h)  dN^h(s) \right) | \mathbb{G}_{g,\tau}  ] \\
&+ \E_{Z(0)} [  \indic{Z(t)=j} \left(\indic{Z(s-) \in \mathbb{F} } f(s-U(s)) X(s) g_3(s,Z(s)) ds  \right) | \mathbb{G}_{g,\tau}  ] \\
&+ \E_{Z(0)} [  \indic{Z(t)=j} \left(\indic{Z(s-) \in \mathbb{F} } f(s-U(s)) g_4(s,Z(s)) ds \big) \right) | \mathbb{G}_{g,\tau}  ] \\
&+ \E_{Z(0)} [  \indic{Z(t)=j} \left(\indic{Z(s-) \in \mathbb{F} } f(s-U(s)) \left( \sum_{h \neq Z(s-)}  X(s) h_3(s,Z(s-),h) dN^h(s) \right) \right) | \mathbb{G}_{g,\tau}  ] \\
&+ \E_{Z(0)} [  \indic{Z(t)=j} \left(\indic{Z(s-) \in \mathbb{F} } f(s-U(s)) \left( \sum_{h \neq Z(s-)} h_4(s,Z(s-),h)  dN^h(s) \right) \right) | \mathbb{G}_{g,\tau}  ].
\end{align*}
These terms can be calculated in the same manner using the following steps
\begin{itemize}
\item Take $ \mathbb{G}_{g,\tau}$-measurable quantities outside the expectation 
\begin{itemize}
\item $f(s-U(s))$, using that $f$ is a deterministic function.
\item $\indic{Z(s-) \in \mathbb{F} }$
\item $g$ and $h$ functions that depend on $Z(s-)$
\end{itemize}
\item Use independence between $X(s-)|\mathbb{G}_{g,\tau}$ and $\indic{Z(t)=j} dN^h(s)|\mathbb{G}_{g,\tau}$, to separate expectations concerning the state and the value of $X(s)$
\item For $\tau<s$, corresponding to $g\in \mathbb{F}$, note that $s-U(s)=t-U(t)=\tau$ and use \eqref{eq:1} to see that
\begin{align*}
\E_{Z(0)} [X(s)|Z(s-)=g, t-U(t)=\tau] =& \frac{\E_{Z(0)}[X(s) \indic{Z(s)=g} | s-U(s)=\tau]}{P(Z(s)=g|Z(0),s-U(s)=\tau)}
\\
=&
\frac{\hat{X}^g(s,\tau)}{p_{3,g}(\tau,s)}
\end{align*}
\item For $s<\tau$, corresponding to $g \notin \mathbb{F}$, note that $s-U(s)=t-U(t)=\tau$ and use \eqref{eq:1} to see that
\begin{align*}
\E_{Z(0)} [X(s)|Z(s-)=g, t-U(t)=\tau] =& \frac{\E_{Z(0)}[X(s) \indic{Z(s)=g} | s-U(s)=\tau]}{P(Z(s)=g|Z(0),s-U(s)=\tau)}
\\
=&
\frac{\hat{X}^g(s,\tau)}{p_{0g|00}(0,s|0,\tau)}
\\
=&
\frac{\hat{X}^g(s,\tau) p_{0,0}(0,\tau)}{p_{0,g}(0,s)p_{g,0}(s,\tau)}
\end{align*}
\item For $\tau<s$ corresponding to $g\in \mathbb{F}$, note that $s-U(s)=t-U(t)=\tau$ to see
\begin{align*}
P( Z(t)=j|Z(0),Z(s-)=g, t-U(t)=\tau) =&\frac{p_{00}(0,\tau)\mu_{03}(\tau) p_{3g}(\tau,s)p_{gj}(s,t)}{p_{00}(0,\tau)\mu_{03}(\tau) p_{3g}(\tau,s)}
\\
=&
p_{gj}(s,t)
\end{align*}
\item For $s<\tau$ corresponding to $g\notin \mathbb{F}$, note that $s-U(s)=t-U(t)=\tau$ to see
\begin{align*}
P( Z(t)=j|Z(0),Z(s-)=g, t-U(t)=\tau) =&\frac{p_{0g}(0,s) p_{g0}(s,\tau ) \mu_{03}(\tau) p_{3j}(\tau,t)}{p_{0g}(0,s) p_{g0}(s,\tau ) \mu_{03}(\tau)}
\\
=&
p_{3j}(\tau,t)
\end{align*}
\end{itemize}
\fi
Thoughts
\begin{itemize}
\item Reason to hope: under the technical basis $\tilde{X}^j(t)=V_1^{j*}(t)$ and similarly $\hat{X}^j(t,\tau)=f(\tau)V_1^{Z(t)*}(t)$ - can we keep track of the difference between the technical and market basis?
\item Use lumping to prove that lost-all state works if and only if $\tilde{X}^j(t,\tau)= \tilde{X}^{j+}(t)f(\tau)$
\item We do not have any sum at risk on transition to free policy as the reserve defines the benefits, and the benefits do not define the reserve.
\item Use Fission/anti-lumping to find lost-all intensity(ies). Perhaps there needs to be additional transitions to lost-all states from the free policy states. Instead of indifferent cashflows, prove how we should find lumped intensities and payements such that the state-wise differential equations are identical.
\item As there is no reserve jump on transition to the free policy states, due to the way excess reserve (or lack thereof) is spent on $B_2$, there is no free policy sum at risk, and we can thus define the free policy factor however we want. How we choose to define the free policy factor effects the cashflow, as it determines the balance between $B_1$ and $B_2$. Below we list some free policy factor suggestions.
\begin{itemize}
\item If $B_1^+=B_2^+$ or $B_1^+=0$, the free policy factor does not matter. There is no duration dependence. The benefits in the free policy states will be $B_2^+(t)\frac{X(t)}{V_2^{+*}(t)}$ i.e. the entire reserve is spent on buying $B_2$ benefits. If we force $B_1^+=B_2^+$ or $B_1^+=0$, we should take the guarantees of the contract into account. It might happen that $X(t)<V_2^{+*}(t)$, implying that the insured will receive less that agreed upon under the technical basis. In case of any guarantees, we ought to use the benefits given by $B_2\frac{\max \{ X(t),V_2^{+*}(t)\}}{V_2^{+*}(t)}$.
\item Use the standard definition $f(t)=\frac{V_1^*(t)}{V_1^{+*}(t)}$. This definition is desirable in especially two regards; it is deterministic and contractually fair under the technical basis. This corresponds to buying $f(\tau)B_1(t)$, and spending the rest on $B_2$.
\item It might be more desirable to increase $B_1$ as much as possible, and not spend reserve on buying $B_2$, corresponding to $f(\tau)=1$. If we do this, we should ensure that $B_2^+=B_1^+$, such that the decrease in $B_1^+$ is linear. In this case the free policy benefits are given by $B_1^+(t)+\frac{X(t)-V_1^{+*}(t)}{V_1^{+*}(t)}B_1^+(t)=B_1^+(t)\frac{X(t)}{V_1^{+*}}$. 
\item As an extension to the above: if indeed $X(\tau)\geq V_1^{+*}(\tau)$, we should spend the remainder on buying $B_2$, corresponding to $f(\tau)=\max \{ 1, X(t)/V_1^{+*}(t) \}$ and $\tilde{B}_2^+(t)=\indic{ X(t)/V_1^{+*}(t) \geq 1} B_2^+(t)+\indic{ X(t)/V_1^{+*}(t)<1} B_1^+(t)$.
\end{itemize}
\item To improve the truthfulness of the model, we should include guarantees. Guarantees are the real reason why there is a free policy sum at risk, at thus also the reason for duration dependence.
\end{itemize}



\subsection*{Market value of guaranteed benefits}
Note that for any deterministic function $\phi$,
\begin{align*}
\E_{Z(0)} \left[  \phi(s,Z(s)) X(s) \right] =&
\sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s) \phi(s,j) \E_{Z(0)}[  X(s) |Z(s)=j] 
\\
=&
\sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s) \phi(s,j) \frac{\E_{Z(0)}[  X(s) \indic{Z(s)=j} ]}{p_{Z(0)j}(0,s)}
\\
=&
\sum_{j \in \mathcal{J}}  \phi(s,j) \tilde{X}^j(s).
\end{align*}
What is appealing about this formula, is that it does not include any probabilities - they are hidden in $\tilde{X}$. Assuming that $X(s)$ is independent of the future expected interest, we can calculate the market value of future guaranteed benefits (GY) as
\begin{align*}
&\E_{Z(0)} \left[ \int_t^n e^{-\int_t^s r} \left( dB_1(s)+ \frac{X(s)-V_1^{Z(s)*}(s)}{V_2^{Z(s)*}(s)}dB_2(s) \right) \right]
\\
&=
\int_t^n e^{-\int_t^s f(t,\tau)} \E_{Z(0)}[ dB_1(s)] 
+
\int_t^n e^{-\int_t^s f(t,\tau)} \sum_{j \in \mathcal{J}} \frac{\tilde{X}^j(s)}{V_2^{j*}(s)} \E[B_2(s)| Z(s)=j]ds  
\\
& -
\int_t^n e^{-\int_t^s f(t,\tau)} \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s)\frac{V_1^{j*}(s)}{V_2^{j*}(s)} \E[B_2(s)| Z(s)=j]ds
\\
&=
\int_t^n e^{-\int_t^s f(t,\tau)} \sum_{j \in \mathcal{J}} \frac{\tilde{X}^j}{V_2^{j*}(s)} \E[B_2(s)| Z(s)=j]ds  
\\
& +
\int_t^n e^{-\int_t^s f(t,\tau)} \sum_{j \in \mathcal{J}} p_{Z(0)j}(0,s)\left( \E[B_1(s)| Z(s)=j]-\frac{V_1^{j*}(s)}{V_2^{j*}(s)} \E[B_2(s)| Z(s)=j]  \right)ds
\end{align*}
which can be calculated when $\tilde{X}$ is available for $s \in (0,n]$. However, if the FMA's depend on GY, $\tilde{X}$ is also going to depend on GY which is problematic, as $\tilde{X}$ is defined retrospectively and GY is defined prospectively. To deal with this, an iterative procedure is necessary.

\subsection*{Market-dependent intensities}
Consider now the case of market-dependent intensities. We restrict ourselves to intensities that depend only on current values of surplus, reserve and financial market. In other words $(Z(t),X(t),Y(t))$ is assumed to be markovian. The only difference to the previous derivation regards $E_{Z(0)}[\indic{Z(t)=j}X(s)|Z(s-)=g]$ and $E_{Z(0)}[\indic{Z(t)=j}X(s)dN^h(s)|Z(s-)=g]$. We use the tower-property once more
\begin{align*}
&\E_{Z(0)}[\indic{Z(t)=j}X(s-)|Z(s-)=g]
\\
=&
\E_{Z(0)} \big[ \E_{Z(0)}[\indic{Z(t)=j}X(s-)|Z(s-)=g, \lbrace X(\tau) \rbrace_{s\leq \tau \leq t}] \big| Z(s-)=g \big]
\\
=&
\E_{Z(0)} \big[ X(s-) \E_{Z(0)}[\indic{Z(t)=j}|Z(s-)=g, \lbrace X(\tau) \rbrace_{s\leq \tau \leq t}] \big| Z(s-)=g \big]
\end{align*}
Is it true that 
$$
X(s-)|Z(s-) \independent \E_{Z(0)}[\indic{Z(t)=j}|Z(s-)=g, \lbrace X(\tau) \rbrace_{s\leq \tau \leq t}] \big| Z(s-)?
$$
If so, define
$$
\tilde{p}_{g,j}(s,t):=\E_{Z(0)} \big[ \E_{Z(0)}[\indic{Z(t)=j}|Z(s-)=g, \lbrace X(\tau) \rbrace_{s\leq \tau \leq t}] \big| Z(s-)=g \big]
$$
being the expected probability of a transition from $g$ to $j$ in $[s,t]$. What about $p_{0g}(0,s)$ should it not also depend on past values of $X$?


\iffalse
\newpage
\topskip0pt
\vspace*{\fill}
\def\PlA{(0,0)}
\def\PlB{(4,-7)}
\def\PlD{(0,-14)}
\begin{center}
\begin{tikzpicture}
\begin{scope}[every node/.style={rectangle,thick,draw,minimum width=1cm,minimum height = 1cm}]
    \node (0) at \PlA {0};
    \node (1) at ($(0) + (6,0)$) {1};
    \node (2) at (3,-2.5) {2};
    \node (4) at \PlB {3};
    \node (5) at ($(4) + (6,0)$)   {4};
    \node (6) at ($(4) + (3,-2.5)$){5};
    \node (7) at \PlD {3'};
    \node (8) at ($(7) + (6,0)$)   {4'};
    \node (9) at ($(7) + (3,-2.5)$){5'};
    \node (3) at ($(0)!0.5!(7)$)   {6};
\end{scope}

\begin{scope}[>={Stealth[black]},
              every node/.style={fill=white,circle,scale=0.9},
              every edge/.style={draw=black,very thick}]
    \path [->] 	(0) edge [bend left=16] node {$\mu^{01}$} (1)
    		   	(1) edge [bend left=16] node {$\mu^{10}$} (0)
    			(0) edge node {$\mu^{02}$} (2)
    			(1) edge node {$\mu^{12}$} (2)
    			(0) edge node {$\mu^{06}$} (3)
				(0) edge [bend right=16] node {$\tilde{\mu}^{03}$} (4)
				(4) edge node {$\mu^{36}$} (3)
				(4) edge [bend left=16] node {$\mu^{34}$} (5)
				(5) edge [bend left=16] node {$\mu^{43}$} (4)
				(4) edge node {$\mu^{35}$} (6)
				(5) edge node {$\mu^{45}$} (6)
				(7) edge node {$\mu^{36}$} (3)
				(0) edge [bend right=45] node {$\mu^{03'}$} (7)
				(7) edge [bend left=16] node {$\mu^{34}$} (8)
				(8) edge [bend left=16] node {$\mu^{43}$} (7)
				(7) edge node {$\mu^{35}$} (9)
				(8) edge node {$\mu^{45}$} (9);
\end{scope}

\draw [rounded corners=20mm,thick,dotted,scale=1]
($(0)+(-2.2,0.9)$)--
($(1)+(2.2,0.9)$)--
($(2)+(0,-1.8)$)
--cycle;

\draw[rounded corners=5 mm, thick,dotted]
	($(3.north west)+(-0.5,0.6)$)
rectangle 
	($(3.south east)+(0.5,-0.6)$);

\draw [rounded corners=20mm,thick,dotted,scale=1]
($(4)+(-2.2,0.9)$)--
($(5)+(2.2,0.9)$)--
($(6)+(0,-1.8)$)
--cycle;

\draw [rounded corners=20mm,thick,dotted,scale=1]
($(7)+(-2.2,0.9)$)--
($(8)+(2.2,0.9)$)--
($(9)+(0,-1.8)$)
--cycle;

\node[text width=1cm] at ($([xshift=1.5cm]1.north east)!0.5!([xshift=1.5cm]1.south east)$)  {\Huge{A}};
\node[text width=1cm] at ($([xshift=1.5cm]5.north east)!0.5!([xshift=1.5cm]5.south east)$)  {\Huge{B}};
\node[text width=1cm] at ($([xshift=1.5cm]8.north east)!0.5!([xshift=1.5cm]8.south east)$)  {\Huge{D}};
\node[text width=1cm] at ($([xshift=-0.9cm]3.west)$)  {\Huge{C}};
\end{tikzpicture}
\end{center}
\vspace*{\fill}

\newpage
\def\PlA{(0,0)}
\def\PlB{(3,-6)}
\def\PlD{(3,-12)}
\begin{center}
\begin{tikzpicture}
\begin{scope}[every node/.style={rectangle,thick,draw,minimum width=1cm,minimum height = 1cm}]
    \node (0) at \PlA {0};
    \node (1) at ($(0) + (6,0)$) {1};
    \node (2) at (3,-2.5) {2};
    \node (4) at \PlB {3};
    \node (5) at ($(4) + (6,0)$)   {4};
    \node (6) at ($(4) + (3,-2.5)$){5};
    \node (7) at \PlD {3'};
    \node (8) at ($(7) + (6,0)$)   {4'};
    \node (9) at ($(7) + (3,-2.5)$){5'};
    \node (3) at ($(7)+(-4,-2.5)$)   {6};
\end{scope}

\begin{scope}[>={Stealth[black]},
              every node/.style={fill=white,circle,scale=0.9},
              every edge/.style={draw=black,very thick}]
    \path [->] 	(0) edge [bend left=16] node {$\mu^{01}$} (1)
    		   	(1) edge [bend left=16] node {$\mu^{10}$} (0)
    			(0) edge node {$\mu^{02}$} (2)
    			(1) edge node {$\mu^{12}$} (2)
				(4) edge [bend left=16] node {$\mu^{34}$} (5)
				(5) edge [bend left=16] node {$\mu^{43}$} (4)
				(4) edge node {$\mu^{35}$} (6)
				(5) edge node {$\mu^{45}$} (6)
				(7) edge [bend left=16] node {$\mu^{34}$} (8)
				(8) edge [bend left=16] node {$\mu^{43}$} (7)
				(7) edge node {$\mu^{35}$} (9)
				(8) edge node {$\mu^{45}$} (9)
				(0) edge [bend right=16] node {$\mu^{06}$} (3)
				(0) edge [bend right=10] node {$\mu^{03}$} (4)
				(0) edge [bend right=16] node {$\mu^{03'}$} (7)
				(4) edge [bend right=0] node [pos=0.18] {$\mu^{36}$} (3)
				(7) edge [bend right=0] node {$\mu^{36}$} (3);
\end{scope}

\draw [rounded corners=20mm,thick,dotted,scale=1]
($(0)+(-2.2,0.9)$)--
($(1)+(2.2,0.9)$)--
($(2)+(0,-1.8)$)
--cycle;

\draw[rounded corners=5 mm, thick,dotted]
	($(3.north west)+(-0.5,0.6)$)
rectangle 
	($(3.south east)+(0.5,-0.6)$);

\draw [rounded corners=20mm,thick,dotted,scale=1]
($(4)+(-2.2,0.9)$)--
($(5)+(2.2,0.9)$)--
($(6)+(0,-1.8)$)
--cycle;

\draw [rounded corners=20mm,thick,dotted,scale=1]
($(7)+(-2.2,0.9)$)--
($(8)+(2.2,0.9)$)--
($(9)+(0,-1.8)$)
--cycle;

\node[text width=1cm] at ($([xshift=1.5cm]1.north east)!0.5!([xshift=1.5cm]1.south east)$)  {\Huge{A}};
\node[text width=1cm] at ($([xshift=1.5cm]5.north east)!0.5!([xshift=1.5cm]5.south east)$)  {\Huge{B}};
\node[text width=1cm] at ($([xshift=1.5cm]8.north east)!0.5!([xshift=1.5cm]8.south east)$)  {\Huge{D}};
\node[text width=1cm] at ($([xshift=-0.9cm]3.west)$)  {\Huge{C}};
\end{tikzpicture}
\end{center}
\fi
\newpage 
\subsection*{What about surplus?}
By defining $\tilde{X}^j$ as the vector
$$
\tilde{X}^j(t)=\E_{Z(0)}
\left[ 
\begin{pmatrix}
X(t)\indic{Z(t)=j}
\\
Y(t)\indic{Z(t)=j}
\end{pmatrix}
\right],
$$
we get a differential equation for the state-wise reserves and state-wise surplus. However, as the surplus is shared among the policyholders, we have to solve a system of $(\#\mathcal{J})^{N}$ differential equations, when considering $N$ policies - one for each possible combination of policy states. Due to limitations on computational power, we would rather have a system of at most $\# \mathcal{J} \times N$ differential equations - corresponding to the case where $Y(t)$ is independent of the state of the policies. One case for which we indeed can suffice with $\# \mathcal{J} \times N$ differential equations, is the case where dividends and contributions are independent of the state of the policy, which is unrealistic, but achievable through lumping.\\
Another way to diminish the problem of dependency between policyholders, is to discretisize the dividend function and comprise it as lump-sum payments, which conforms to real-world practise. When there are no dividends, the reserve dynamics are independent of surplus, and thus also the other policies. In between lump-sum payments of dividend, the state-wise contributions including investment gains from each policy is accumulated. When a lump-sum time is reached, the probability weighted sum of contributions are contributed to a single state-independent surplus where after the dividend is allocated. This method requires $(\# \mathcal{J})\times 2 \times N$ differential equations be solved. For each policy and state of the policy we need a differential equation for the reserve and contributions. However, in between lump-sum payments of dividend, the policies are independent, allowing for parallelization across $N$ cores. Even though $(\# \mathcal{J})\times 2 \times N$ independent differential equations is a vast improvement from $(\# \mathcal{J})^N$ dependent differential equations, it is still a computationally difficult problem. The following section is dedicated to discuss further improvements in calculation time. It is important to realize that in terms of computing, there is a trade-off between precision and time, when the code has been optimized in all other aspects. The problems regarding "all other aspects", such as memory allocation and parallelization, are left to the data scientists and herein assumed optimized.
\\[12pt]
\subsection*{Model points and groups of policies}
The motivation for \citet{Norberg} to consider the retrospective reserve, was to explain the dynamics of a group of policyholders. 
\begin{quote}
Even though the retrospective individual reserve in (2.5) is observable by time $t$, it may be judged relevant to calculate retrospective reserves with respect to some more summary information \textbf{F}. For a given realization of [interest]..., $\mathcal{F}_t$ may be thought of as a classification of the policies, whereby all policies with the same characteristics as specified by $\mathcal{F}_t$ are grouped together. Forming the mean, conditional on $\mathcal{F}_t$, means averaging over all policies in the same group, roughly speaking. \newline $\sim$ \citet{Norberg}
\end{quote}
Our motivation is different. We want a forward differential equation to describe the state-wise reserves, as we are given the current retrospective reserve. If we found the market-value prospective reserve, we would not necessarily have that $X(0)=V^+(0)$, as there is a difference between expected reserve dependence of benefits and actual reserve dependence of benefits. Furthermore, business logic needs to be accounted for, and these rules are defined forwards in time - some rules may not be bijective, implying that the backwards-in-time business rules are not unique. Different as our motivation may be, we can use the idea of grouping policies to decrease computation time. Grouping policies may also come at a low cost of precision, if the policies are similar. The gain in computational efficiency from grouping policies in bundles of 7, is equivalent to considering a model with only one state. The biggest - and perhaps only - difficulty in respect to grouping policies, is to define a metric by which policies can be compared such that the grouping-error is minimized. Plenty of characteristics to measure differences pop into mind; are they roughly the same age? Are they in the same state? Are their benefits similar? However, it might also make sense to group vastly different policies as long as their expected cashflows are similar. Maybe it is, counter intuitively, an advantage to include a contrasting policy, to adjust the cashflow such that the error for the group is decreased. In any case, it is difficult to account for all the differences in the policies and how they interact when the policies are grouped. Therefore it makes sense to ask the question the other way around: If I want to reduce my calculation time by a factor 10, how should I group the policies to minimize the error? This requires that we can calculate the error from grouping policies, which may not be possible without actually calculating the reserves for all possible groups of policies.\\
We present some ideas to grouping policies.
\begin{itemize}
\item In general: define a policy space equipped with a metric. Group policies according to the metric.
\item Define buckets based on information available today, and group policies according to these buckets.
\item Group two groups if the integrated absolute difference of scaled expected cashflows, is smaller than some threshold. The scaling factor should ensure that the grouping is independent of benefit (and reserve) size, and could for instance be $V(0)^{-1}$. Note that a single policy can be a group. This method is sensitive to the order in which groups are grouped.
\item Use a machine-learning algorithm to decide if two policies are similar or not. Based on the interconnections of similar policies, groups can be constructed by minimizing the number similar policies that are not grouped. This requires training that may be company-specific.
\end{itemize}
Define the error for group $G$ at time $t$ as
\begin{align*}
\varepsilon_G(t):=\left| \sum_{j \in \mathcal{J}} \tilde{X}^j_G(t) - \sum_{i \in \mathcal{I}} \tilde{X}^j_i(t) \right|
\end{align*}
where $\tilde{X}^j_i(t)$ are the state-wise policy reserves as defined previously, and $\tilde{X}^j_G$ are the sate-wise group reserves.


\newpage
\bibliographystyle{plainnat}
\bibliography{BIBS}

\end{document}
